<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Ahana Hillside</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-stone: #6B6560;
            --color-forest: #2C3E2D;
            --color-cream: #F5F5F3;
            --color-charcoal: #2D2D2D;
            --color-light-stone: #DDDBD8;
            --color-success: #3D7A3D;
            --color-error: #B93E3E;

            --font-serif: 'Cormorant Garamond', Georgia, serif;
            --font-sans: 'DM Sans', -apple-system, sans-serif;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-cream);
            color: var(--color-charcoal);
            line-height: 1.65;
            font-size: 15px;
            min-height: 100vh;
        }

        /* Login screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 3rem 2.5rem;
            max-width: 380px;
            width: 100%;
            text-align: center;
        }

        .login-card h1 {
            font-family: var(--font-serif);
            font-size: 1.6rem;
            font-weight: 500;
            color: var(--color-forest);
            margin-bottom: 0.25rem;
        }

        .login-card .subtitle {
            font-size: 0.85rem;
            color: var(--color-stone);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 2rem;
        }

        .login-card input {
            width: 100%;
            padding: 0.7rem 0.85rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 16px;
            color: var(--color-charcoal);
            outline: none;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .login-card input:focus { border-color: var(--color-forest); }

        .login-error {
            display: none;
            font-size: 0.8rem;
            color: var(--color-error);
            margin-bottom: 1rem;
        }

        .login-error.show { display: block; }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.show { display: flex; min-height: 100vh; }

        /* --- Sidebar --- */
        .sidebar {
            width: 240px;
            min-width: 240px;
            background: var(--color-forest);
            color: var(--color-cream);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem 1.25rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-family: var(--font-serif);
            font-size: 1.2rem;
            font-weight: 500;
            color: #fff;
            line-height: 1.3;
        }

        .sidebar-header .sidebar-sub {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(255,255,255,0.45);
            margin-top: 0.2rem;
        }

        .sidebar-nav {
            flex: 1;
            padding: 0.75rem 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            width: 100%;
            padding: 0.7rem 1.25rem;
            background: none;
            border: none;
            font-family: var(--font-sans);
            font-size: 0.85rem;
            font-weight: 400;
            color: rgba(255,255,255,0.65);
            cursor: pointer;
            text-align: left;
            transition: background 0.15s, color 0.15s;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.07);
            color: #fff;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.12);
            color: #fff;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #fff;
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            opacity: 0.7;
        }

        .nav-item.active svg { opacity: 1; }

        .nav-badge {
            display: none;
            font-size: 0.6rem;
            font-weight: 600;
            background: var(--color-error);
            color: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            margin-left: auto;
        }

        .nav-badge.show { display: inline-block; }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-footer .logout-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-family: var(--font-sans);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.4rem 0;
            transition: color 0.2s;
        }

        .sidebar-footer .logout-btn:hover { color: #fff; }

        .sidebar-footer .logout-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Mobile sidebar toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 0.75rem;
            left: 0.75rem;
            z-index: 200;
            width: 42px;
            height: 42px;
            background: var(--color-forest);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-toggle span {
            display: block;
            width: 18px;
            height: 2px;
            background: #fff;
            transition: transform 0.3s, opacity 0.3s;
        }

        .sidebar-toggle.open span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
        .sidebar-toggle.open span:nth-child(2) { opacity: 0; }
        .sidebar-toggle.open span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 90;
        }

        .sidebar-overlay.show { display: block; }

        /* --- Main content area --- */
        .main-content {
            flex: 1;
            margin-left: 240px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            background: #fff;
            border-bottom: 1px solid var(--color-light-stone);
            padding: 1.1rem 2.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .main-header-title {
            font-family: var(--font-serif);
            font-size: 1.35rem;
            font-weight: 500;
            color: var(--color-forest);
        }

        /* Sub-tabs (inside Campsites) */
        .sub-tabs {
            display: none;
            padding: 0 2.5rem;
            background: #fff;
            border-bottom: 1px solid var(--color-light-stone);
            overflow-x: auto;
        }

        .sub-tabs.show { display: flex; }

        .sub-tab-btn {
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.65rem 1.25rem;
            font-family: var(--font-sans);
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            color: var(--color-stone);
            cursor: pointer;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
        }

        .sub-tab-btn:hover { color: var(--color-charcoal); }
        .sub-tab-btn.active {
            color: var(--color-forest);
            border-bottom-color: var(--color-forest);
        }

        /* Tab content */
        .tab-content {
            max-width: 1100px;
            padding: 2rem 2.5rem;
            flex: 1;
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .sub-panel { display: none; }
        .sub-panel.active { display: block; }

        /* Dashboard home panel */
        .dash-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 1.5rem 1.5rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            border-color: var(--color-forest);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .stat-number {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 600;
            color: var(--color-forest);
            line-height: 1;
            margin-bottom: 0.35rem;
        }

        .stat-label {
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-stone);
        }

        .stat-hint {
            font-size: 0.75rem;
            color: var(--color-stone);
            margin-top: 0.5rem;
        }

        .dash-recent-title {
            font-family: var(--font-serif);
            font-size: 1.15rem;
            font-weight: 500;
            color: var(--color-forest);
            margin-bottom: 0.75rem;
        }

        .panel-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--color-forest);
            margin-bottom: 0.3rem;
        }

        .panel-desc {
            font-size: 0.9rem;
            color: var(--color-charcoal);
            margin-bottom: 1.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Cards */
        .section-divider {
            border: none;
            border-top: 1px solid var(--color-light-stone);
            margin: 2rem 0 1.5rem;
        }

        .section-heading {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--color-forest);
            margin-bottom: 0.3rem;
        }

        .section-desc {
            font-size: 0.85rem;
            color: var(--color-charcoal);
            margin-bottom: 1rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 1.5rem 1.75rem;
        }

        .card-title {
            font-family: var(--font-serif);
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--color-forest);
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-light-stone);
        }

        .field {
            margin-bottom: 1rem;
        }

        .field:last-child { margin-bottom: 0; }

        .field label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-charcoal);
            margin-bottom: 0.35rem;
        }

        .field input,
        .field select,
        .field textarea {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 16px;
            color: var(--color-charcoal);
            outline: none;
            transition: border-color 0.2s;
        }

        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            border-color: var(--color-forest);
        }

        .field textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        .field .hint {
            font-size: 0.78rem;
            color: var(--color-stone);
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.65rem 1.75rem;
            font-family: var(--font-sans);
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid var(--color-forest);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .btn-primary {
            background: var(--color-forest);
            color: var(--color-cream);
        }

        .btn-primary:hover {
            background: transparent;
            color: var(--color-forest);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-forest);
        }

        .btn-secondary:hover {
            background: var(--color-forest);
            color: var(--color-cream);
        }

        .btn-danger {
            border-color: var(--color-error);
            background: transparent;
            color: var(--color-error);
            padding: 0.35rem 0.85rem;
            font-size: 0.78rem;
        }

        .btn-danger:hover {
            background: var(--color-error);
            color: #fff;
        }

        .save-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .save-msg {
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-msg.show { opacity: 1; }
        .save-msg.success { color: var(--color-success); }
        .save-msg.error { color: var(--color-error); }

        /* Promo / Rules list */
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.65rem 0.85rem;
            background: #fff;
            border: 1px solid var(--color-light-stone);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .list-item .item-info {
            flex: 1;
        }

        .list-item .item-label {
            font-weight: 500;
            color: var(--color-forest);
        }

        .list-item .item-detail {
            font-size: 0.8rem;
            color: var(--color-stone);
        }

        .add-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .add-row input, .add-row select {
            padding: 0.5rem 0.6rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 16px;
            color: var(--color-charcoal);
            outline: none;
        }

        .add-row input:focus, .add-row select:focus {
            border-color: var(--color-forest);
        }

        /* Badge (reused by nav-badge) */

        /* Booking cards */
        .booking-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: none;
            border: 1px solid var(--color-light-stone);
            padding: 0.45rem 0.9rem;
            font-family: var(--font-sans);
            font-size: 0.82rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            color: var(--color-charcoal);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover { border-color: var(--color-forest); color: var(--color-charcoal); }
        .filter-btn.active { background: var(--color-forest); color: #fff; border-color: var(--color-forest); }

        .filter-btn .filter-count {
            display: inline-block;
            font-size: 0.65rem;
            background: rgba(0,0,0,0.12);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            margin-left: 0.3rem;
            vertical-align: middle;
        }

        .filter-btn.active .filter-count {
            background: rgba(255,255,255,0.25);
        }

        .booking-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 1.5rem 1.75rem;
            margin-bottom: 0.75rem;
        }

        .booking-card.status-pending { border-left: 3px solid #e67e22; }
        .booking-card.status-confirmed { border-left: 3px solid var(--color-success); }
        .booking-card.status-cancelled { border-left: 3px solid var(--color-error); }
        .booking-card.status-completed { border-left: 3px solid var(--color-stone); }

        .booking-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .booking-site {
            font-family: var(--font-serif);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-forest);
        }

        .booking-status {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.25rem 0.65rem;
            border-radius: 2px;
        }

        .booking-status.st-pending { background: #fef3e2; color: #c06a10; }
        .booking-status.st-confirmed { background: #e8f5e9; color: #2e6e2e; }
        .booking-status.st-cancelled { background: #fde8e8; color: #993333; }
        .booking-status.st-completed { background: #eceae8; color: #555; }

        .booking-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.6rem 2rem;
            margin-bottom: 0.75rem;
        }

        .booking-detail-label {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--color-stone);
        }

        .booking-detail-value {
            font-size: 0.9rem;
            color: var(--color-charcoal);
        }

        .booking-detail-value a {
            color: var(--color-forest);
            text-decoration: none;
            border-bottom: 1px solid var(--color-light-stone);
        }

        .booking-detail-value a:hover { border-color: var(--color-forest); }

        .booking-pricing {
            font-size: 0.88rem;
            color: var(--color-charcoal);
            padding: 0.5rem 0.75rem;
            background: #fff;
            margin-bottom: 0.75rem;
        }

        .booking-pricing strong {
            color: var(--color-forest);
        }

        .booking-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-light-stone);
            flex-wrap: wrap;
        }

        .booking-date-submitted {
            font-size: 0.78rem;
            color: var(--color-stone);
            margin-top: 0.3rem;
        }

        /* Message cards */
        .message-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 1.5rem 1.75rem;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .message-card.unread {
            border-left: 3px solid var(--color-forest);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .message-from {
            font-weight: 500;
            color: var(--color-forest);
            font-size: 0.95rem;
        }

        .message-email {
            font-size: 0.82rem;
            color: var(--color-stone);
        }

        .message-date {
            font-size: 0.78rem;
            color: var(--color-stone);
            white-space: nowrap;
        }

        .message-subject {
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--color-charcoal);
            margin-bottom: 0.4rem;
        }

        .message-body {
            font-size: 0.9rem;
            color: var(--color-charcoal);
            line-height: 1.65;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-light-stone);
        }

        /* Calendar */
        .cal-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .cal-nav-btn {
            background: none;
            border: 1px solid var(--color-light-stone);
            padding: 0.35rem 0.85rem;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--color-charcoal);
            transition: border-color 0.2s;
        }

        .cal-nav-btn:hover { border-color: var(--color-forest); }

        /* Site selector */
        .site-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .site-sel-btn {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 0.6rem 1.1rem;
            font-family: var(--font-sans);
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--color-stone);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            line-height: 1.4;
        }

        .site-sel-btn:hover { border-color: var(--color-forest); color: var(--color-charcoal); }

        .site-sel-btn.active {
            background: var(--color-forest);
            color: #fff;
            border-color: var(--color-forest);
        }

        .site-sel-btn .sel-meta {
            display: block;
            font-size: 0.7rem;
            font-weight: 400;
            opacity: 0.7;
            margin-top: 0.15rem;
        }

        .site-sel-btn.active .sel-meta { opacity: 0.8; }

        .site-form { display: none; }
        .site-form.active { display: block; }

        .cal-today-btn {
            background: none;
            border: 1px solid var(--color-light-stone);
            padding: 0.25rem 0.65rem;
            font-family: var(--font-sans);
            font-size: 0.72rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--color-stone);
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
        }

        .cal-today-btn:hover { border-color: var(--color-forest); color: var(--color-forest); }

        .cal-occupancy {
            text-align: center;
            font-size: 0.75rem;
            color: var(--color-stone);
            margin-bottom: 0.6rem;
            line-height: 1.5;
        }

        .cal-occupancy strong { color: var(--color-charcoal); font-weight: 500; }

        .cal-month-label {
            font-family: var(--font-serif);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--color-forest);
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            user-select: none;
        }

        .cal-header-cell {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--color-charcoal);
            padding: 0.35rem 0;
        }

        .cal-cell {
            text-align: center;
            padding: 0.45rem 0;
            font-size: 0.82rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background 0.15s, color 0.15s;
            user-select: none;
        }

        .cal-cell:hover { background: var(--color-light-stone); }

        .cal-cell.empty {
            cursor: default;
        }

        .cal-cell.empty:hover { background: none; }

        .cal-cell.past {
            color: #ccc;
            cursor: default;
        }

        .cal-cell.past:hover { background: none; }

        .cal-cell.blocked {
            background: #c0392b;
            color: #fff;
            border-radius: 2px;
        }

        .cal-cell.blocked:hover {
            background: #a93226;
        }

        .cal-cell.booked {
            background: #2874a6;
            color: #fff;
            border-radius: 2px;
            cursor: not-allowed;
        }
        .cal-cell.booked:hover {
            background: #21618c;
        }

        .cal-cell.today {
            border: 1px solid var(--color-forest);
            font-weight: 600;
        }

        .cal-legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1.5rem;
            font-size: 0.8rem;
            color: var(--color-charcoal);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .legend-swatch {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 1px solid var(--color-light-stone);
        }

        .legend-available { background: #fff; }
        .legend-blocked { background: #c0392b; border-color: #c0392b; }
        .legend-selected { background: var(--color-forest); border-color: var(--color-forest); }
        .legend-past { background: #f0f0f0; }

        .cal-cell.selected {
            background: var(--color-forest);
            color: #fff;
            border-radius: 2px;
        }

        .cal-cell.selected:hover {
            background: #1e3320;
        }

        .cal-cell.selected.blocked {
            background: var(--color-forest);
            outline: 2px solid #c0392b;
            outline-offset: -2px;
        }

        .cal-sel-toolbar {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            margin-top: 0.75rem;
            background: #f5f2ef;
            border: 1px solid var(--color-light-stone);
            border-radius: 4px;
            font-size: 0.78rem;
            color: var(--color-charcoal);
            flex-wrap: wrap;
        }

        .cal-sel-toolbar.visible {
            display: flex;
        }

        .cal-sel-toolbar .sel-count {
            font-weight: 600;
            margin-right: auto;
        }

        .cal-sel-btn {
            padding: 0.3rem 0.7rem;
            font-family: var(--font-sans);
            font-size: 0.72rem;
            font-weight: 500;
            border: 1px solid var(--color-light-stone);
            cursor: pointer;
            transition: all 0.15s;
            background: #fff;
            color: var(--color-charcoal);
        }

        .cal-sel-btn:hover {
            border-color: var(--color-forest);
            color: var(--color-forest);
        }

        .cal-sel-btn.sel-block {
            background: #c0392b;
            color: #fff;
            border-color: #c0392b;
        }

        .cal-sel-btn.sel-block:hover {
            background: #a93226;
            border-color: #a93226;
        }

        .cal-sel-btn.sel-open {
            background: var(--color-forest);
            color: #fff;
            border-color: var(--color-forest);
        }

        .cal-sel-btn.sel-open:hover {
            background: #1e3320;
            border-color: #1e3320;
        }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--color-light-stone);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-bottom: 0.75rem;
            color: var(--color-stone);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--color-forest);
            background: rgba(44, 62, 45, 0.03);
        }

        .upload-zone svg {
            display: block;
            margin: 0 auto 0.5rem;
            color: var(--color-stone);
        }

        .upload-zone span {
            font-size: 0.85rem;
        }

        .upload-progress {
            font-size: 0.82rem;
            color: var(--color-stone);
            margin-bottom: 0.5rem;
            min-height: 1em;
        }

        /* Image grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .image-grid.gallery-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .img-thumb {
            position: relative;
            aspect-ratio: 4/3;
            border: 1px solid var(--color-light-stone);
            overflow: hidden;
            background: #eee;
        }

        .img-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .img-thumb .img-order {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 0.68rem;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 2px;
        }

        .img-thumb .img-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 1px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .img-thumb:hover .img-actions {
            opacity: 1;
        }

        /* On touch devices, always show image action buttons */
        @media (hover: none) and (pointer: coarse) {
            .img-thumb .img-actions {
                opacity: 1;
            }
        }

        .img-action-btn {
            flex: 1;
            padding: 5px 0;
            border: none;
            font-size: 0.68rem;
            font-weight: 500;
            font-family: var(--font-sans);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .img-action-btn.move-btn {
            background: rgba(44, 62, 45, 0.85);
            color: #fff;
        }

        .img-action-btn.delete-btn {
            background: rgba(187, 68, 68, 0.85);
            color: #fff;
        }

        .img-empty {
            font-size: 0.85rem;
            color: var(--color-stone);
            padding: 0.5rem 0;
            grid-column: 1 / -1;
        }

        /* Content cards (full-width site cards with description + media) */
        .content-card {
            margin-bottom: 1.25rem;
        }

        .card-title.collapsible {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .card-title.collapsible:hover {
            color: var(--color-charcoal);
        }

        .card-toggle {
            font-size: 0.75rem;
            color: var(--color-stone);
            transition: transform 0.2s;
        }

        .card-title.collapsible.collapsed .card-toggle {
            transform: rotate(-90deg);
        }

        .content-card-body.collapsed {
            display: none;
        }

        /* Field row (inline fields) */
        .field-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .field-row .field {
            flex: 1;
            margin-bottom: 0;
        }

        /* Amenity category blocks */
        .amenity-cat-block {
            border: 1px solid var(--color-light-stone);
            padding: 0.75rem 1rem;
            margin-bottom: 0.65rem;
            background: var(--color-cream);
        }

        .amenity-cat-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .amenity-cat-header input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-charcoal);
            outline: none;
        }

        .amenity-cat-header input:focus {
            border-color: var(--color-forest);
        }

        .amenity-cat-remove {
            background: none;
            border: none;
            color: var(--color-stone);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.2rem 0.4rem;
            line-height: 1;
            font-family: var(--font-sans);
        }

        .amenity-cat-remove:hover {
            color: var(--color-error);
        }

        /* Amenity tags */
        .amenity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
            min-height: 1.5rem;
        }

        .amenity-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: var(--color-cream);
            border: 1px solid var(--color-light-stone);
            padding: 0.25rem 0.6rem;
            font-size: 0.8rem;
            color: var(--color-charcoal);
            line-height: 1.3;
        }

        .amenity-tag .amenity-remove {
            cursor: pointer;
            color: var(--color-stone);
            font-size: 1rem;
            line-height: 1;
            transition: color 0.15s;
            border: none;
            background: none;
            padding: 0;
            font-family: var(--font-sans);
        }

        .amenity-tag .amenity-remove:hover {
            color: var(--color-error);
        }

        .amenity-add {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .amenity-add input {
            flex: 1;
            padding: 0.45rem 0.65rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 0.85rem;
            color: var(--color-charcoal);
            outline: none;
            transition: border-color 0.2s;
        }

        .amenity-add input:focus {
            border-color: var(--color-forest);
        }

        .btn-sm {
            padding: 0.4rem 0.85rem;
            font-size: 0.78rem;
        }

        /* Explore slot cards */
        .explore-slot-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 0.75rem 1rem;
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto auto;
            gap: 0.5rem;
            align-items: center;
        }
        .explore-slot-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.88rem;
        }
        .explore-slot-header strong {
            color: var(--color-forest);
        }
        .explore-slot-status {
            font-size: 0.78rem;
            color: var(--color-stone);
        }
        .explore-slot-preview {
            grid-column: 1 / -1;
        }
        .explore-slot-preview img,
        .explore-slot-preview video {
            max-height: 120px;
            max-width: 100%;
            object-fit: cover;
            border: 1px solid var(--color-light-stone);
        }
        .explore-slot-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            grid-column: 1 / -1;
        }

        /* Responsive — tablet */
        @media (max-width: 1024px) {
            .tab-content { padding: 2rem 2rem; }
            .sub-tabs { padding: 0 2rem; }
            .main-header { padding: 1rem 2rem; }
            .card-grid-3 { grid-template-columns: 1fr 1fr; }
            .booking-details { grid-template-columns: 1fr 1fr; }
            .image-grid { grid-template-columns: repeat(3, 1fr); }
            .dash-stats { grid-template-columns: repeat(2, 1fr); }
        }

        /* Responsive — mobile */
        @media (max-width: 768px) {
            .sidebar {
                left: -260px;
                transition: left 0.3s ease;
            }
            .sidebar.open { left: 0; }
            .sidebar-toggle { display: flex; }
            .main-content { margin-left: 0; overflow-x: hidden; }
            .main-header { padding: 0.85rem 1rem 0.85rem 3.5rem; }
            .main-header-title { font-size: 1.1rem; }
            .tab-content { padding: 1.25rem 0.75rem; }
            .sub-tabs { padding: 0 0.75rem; }
            .sub-tab-btn { padding: 0.55rem 0.75rem; font-size: 0.75rem; }
            .dash-stats { grid-template-columns: 1fr; }

            .field-row { flex-direction: column; gap: 0; }
            .field-row .field { margin-bottom: 1rem; }
            .card-grid { grid-template-columns: 1fr; }
            .card-grid-3 { grid-template-columns: 1fr; }

            /* Cards — reduce padding on small screens */
            .card { padding: 1rem 1rem; }
            .booking-card { padding: 1rem 1rem; }
            .message-card { padding: 1rem 1rem; }

            .btn-danger {
                padding: 0.5rem 0.85rem;
                font-size: 0.8rem;
                min-height: 44px;
            }

            .filter-btn {
                padding: 0.55rem 0.85rem;
                min-height: 44px;
            }

            .cal-nav-btn, .cal-today-btn {
                padding: 0.5rem 0.85rem;
                min-height: 44px;
            }

            .booking-details {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem 1rem;
            }

            .booking-actions {
                flex-wrap: wrap;
            }

            .booking-actions .btn {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            /* Image grid — 2 columns on mobile */
            .image-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            /* Site selector — scroll horizontally on mobile */
            .site-selector {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 0.4rem;
                padding-bottom: 0.25rem;
            }

            .site-sel-btn {
                white-space: nowrap;
                flex-shrink: 0;
                min-height: 44px;
                padding: 0.5rem 0.85rem;
                font-size: 0.78rem;
            }

            /* Calendar — tighter on mobile */
            .cal-cell {
                padding: 0.35rem 0;
                font-size: 0.75rem;
            }

            .cal-header-cell {
                font-size: 0.62rem;
                padding: 0.25rem 0;
            }

            .cal-month-label {
                font-size: 0.95rem;
            }

            .cal-legend {
                flex-wrap: wrap;
                gap: 0.75rem;
                font-size: 0.72rem;
            }

            .cal-sel-toolbar {
                font-size: 0.72rem;
                padding: 0.5rem 0.6rem;
                gap: 0.4rem;
            }

            .cal-sel-btn {
                min-height: 36px;
                padding: 0.3rem 0.6rem;
            }

            /* Save bar — wrap on mobile */
            .save-bar {
                flex-wrap: wrap;
            }

            .save-bar .btn {
                min-height: 44px;
            }

            /* Messages — header stack on small screens */
            .message-header {
                flex-direction: column;
                gap: 0.25rem;
            }

            .message-date {
                align-self: flex-start;
            }

            /* Explore slot cards */
            .explore-slot-card {
                grid-template-columns: 1fr;
            }

            .explore-slot-actions {
                flex-wrap: wrap;
            }

            .explore-slot-actions .btn {
                min-height: 44px;
            }

            /* Booking top section — stack on very small screens */
            .booking-top {
                flex-wrap: wrap;
                gap: 0.4rem;
            }

            /* Upload zone */
            .upload-zone {
                padding: 1rem;
            }

            /* Panel description text */
            .panel-desc {
                font-size: 0.82rem;
            }

            .section-desc {
                font-size: 0.8rem;
            }

            /* Amenity tags */
            .amenity-add {
                flex-wrap: wrap;
            }

            .amenity-add input {
                min-width: 0;
                flex: 1 1 120px;
            }

            /* Prevent horizontal overflow */
            .tab-content {
                overflow-x: hidden;
                max-width: 100vw;
            }

            .tab-panel {
                overflow-x: hidden;
            }

            /* Cards — constrain max-width on mobile */
            .card[style*="max-width"] {
                max-width: 100% !important;
            }

            .image-grid.gallery-grid {
                grid-template-columns: 1fr 1fr;
            }

            /* Upload zone text wrapping */
            .upload-zone span {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Filter buttons — scrollable row */
            .booking-filters {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0.25rem;
            }

            .filter-btn {
                white-space: nowrap;
                flex-shrink: 0;
            }
        }

        /* Extra small screens */
        @media (max-width: 400px) {
            .tab-content { padding: 1rem 0.5rem; }
            .booking-details { grid-template-columns: 1fr; }
            .image-grid { grid-template-columns: 1fr 1fr; }
            .stat-card { padding: 1rem; }
            .card { padding: 0.85rem; }
        }
    </style>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="login-screen">
    <div class="login-card">
        <h1>Ahana Hillside</h1>
        <div class="subtitle">Admin Dashboard</div>
        <form onsubmit="handleLogin(event)">
            <input type="password" id="login-password" placeholder="Enter admin password" autocomplete="current-password" required>
            <div class="login-error" id="login-error">Invalid password. Please try again.</div>
            <button type="submit" class="btn btn-primary" style="width:100%">Sign In</button>
        </form>
    </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">

    <!-- Mobile sidebar toggle -->
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Ahana Hillside</h1>
            <div class="sidebar-sub">Admin Dashboard</div>
        </div>
        <nav class="sidebar-nav">
            <button class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                Dashboard
            </button>
            <button class="nav-item" data-tab="messages" onclick="switchTab('messages')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Messages
                <span class="nav-badge" id="msg-badge"></span>
            </button>
            <button class="nav-item" data-tab="bookings" onclick="switchTab('bookings')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Bookings
                <span class="nav-badge" id="booking-badge"></span>
            </button>
            <button class="nav-item" data-tab="campsites" onclick="switchTab('campsites')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18l9-6 9 6"/><path d="M3 12l9-6 9 6"/></svg>
                Campsites &amp; Rooms
            </button>
            <button class="nav-item" data-tab="viator" onclick="switchTab('viator')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                Viator
            </button>
            <button class="nav-item" data-tab="gallery" onclick="switchTab('gallery')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                Gallery
            </button>
            <button class="nav-item" data-tab="settings" onclick="switchTab('settings')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Settings
            </button>
        </nav>
        <div class="sidebar-footer">
            <button class="logout-btn" onclick="handleLogout()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Log out
            </button>
        </div>
    </aside>

    <!-- Main content -->
    <div class="main-content">
        <div class="main-header">
            <div class="main-header-title" id="main-header-title">Dashboard</div>
        </div>

        <!-- Sub-tabs for Campsites -->
        <div class="sub-tabs" id="campsites-sub-tabs">
            <button class="sub-tab-btn active" data-subtab="availability">Availability</button>
            <button class="sub-tab-btn" data-subtab="content">Content &amp; Media</button>
            <button class="sub-tab-btn" data-subtab="pricing">Pricing &amp; Promos</button>
            <button class="sub-tab-btn" data-subtab="rules">Rules &amp; Policies</button>
        </div>

        <div class="tab-content">

        <!-- DASHBOARD HOME PANEL -->
        <div class="tab-panel active" id="panel-dashboard">
            <div class="dash-stats">
                <div class="stat-card" onclick="switchTab('messages')">
                    <div class="stat-number" id="stat-messages">—</div>
                    <div class="stat-label">Unread Messages</div>
                    <div class="stat-hint">Click to view messages</div>
                </div>
                <div class="stat-card" onclick="switchTab('bookings')">
                    <div class="stat-number" id="stat-bookings">—</div>
                    <div class="stat-label">Pending Bookings</div>
                    <div class="stat-hint">Click to view bookings</div>
                </div>
                <div class="stat-card" onclick="switchTab('campsites')">
                    <div class="stat-number" id="stat-sites">—</div>
                    <div class="stat-label">Active Sites &amp; Rooms</div>
                    <div class="stat-hint">Click to manage</div>
                </div>
            </div>

            <div class="dash-recent-title">Recent Bookings</div>
            <div id="dash-recent-bookings"><div style="font-size:0.85rem;color:var(--color-stone)">Loading...</div></div>
        </div>

        <!-- MESSAGES PANEL -->
        <div class="tab-panel" id="panel-messages">
            <div class="panel-desc">Messages from visitors via the Contact Us page.</div>
            <div id="messages-list"><div style="font-size:0.9rem;color:var(--color-stone);padding:1rem 0;">Loading messages...</div></div>
        </div>

        <!-- BOOKINGS PANEL -->
        <div class="tab-panel" id="panel-bookings">
            <div class="panel-desc">View and manage guest bookings. Update status to keep track of confirmed, cancelled and completed stays.</div>

            <div class="booking-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterBookings('all')">All</button>
                <button class="filter-btn" data-filter="pending" onclick="filterBookings('pending')">Pending</button>
                <button class="filter-btn" data-filter="confirmed" onclick="filterBookings('confirmed')">Confirmed</button>
                <button class="filter-btn" data-filter="cancelled" onclick="filterBookings('cancelled')">Cancelled</button>
                <button class="filter-btn" data-filter="completed" onclick="filterBookings('completed')">Completed</button>
            </div>

            <div id="bookings-list"><div style="font-size:0.9rem;color:var(--color-stone);padding:1rem 0;">Loading bookings...</div></div>
        </div>

        <!-- CAMPSITES PANEL (contains sub-panels) -->
        <div class="tab-panel" id="panel-campsites">

            <!-- Availability sub-panel -->
            <div class="sub-panel active" id="subpanel-availability">
                <div class="panel-desc">Click dates to select them, then block or open in bulk. Shift+click to select a range. Click+drag to select multiple dates. Blocked dates cannot be booked by guests.</div>
                <div style="display:flex;gap:1rem;margin-bottom:1rem;font-size:0.78rem;color:#666">
                    <span><span style="display:inline-block;width:12px;height:12px;background:#c0392b;border-radius:2px;vertical-align:middle;margin-right:4px"></span> Manually blocked</span>
                    <span><span style="display:inline-block;width:12px;height:12px;background:#2874a6;border-radius:2px;vertical-align:middle;margin-right:4px"></span> Booked by guest</span>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">SAMAVAS</div>
                        <div class="cal-nav">
                            <button class="cal-nav-btn" onclick="calNav('samavas', -1)">&larr;</button>
                            <span class="cal-month-label" id="cal-label-samavas"></span>
                            <button class="cal-today-btn" onclick="calToday('samavas')">Today</button>
                            <button class="cal-nav-btn" onclick="calNav('samavas', 1)">&rarr;</button>
                        </div>
                        <div class="cal-occupancy" id="cal-occ-samavas"></div>
                        <div class="cal-grid" id="cal-grid-samavas"></div>
                        <div class="cal-sel-toolbar" id="cal-sel-samavas">
                            <span class="sel-count" id="cal-sel-count-samavas">0 selected</span>
                            <button class="cal-sel-btn sel-block" onclick="bulkBlock('samavas')">Block Selected</button>
                            <button class="cal-sel-btn sel-open" onclick="bulkOpen('samavas')">Open Selected</button>
                            <button class="cal-sel-btn" onclick="clearSelection('samavas')">Clear</button>
                        </div>
                        <div class="save-bar" style="margin-top:1rem">
                            <button class="btn btn-primary" onclick="saveBlockedDates('samavas')">Save</button>
                            <span class="save-msg" id="avail-samavas-msg"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">CHHAYA</div>
                        <div class="cal-nav">
                            <button class="cal-nav-btn" onclick="calNav('chhaya', -1)">&larr;</button>
                            <span class="cal-month-label" id="cal-label-chhaya"></span>
                            <button class="cal-today-btn" onclick="calToday('chhaya')">Today</button>
                            <button class="cal-nav-btn" onclick="calNav('chhaya', 1)">&rarr;</button>
                        </div>
                        <div class="cal-occupancy" id="cal-occ-chhaya"></div>
                        <div class="cal-grid" id="cal-grid-chhaya"></div>
                        <div class="cal-sel-toolbar" id="cal-sel-chhaya">
                            <span class="sel-count" id="cal-sel-count-chhaya">0 selected</span>
                            <button class="cal-sel-btn sel-block" onclick="bulkBlock('chhaya')">Block Selected</button>
                            <button class="cal-sel-btn sel-open" onclick="bulkOpen('chhaya')">Open Selected</button>
                            <button class="cal-sel-btn" onclick="clearSelection('chhaya')">Clear</button>
                        </div>
                        <div class="save-bar" style="margin-top:1rem">
                            <button class="btn btn-primary" onclick="saveBlockedDates('chhaya')">Save</button>
                            <span class="save-msg" id="avail-chhaya-msg"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">MOUNTAIN VIEW ROOM</div>
                        <div class="cal-nav">
                            <button class="cal-nav-btn" onclick="calNav('mountain-view', -1)">&larr;</button>
                            <span class="cal-month-label" id="cal-label-mountain-view"></span>
                            <button class="cal-today-btn" onclick="calToday('mountain-view')">Today</button>
                            <button class="cal-nav-btn" onclick="calNav('mountain-view', 1)">&rarr;</button>
                        </div>
                        <div class="cal-occupancy" id="cal-occ-mountain-view"></div>
                        <div class="cal-grid" id="cal-grid-mountain-view"></div>
                        <div class="cal-sel-toolbar" id="cal-sel-mountain-view">
                            <span class="sel-count" id="cal-sel-count-mountain-view">0 selected</span>
                            <button class="cal-sel-btn sel-block" onclick="bulkBlock('mountain-view')">Block Selected</button>
                            <button class="cal-sel-btn sel-open" onclick="bulkOpen('mountain-view')">Open Selected</button>
                            <button class="cal-sel-btn" onclick="clearSelection('mountain-view')">Clear</button>
                        </div>
                        <div class="save-bar" style="margin-top:1rem">
                            <button class="btn btn-primary" onclick="saveBlockedDates('mountain-view')">Save</button>
                            <span class="save-msg" id="avail-mountain-view-msg"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">GARDEN VIEW ROOM</div>
                        <div class="cal-nav">
                            <button class="cal-nav-btn" onclick="calNav('garden-view', -1)">&larr;</button>
                            <span class="cal-month-label" id="cal-label-garden-view"></span>
                            <button class="cal-today-btn" onclick="calToday('garden-view')">Today</button>
                            <button class="cal-nav-btn" onclick="calNav('garden-view', 1)">&rarr;</button>
                        </div>
                        <div class="cal-occupancy" id="cal-occ-garden-view"></div>
                        <div class="cal-grid" id="cal-grid-garden-view"></div>
                        <div class="cal-sel-toolbar" id="cal-sel-garden-view">
                            <span class="sel-count" id="cal-sel-count-garden-view">0 selected</span>
                            <button class="cal-sel-btn sel-block" onclick="bulkBlock('garden-view')">Block Selected</button>
                            <button class="cal-sel-btn sel-open" onclick="bulkOpen('garden-view')">Open Selected</button>
                            <button class="cal-sel-btn" onclick="clearSelection('garden-view')">Clear</button>
                        </div>
                        <div class="save-bar" style="margin-top:1rem">
                            <button class="btn btn-primary" onclick="saveBlockedDates('garden-view')">Save</button>
                            <span class="save-msg" id="avail-garden-view-msg"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">SUITE WITH GARDEN VIEW</div>
                        <div class="cal-nav">
                            <button class="cal-nav-btn" onclick="calNav('suite', -1)">&larr;</button>
                            <span class="cal-month-label" id="cal-label-suite"></span>
                            <button class="cal-today-btn" onclick="calToday('suite')">Today</button>
                            <button class="cal-nav-btn" onclick="calNav('suite', 1)">&rarr;</button>
                        </div>
                        <div class="cal-occupancy" id="cal-occ-suite"></div>
                        <div class="cal-grid" id="cal-grid-suite"></div>
                        <div class="cal-sel-toolbar" id="cal-sel-suite">
                            <span class="sel-count" id="cal-sel-count-suite">0 selected</span>
                            <button class="cal-sel-btn sel-block" onclick="bulkBlock('suite')">Block Selected</button>
                            <button class="cal-sel-btn sel-open" onclick="bulkOpen('suite')">Open Selected</button>
                            <button class="cal-sel-btn" onclick="clearSelection('suite')">Clear</button>
                        </div>
                        <div class="save-bar" style="margin-top:1rem">
                            <button class="btn btn-primary" onclick="saveBlockedDates('suite')">Save</button>
                            <span class="save-msg" id="avail-suite-msg"></span>
                        </div>
                    </div>
                </div>

                <div class="cal-legend">
                    <span class="legend-item"><span class="legend-swatch legend-available"></span> Available</span>
                    <span class="legend-item"><span class="legend-swatch legend-blocked"></span> Blocked</span>
                    <span class="legend-item"><span class="legend-swatch legend-selected"></span> Selected</span>
                    <span class="legend-item"><span class="legend-swatch legend-past"></span> Past</span>
                </div>
            </div>

            <!-- Content & Media sub-panel (Images + Content + Rules) -->
            <div class="sub-panel" id="subpanel-content">
                <div class="panel-desc">Manage photos, descriptions, amenities, and campground rules for rooms and campsites.</div>

                <!-- Site selector -->
                <div class="section-heading">Rooms &amp; Campsites</div>
                <div class="section-desc">Select a site to edit its descriptions, amenities, and media. First image is the cover. Max 15 per site.</div>

                <div class="site-selector" id="content-site-selector">
                    <button class="site-sel-btn active" data-site="garden-view" onclick="selectContentSite('garden-view')">Garden View Room<span class="sel-meta" id="sel-meta-garden-view"></span></button>
                    <button class="site-sel-btn" data-site="mountain-view" onclick="selectContentSite('mountain-view')">Mountain View Room<span class="sel-meta" id="sel-meta-mountain-view"></span></button>
                    <button class="site-sel-btn" data-site="suite" onclick="selectContentSite('suite')">Suite<span class="sel-meta" id="sel-meta-suite"></span></button>
                    <button class="site-sel-btn" data-site="samavas" onclick="selectContentSite('samavas')">Samavas<span class="sel-meta" id="sel-meta-samavas"></span></button>
                    <button class="site-sel-btn" data-site="chhaya" onclick="selectContentSite('chhaya')">Chhaya<span class="sel-meta" id="sel-meta-chhaya"></span></button>
                </div>

                <!-- GARDEN VIEW ROOM -->
                <div class="site-form active" id="site-form-garden-view">
                <div class="card">
                    <div class="field">
                        <label>Room type line</label>
                        <input type="text" id="c-garden-view-type">
                        <div class="hint">e.g. "Private Room &middot; Sleeps 4 &middot; Garden Views"</div>
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <textarea id="c-garden-view-desc" rows="3"></textarea>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>Size</label>
                            <input type="text" id="c-garden-view-size" placeholder="e.g. 18 m²">
                        </div>
                        <div class="field">
                            <label>Beds</label>
                            <input type="text" id="c-garden-view-beds" placeholder="e.g. 1 large double bed">
                        </div>
                        <div class="field">
                            <label>Smoking</label>
                            <select id="c-garden-view-smoking">
                                <option value="no">No smoking</option>
                                <option value="outdoors">Outdoors only</option>
                                <option value="yes">Smoking allowed</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label>Highlight Tags</label>
                        <div class="hint" style="margin-bottom:0.4rem">Quick feature tags shown on the booking card</div>
                        <div class="amenity-tags" id="amenities-garden-view"></div>
                        <div class="amenity-add">
                            <input type="text" id="amenity-input-garden-view" placeholder="Add tag..." onkeydown="if(event.key==='Enter'){addAmenity('garden-view');event.preventDefault()}">
                            <button class="btn btn-secondary btn-sm" onclick="addAmenity('garden-view')">Add</button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Amenity Categories</label>
                        <div class="hint" style="margin-bottom:0.4rem">Detailed amenities grouped by category (e.g. Bathroom, Facilities, View)</div>
                        <div id="amenity-cats-garden-view"></div>
                        <button class="btn btn-secondary btn-sm" onclick="addAmenityCategory('garden-view')" style="margin-top:0.5rem">+ Add Category</button>
                    </div>
                    <div class="field">
                        <label>Photos &amp; Videos</label>
                        <div class="upload-zone" id="upload-zone-garden-view" onclick="document.getElementById('file-garden-view').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Click to upload or drag & drop</span>
                            <input type="file" id="file-garden-view" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" multiple style="display:none" onchange="handleFileSelect('garden-view', this.files)">
                        </div>
                        <div class="upload-progress" id="progress-garden-view"></div>
                        <div class="image-grid" id="images-garden-view"></div>
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('content-garden-view')">Save</button>
                        <span class="save-msg" id="content-garden-view-msg"></span>
                    </div>
                </div>
                </div>

                <!-- MOUNTAIN VIEW ROOM -->
                <div class="site-form" id="site-form-mountain-view">
                <div class="card">
                    <div class="field">
                        <label>Room type line</label>
                        <input type="text" id="c-mountain-view-type">
                        <div class="hint">e.g. "Private Room &middot; Sleeps 4 &middot; Mountain Views"</div>
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <textarea id="c-mountain-view-desc" rows="3"></textarea>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>Size</label>
                            <input type="text" id="c-mountain-view-size" placeholder="e.g. 18 m²">
                        </div>
                        <div class="field">
                            <label>Beds</label>
                            <input type="text" id="c-mountain-view-beds" placeholder="e.g. 1 large double bed">
                        </div>
                        <div class="field">
                            <label>Smoking</label>
                            <select id="c-mountain-view-smoking">
                                <option value="no">No smoking</option>
                                <option value="outdoors">Outdoors only</option>
                                <option value="yes">Smoking allowed</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label>Highlight Tags</label>
                        <div class="hint" style="margin-bottom:0.4rem">Quick feature tags shown on the booking card</div>
                        <div class="amenity-tags" id="amenities-mountain-view"></div>
                        <div class="amenity-add">
                            <input type="text" id="amenity-input-mountain-view" placeholder="Add tag..." onkeydown="if(event.key==='Enter'){addAmenity('mountain-view');event.preventDefault()}">
                            <button class="btn btn-secondary btn-sm" onclick="addAmenity('mountain-view')">Add</button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Amenity Categories</label>
                        <div class="hint" style="margin-bottom:0.4rem">Detailed amenities grouped by category (e.g. Bathroom, Facilities, View)</div>
                        <div id="amenity-cats-mountain-view"></div>
                        <button class="btn btn-secondary btn-sm" onclick="addAmenityCategory('mountain-view')" style="margin-top:0.5rem">+ Add Category</button>
                    </div>
                    <div class="field">
                        <label>Photos &amp; Videos</label>
                        <div class="upload-zone" id="upload-zone-mountain-view" onclick="document.getElementById('file-mountain-view').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Click to upload or drag & drop</span>
                            <input type="file" id="file-mountain-view" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" multiple style="display:none" onchange="handleFileSelect('mountain-view', this.files)">
                        </div>
                        <div class="upload-progress" id="progress-mountain-view"></div>
                        <div class="image-grid" id="images-mountain-view"></div>
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('content-mountain-view')">Save</button>
                        <span class="save-msg" id="content-mountain-view-msg"></span>
                    </div>
                </div>
                </div>

                <!-- SUITE WITH GARDEN VIEW -->
                <div class="site-form" id="site-form-suite">
                <div class="card">
                    <div class="field">
                        <label>Room type line</label>
                        <input type="text" id="c-suite-type">
                        <div class="hint">e.g. "Private Suite &middot; Sleeps 6 &middot; Garden Views"</div>
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <textarea id="c-suite-desc" rows="3"></textarea>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>Size</label>
                            <input type="text" id="c-suite-size" placeholder="e.g. 28 m²">
                        </div>
                        <div class="field">
                            <label>Beds</label>
                            <input type="text" id="c-suite-beds" placeholder="e.g. 1 king bed + sofa bed">
                        </div>
                        <div class="field">
                            <label>Smoking</label>
                            <select id="c-suite-smoking">
                                <option value="no">No smoking</option>
                                <option value="outdoors">Outdoors only</option>
                                <option value="yes">Smoking allowed</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label>Highlight Tags</label>
                        <div class="hint" style="margin-bottom:0.4rem">Quick feature tags shown on the booking card</div>
                        <div class="amenity-tags" id="amenities-suite"></div>
                        <div class="amenity-add">
                            <input type="text" id="amenity-input-suite" placeholder="Add tag..." onkeydown="if(event.key==='Enter'){addAmenity('suite');event.preventDefault()}">
                            <button class="btn btn-secondary btn-sm" onclick="addAmenity('suite')">Add</button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Amenity Categories</label>
                        <div class="hint" style="margin-bottom:0.4rem">Detailed amenities grouped by category (e.g. Bathroom, Facilities, View)</div>
                        <div id="amenity-cats-suite"></div>
                        <button class="btn btn-secondary btn-sm" onclick="addAmenityCategory('suite')" style="margin-top:0.5rem">+ Add Category</button>
                    </div>
                    <div class="field">
                        <label>Photos &amp; Videos</label>
                        <div class="upload-zone" id="upload-zone-suite" onclick="document.getElementById('file-suite').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Click to upload or drag & drop</span>
                            <input type="file" id="file-suite" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" multiple style="display:none" onchange="handleFileSelect('suite', this.files)">
                        </div>
                        <div class="upload-progress" id="progress-suite"></div>
                        <div class="image-grid" id="images-suite"></div>
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('content-suite')">Save</button>
                        <span class="save-msg" id="content-suite-msg"></span>
                    </div>
                </div>
                </div>

                <!-- SAMAVAS -->
                <div class="site-form" id="site-form-samavas">
                <div class="card">
                    <div class="field">
                        <label>Site type line</label>
                        <input type="text" id="c-samavas-type">
                        <div class="hint">e.g. "RV / Tent Site &middot; Sleeps 15 &middot; Vehicles under 30 m"</div>
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <textarea id="c-samavas-desc" rows="3"></textarea>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>Size</label>
                            <input type="text" id="c-samavas-size" placeholder="e.g. 1000 m²">
                        </div>
                        <div class="field">
                            <label>Beds / Setup</label>
                            <input type="text" id="c-samavas-beds" placeholder="e.g. BYO tent / swag">
                        </div>
                        <div class="field">
                            <label>Smoking</label>
                            <select id="c-samavas-smoking">
                                <option value="no">No smoking</option>
                                <option value="outdoors">Outdoors only</option>
                                <option value="yes">Smoking allowed</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label>Highlight Tags</label>
                        <div class="hint" style="margin-bottom:0.4rem">Quick feature tags shown on the booking card</div>
                        <div class="amenity-tags" id="amenities-samavas"></div>
                        <div class="amenity-add">
                            <input type="text" id="amenity-input-samavas" placeholder="Add tag..." onkeydown="if(event.key==='Enter'){addAmenity('samavas');event.preventDefault()}">
                            <button class="btn btn-secondary btn-sm" onclick="addAmenity('samavas')">Add</button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Amenity Categories</label>
                        <div class="hint" style="margin-bottom:0.4rem">Detailed amenities grouped by category (e.g. Facilities, View)</div>
                        <div id="amenity-cats-samavas"></div>
                        <button class="btn btn-secondary btn-sm" onclick="addAmenityCategory('samavas')" style="margin-top:0.5rem">+ Add Category</button>
                    </div>
                    <div class="field">
                        <label>Photos &amp; Videos</label>
                        <div class="upload-zone" id="upload-zone-samavas" onclick="document.getElementById('file-samavas').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Click to upload or drag & drop</span>
                            <input type="file" id="file-samavas" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" multiple style="display:none" onchange="handleFileSelect('samavas', this.files)">
                        </div>
                        <div class="upload-progress" id="progress-samavas"></div>
                        <div class="image-grid" id="images-samavas"></div>
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('content-samavas')">Save</button>
                        <span class="save-msg" id="content-samavas-msg"></span>
                    </div>
                </div>
                </div>

                <!-- CHHAYA -->
                <div class="site-form" id="site-form-chhaya">
                <div class="card">
                    <div class="field">
                        <label>Site type line</label>
                        <input type="text" id="c-chhaya-type">
                        <div class="hint">e.g. "RV / Tent Site &middot; Sleeps 6 &middot; Vehicles under 24 m"</div>
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <textarea id="c-chhaya-desc" rows="3"></textarea>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>Size</label>
                            <input type="text" id="c-chhaya-size" placeholder="e.g. 500 m²">
                        </div>
                        <div class="field">
                            <label>Beds / Setup</label>
                            <input type="text" id="c-chhaya-beds" placeholder="e.g. BYO tent / swag">
                        </div>
                        <div class="field">
                            <label>Smoking</label>
                            <select id="c-chhaya-smoking">
                                <option value="no">No smoking</option>
                                <option value="outdoors">Outdoors only</option>
                                <option value="yes">Smoking allowed</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label>Highlight Tags</label>
                        <div class="hint" style="margin-bottom:0.4rem">Quick feature tags shown on the booking card</div>
                        <div class="amenity-tags" id="amenities-chhaya"></div>
                        <div class="amenity-add">
                            <input type="text" id="amenity-input-chhaya" placeholder="Add tag..." onkeydown="if(event.key==='Enter'){addAmenity('chhaya');event.preventDefault()}">
                            <button class="btn btn-secondary btn-sm" onclick="addAmenity('chhaya')">Add</button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Amenity Categories</label>
                        <div class="hint" style="margin-bottom:0.4rem">Detailed amenities grouped by category (e.g. Facilities, View)</div>
                        <div id="amenity-cats-chhaya"></div>
                        <button class="btn btn-secondary btn-sm" onclick="addAmenityCategory('chhaya')" style="margin-top:0.5rem">+ Add Category</button>
                    </div>
                    <div class="field">
                        <label>Photos &amp; Videos</label>
                        <div class="upload-zone" id="upload-zone-chhaya" onclick="document.getElementById('file-chhaya').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Click to upload or drag & drop</span>
                            <input type="file" id="file-chhaya" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" multiple style="display:none" onchange="handleFileSelect('chhaya', this.files)">
                        </div>
                        <div class="upload-progress" id="progress-chhaya"></div>
                        <div class="image-grid" id="images-chhaya"></div>
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('content-chhaya')">Save</button>
                        <span class="save-msg" id="content-chhaya-msg"></span>
                    </div>
                </div>
                </div>

            </div>

            <!-- Rules & Policies sub-panel -->
            <div class="sub-panel" id="subpanel-rules">
                <div class="panel-desc">Manage campground rules and booking terms &amp; conditions.</div>

                <div class="card" style="max-width:900px">
                    <div class="card-title">Campground Rules</div>
                    <div style="font-size:0.82rem;color:var(--color-stone);margin-bottom:0.75rem">Rules shown at the bottom of the campsites booking page.</div>

                    <div id="rules-list"></div>

                    <div class="add-row">
                        <input type="text" id="rule-text" placeholder="New rule..." style="flex:1">
                        <button class="btn btn-secondary" onclick="addRule()" style="padding:0.5rem 1rem">Add</button>
                    </div>

                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('rules')">Save Rules</button>
                        <span class="save-msg" id="rules-msg"></span>
                    </div>
                </div>

                <div class="card" style="max-width:900px;margin-top:1.5rem">
                    <div class="card-title">Terms &amp; Conditions</div>
                    <div style="font-size:0.82rem;color:var(--color-stone);margin-bottom:0.75rem">Displayed on the booking page. Guests must agree before completing their booking.</div>
                    <div class="field">
                        <label>Check-in / Check-out times</label>
                        <div class="field-row">
                            <div class="field">
                                <input type="text" id="c-checkin-time" placeholder="e.g. 3:00 PM">
                            </div>
                            <div class="field">
                                <input type="text" id="c-checkout-time" placeholder="e.g. 10:00 AM">
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label>Terms &amp; Conditions text</label>
                        <div class="hint" style="margin-bottom:0.4rem">Full T&amp;C displayed to guests. Use blank lines to separate paragraphs. Section headings will be auto-formatted if they start with a number and period (e.g. "1. Booking and Payment").</div>
                        <textarea id="c-terms" rows="18" style="font-size:0.85rem;line-height:1.6"></textarea>
                    </div>

                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('policies')">Save Policies</button>
                        <span class="save-msg" id="policies-msg"></span>
                    </div>
                </div>
            </div>

            <!-- Pricing & Promos sub-panel -->
            <div class="sub-panel" id="subpanel-pricing">
                <div class="panel-desc">Manage per-site rates, rate plans, surcharges, promo codes, and booking add-ons.</div>

                <!-- Site pricing selector -->
                <div class="section-heading">Site Pricing</div>
                <div class="section-desc">Select a site to edit its nightly rates.</div>

                <div class="site-selector" id="pricing-site-selector">
                    <button class="site-sel-btn active" data-psite="garden-view" onclick="selectPricingSite('garden-view')">Garden View Room<span class="sel-meta" id="psel-meta-garden-view"></span></button>
                    <button class="site-sel-btn" data-psite="mountain-view" onclick="selectPricingSite('mountain-view')">Mountain View Room<span class="sel-meta" id="psel-meta-mountain-view"></span></button>
                    <button class="site-sel-btn" data-psite="suite" onclick="selectPricingSite('suite')">Suite<span class="sel-meta" id="psel-meta-suite"></span></button>
                    <button class="site-sel-btn" data-psite="samavas" onclick="selectPricingSite('samavas')">Samavas<span class="sel-meta" id="psel-meta-samavas"></span></button>
                    <button class="site-sel-btn" data-psite="chhaya" onclick="selectPricingSite('chhaya')">Chhaya<span class="sel-meta" id="psel-meta-chhaya"></span></button>
                </div>

                <!-- Per-site pricing forms -->
                <div class="site-form active" id="price-form-garden-view">
                <div class="card" style="max-width:500px">
                    <div class="card-title">GARDEN VIEW ROOM</div>
                    <div class="field">
                        <label>Base price per night</label>
                        <input type="number" id="p-garden-view-base" min="0" step="1">
                        <div class="hint">Standard weeknight rate for 1-2 guests</div>
                    </div>
                    <div class="field">
                        <label>Extra guest fee (per person per night)</label>
                        <input type="number" id="p-garden-view-extra" min="0" step="1">
                    </div>
                    <div class="field">
                        <label>Maximum guests</label>
                        <input type="number" id="p-garden-view-max" min="1" max="50" step="1">
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('pricing-garden-view')">Save</button>
                        <span class="save-msg" id="pricing-garden-view-msg"></span>
                    </div>
                </div>
                </div>

                <div class="site-form" id="price-form-mountain-view">
                <div class="card" style="max-width:500px">
                    <div class="card-title">MOUNTAIN VIEW ROOM</div>
                    <div class="field">
                        <label>Base price per night</label>
                        <input type="number" id="p-mountain-view-base" min="0" step="1">
                        <div class="hint">Standard weeknight rate for 1-2 guests</div>
                    </div>
                    <div class="field">
                        <label>Extra guest fee (per person per night)</label>
                        <input type="number" id="p-mountain-view-extra" min="0" step="1">
                    </div>
                    <div class="field">
                        <label>Maximum guests</label>
                        <input type="number" id="p-mountain-view-max" min="1" max="50" step="1">
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('pricing-mountain-view')">Save</button>
                        <span class="save-msg" id="pricing-mountain-view-msg"></span>
                    </div>
                </div>
                </div>

                <div class="site-form" id="price-form-suite">
                <div class="card" style="max-width:500px">
                    <div class="card-title">SUITE WITH GARDEN VIEW</div>
                    <div class="field">
                        <label>Base price per night</label>
                        <input type="number" id="p-suite-base" min="0" step="1">
                        <div class="hint">Standard weeknight rate for 1-2 guests</div>
                    </div>
                    <div class="field">
                        <label>Extra guest fee (per person per night)</label>
                        <input type="number" id="p-suite-extra" min="0" step="1">
                    </div>
                    <div class="field">
                        <label>Maximum guests</label>
                        <input type="number" id="p-suite-max" min="1" max="50" step="1">
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('pricing-suite')">Save</button>
                        <span class="save-msg" id="pricing-suite-msg"></span>
                    </div>
                </div>
                </div>

                <div class="site-form" id="price-form-samavas">
                <div class="card" style="max-width:500px">
                    <div class="card-title">SAMAVAS</div>
                    <div class="field">
                        <label>Base price per night (1-2 guests)</label>
                        <input type="number" id="p-samavas-base" min="0" step="1">
                        <div class="hint">Shown as "from AU$XX / night" on the site</div>
                    </div>
                    <div class="field">
                        <label>Extra guest fee (per person per night)</label>
                        <input type="number" id="p-samavas-extra" min="0" step="1">
                    </div>
                    <div class="field">
                        <label>Maximum guests</label>
                        <input type="number" id="p-samavas-max" min="1" max="50" step="1">
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('pricing-samavas')">Save</button>
                        <span class="save-msg" id="pricing-samavas-msg"></span>
                    </div>
                </div>
                </div>

                <div class="site-form" id="price-form-chhaya">
                <div class="card" style="max-width:500px">
                    <div class="card-title">CHHAYA</div>
                    <div class="field">
                        <label>Base price per night (1-2 guests)</label>
                        <input type="number" id="p-chhaya-base" min="0" step="1">
                        <div class="hint">Shown as "from AU$XX / night" on the site</div>
                    </div>
                    <div class="field">
                        <label>Extra guest fee (per person per night)</label>
                        <input type="number" id="p-chhaya-extra" min="0" step="1">
                    </div>
                    <div class="field">
                        <label>Maximum guests</label>
                        <input type="number" id="p-chhaya-max" min="1" max="50" step="1">
                    </div>
                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('pricing-chhaya')">Save</button>
                        <span class="save-msg" id="pricing-chhaya-msg"></span>
                    </div>
                </div>
                </div>

                <!-- ==================== RATE PLANS ==================== -->
                <hr class="section-divider">
                <div class="section-heading">Rate Plans</div>
                <div class="section-desc">Configure the rate options guests see when booking. These apply to all sites.</div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">Flexible Rate</div>
                        <div style="font-size:0.82rem;color:var(--color-stone);margin-bottom:0.75rem;line-height:1.6">Guests can cancel for free up to the cutoff date. After that, the booking is non-refundable.</div>
                        <div class="field">
                            <label>Free cancellation cutoff (days before check-in)</label>
                            <input type="number" id="p-cancellation-days" min="1" max="90" step="1" value="14">
                            <div class="hint">e.g. 14 = guests can cancel free up to 14 days before arrival</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Non-Refundable Rate</div>
                        <div style="font-size:0.82rem;color:var(--color-stone);margin-bottom:0.75rem;line-height:1.6">A discounted rate for guests who commit to a non-refundable booking. Cannot be cancelled or amended.</div>
                        <div class="field">
                            <label style="display:flex;align-items:center;gap:0.5rem;text-transform:none;font-size:0.85rem;letter-spacing:0">
                                <input type="checkbox" id="p-nonrefundable-enabled" style="width:auto;margin:0;padding:0" onchange="toggleNonRefundableFields()">
                                Enable non-refundable rate
                            </label>
                        </div>
                        <div id="nonrefundable-fields">
                            <div class="field">
                                <label>Discount %</label>
                                <input type="number" id="p-nonrefundable-discount" min="1" max="50" step="1" value="10">
                                <div class="hint">e.g. 10% off = AU$90 becomes AU$81/night</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="save-bar">
                    <button class="btn btn-primary" onclick="saveConfig('rateplans')">Save Rate Plans</button>
                    <span class="save-msg" id="rateplans-msg"></span>
                </div>

                <!-- ==================== SURCHARGES ==================== -->
                <hr class="section-divider">
                <div class="section-heading">Surcharges</div>
                <div class="section-desc">Weekend and holiday markups applied to room rates only. Campsites use flat rates.</div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">Weekend &amp; Holiday Rates</div>
                        <div class="field">
                            <label>Weekend markup % (Fri &amp; Sat nights)</label>
                            <input type="number" id="p-weekend-markup" min="0" max="100" step="1" value="20">
                            <div class="hint">e.g. 20% on an AU$85 room = AU$102/night</div>
                        </div>
                        <div class="field">
                            <label>Public holiday markup %</label>
                            <input type="number" id="p-holiday-markup" min="0" max="100" step="1" value="25">
                            <div class="hint">Holiday takes precedence if both apply</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">OTA Rate Comparison</div>
                        <div class="field">
                            <label>OTA markup % (Booking.com, Expedia, etc.)</label>
                            <input type="number" id="p-ota-markup" min="0" max="50" step="1" value="15">
                            <div class="hint">For reference only — shows what the equivalent OTA rate would be</div>
                        </div>
                        <div id="ota-comparison" style="margin-top:0.75rem"></div>
                    </div>
                </div>

                <div class="card" style="max-width:250px;margin-top:1.25rem">
                    <div class="card-title">Currency</div>
                    <div class="field">
                        <label>Display currency</label>
                        <select id="p-currency">
                            <option value="AUD">AUD (AU$)</option>
                            <option value="USD">USD (US$)</option>
                            <option value="EUR">EUR (&euro;)</option>
                            <option value="GBP">GBP (&pound;)</option>
                        </select>
                    </div>
                </div>

                <div class="save-bar">
                    <button class="btn btn-primary" onclick="saveConfig('surcharges')">Save Surcharges</button>
                    <span class="save-msg" id="surcharges-msg"></span>
                </div>

                <!-- ==================== PROMO CODES ==================== -->
                <hr class="section-divider">
                <div class="section-heading">Promo Codes</div>
                <div class="section-desc">Discount codes that guests can use when booking.</div>

                <div class="card" style="max-width:700px">
                    <div class="card-title">Active Codes</div>
                    <div id="promo-list"></div>

                    <div class="add-row">
                        <input type="text" id="promo-code" placeholder="Code (e.g. WELCOME10)" style="flex:1;min-width:140px;text-transform:uppercase">
                        <select id="promo-type" style="width:120px">
                            <option value="percent">Percentage %</option>
                            <option value="fixed">Fixed amount $</option>
                        </select>
                        <input type="number" id="promo-value" placeholder="Value" min="0" step="1" style="width:80px">
                        <button class="btn btn-secondary" onclick="addPromo()" style="padding:0.5rem 1rem">Add</button>
                    </div>

                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('promos')">Save Promo Codes</button>
                        <span class="save-msg" id="promos-msg"></span>
                    </div>
                </div>

                <!-- ==================== BOOKING ADD-ONS ==================== -->
                <hr class="section-divider">
                <div class="section-heading">Booking Add-ons</div>
                <div class="section-desc">Optional extras guests can add when booking (e.g. washing, airport transfers).</div>

                <div class="card" style="max-width:700px">
                    <div class="card-title">Active Add-ons</div>
                    <div id="addons-admin-list"></div>

                    <div class="add-row" style="flex-wrap:wrap">
                        <input type="text" id="addon-new-name" placeholder="Name (e.g. Washing)" style="flex:1;min-width:140px">
                        <input type="number" id="addon-new-price" placeholder="Price" min="0" step="1" style="width:80px">
                        <input type="text" id="addon-new-desc" placeholder="Description (optional)" style="flex:2;min-width:180px">
                        <button class="btn btn-secondary" onclick="addAddon()" style="padding:0.5rem 1rem">Add</button>
                    </div>

                    <div class="save-bar">
                        <button class="btn btn-primary" onclick="saveConfig('addons')">Save Add-ons</button>
                        <span class="save-msg" id="addons-msg"></span>
                    </div>
                </div>
            </div>

        </div>

        <!-- VIATOR PANEL -->
        <div class="tab-panel" id="panel-viator">
            <div class="panel-desc">Manage Viator affiliate experiences shown on the homepage and explore pages. Add tour links with images to earn commission when guests book.</div>

            <div class="card" style="max-width:900px">
                <div class="card-title">Experiences</div>

                <div id="experiences-admin-list"></div>

                <div class="add-row" style="flex-wrap:wrap;gap:0.5rem;margin-top:1rem">
                    <input type="text" id="exp-new-name" placeholder="Experience name" style="flex:1;min-width:180px">
                    <input type="text" id="exp-new-desc" placeholder="Short description" style="flex:2;min-width:180px">
                </div>
                <div class="add-row" style="flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem">
                    <input type="text" id="exp-new-image" placeholder="Image URL (from Viator)" style="flex:1;min-width:200px">
                    <input type="text" id="exp-new-url" placeholder="Affiliate URL" style="flex:1;min-width:200px">
                    <button class="btn btn-secondary" onclick="addExperience()" style="padding:0.5rem 1rem">Add</button>
                </div>

                <div class="save-bar">
                    <button class="btn btn-primary" onclick="saveConfig('viator')">Save Experiences</button>
                    <span class="save-msg" id="viator-msg"></span>
                </div>
            </div>

            <div class="card" style="max-width:900px;margin-top:1.5rem">
                <div class="card-title">How It Works</div>
                <div style="font-size:0.85rem;color:var(--color-charcoal);line-height:1.8">
                    <p>1. Go to your <a href="https://www.viator.com/partnerResources/home" target="_blank" style="color:var(--color-forest)">Viator Partner Dashboard</a> and create affiliate links for Cairns tours.</p>
                    <p style="margin-top:0.5rem">2. For each tour, copy the <strong>affiliate URL</strong> and the <strong>tour image URL</strong> (right-click the tour image on Viator and copy image address).</p>
                    <p style="margin-top:0.5rem">3. Add the experience above with a short name and description. Enabled experiences appear on your homepage.</p>
                    <p style="margin-top:0.5rem">4. You earn <strong>8% commission</strong> on completed bookings made through your links.</p>
                </div>
            </div>
        </div>

        <!-- GALLERY PANEL -->
        <div class="tab-panel" id="panel-gallery">
            <div class="section-desc">Upload images and videos to your public gallery page. Max 50 items. Images: 5MB (JPEG, PNG, WebP). Videos: 50MB (MP4, WebM, MOV).</div>

            <div class="card" style="max-width:900px">
                <div class="card-title">Upload Media</div>
                <div class="upload-zone" id="upload-zone-gallery" onclick="document.getElementById('file-gallery').click()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Click to upload images or videos (or drag &amp; drop)</span>
                    <input type="file" id="file-gallery" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" multiple style="display:none" onchange="handleGalleryUpload(this.files)">
                </div>
                <div class="upload-progress" id="progress-gallery"></div>
            </div>

            <div class="card" style="max-width:900px">
                <div class="card-title">Gallery Items <span id="gallery-count" style="font-weight:400;color:var(--color-stone);font-size:0.8rem"></span></div>
                <div class="image-grid gallery-grid" id="gallery-grid"></div>
            </div>

            <div class="card" style="max-width:900px;margin-top:1.5rem">
                <div class="card-title">Homepage Background</div>
                <div class="section-desc" style="margin-bottom:0.75rem">Replace the homepage hero background. Accepts images (5MB) or videos (50MB). Videos will autoplay muted and loop.</div>
                <div id="homepage-bg-preview" style="margin-bottom:0.75rem"></div>
                <div class="upload-zone" id="upload-zone-homebg" onclick="document.getElementById('file-homebg').click()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Upload new background image or video</span>
                    <input type="file" id="file-homebg" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadHomepageBg(this.files[0])">
                </div>
                <div class="upload-progress" id="progress-homebg"></div>
            </div>

            <div class="card" style="max-width:900px;margin-top:1.5rem">
                <div class="card-title">Camping Experience Background</div>
                <div class="section-desc" style="margin-bottom:0.75rem">Replace the background of the "Slow Down. Breathe. Reconnect." section. Accepts images (5MB) or videos (50MB). The default SVG illustration is used when no custom background is set.</div>
                <div id="campsite-bg-preview" style="margin-bottom:0.75rem"></div>
                <div class="upload-zone" id="upload-zone-campsitebg" onclick="document.getElementById('file-campsitebg').click()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Upload background image or video</span>
                    <input type="file" id="file-campsitebg" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadCampsiteBg(this.files[0])">
                </div>
                <div class="upload-progress" id="progress-campsitebg"></div>
            </div>

            <div class="card" style="max-width:900px;margin-top:1.5rem">
                <div class="card-title">Kitchen Image</div>
                <div class="section-desc" style="margin-bottom:0.75rem">Upload a photo of your on-site kitchen for the Local Essentials page. Accepts images (5MB) or videos (50MB).</div>
                <div class="explore-slot-card" data-slot="kitchen">
                    <div class="explore-slot-header">
                        <strong>Essentials &mdash; On-site Kitchen</strong>
                        <span class="explore-slot-status" id="explore-status-kitchen"></span>
                    </div>
                    <div class="explore-slot-preview" id="explore-preview-kitchen"></div>
                    <div class="explore-slot-actions">
                        <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-kitchen').click()">Upload</button>
                        <input type="file" id="file-explore-kitchen" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('kitchen', this.files[0])">
                        <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-kitchen" onclick="deleteExploreSlot('kitchen')">Remove</button>
                    </div>
                </div>
            </div>

            <div class="card" style="max-width:900px;margin-top:1.5rem">
                <div class="card-title" style="cursor:pointer;display:flex;align-items:center;justify-content:space-between" onclick="toggleExploreSection()">
                    Explore Page &mdash; Section Images
                    <svg id="explore-collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition:transform 0.3s ease;transform:rotate(180deg)"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div id="explore-section-body" style="overflow:hidden;transition:max-height 0.4s ease,opacity 0.3s ease;max-height:0;opacity:0">
                <div class="section-desc" style="margin-bottom:1rem;margin-top:0.5rem">Upload images or videos for each section on the Explore page and the homepage neighbourhood panel. Accepts images (5MB) or videos (50MB).</div>

                <div id="explore-slots-grid" style="display:grid;grid-template-columns:1fr;gap:1rem">

                    <div class="explore-slot-card" data-slot="neighbourhood">
                        <div class="explore-slot-header">
                            <strong>Homepage &mdash; Neighbourhood Image</strong>
                            <span class="explore-slot-status" id="explore-status-neighbourhood"></span>
                        </div>
                        <div class="explore-slot-preview" id="explore-preview-neighbourhood"></div>
                        <div class="explore-slot-actions">
                            <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-neighbourhood').click()">Upload</button>
                            <input type="file" id="file-explore-neighbourhood" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('neighbourhood', this.files[0])">
                            <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-neighbourhood" onclick="deleteExploreSlot('neighbourhood')">Remove</button>
                        </div>
                    </div>

                    <div class="explore-slot-card" data-slot="reef">
                        <div class="explore-slot-header">
                            <strong>Explore &mdash; Great Barrier Reef</strong>
                            <span class="explore-slot-status" id="explore-status-reef"></span>
                        </div>
                        <div class="explore-slot-preview" id="explore-preview-reef"></div>
                        <div class="explore-slot-actions">
                            <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-reef').click()">Upload</button>
                            <input type="file" id="file-explore-reef" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('reef', this.files[0])">
                            <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-reef" onclick="deleteExploreSlot('reef')">Remove</button>
                        </div>
                    </div>

                    <div class="explore-slot-card" data-slot="rainforest">
                        <div class="explore-slot-header">
                            <strong>Explore &mdash; Daintree Rainforest</strong>
                            <span class="explore-slot-status" id="explore-status-rainforest"></span>
                        </div>
                        <div class="explore-slot-preview" id="explore-preview-rainforest"></div>
                        <div class="explore-slot-actions">
                            <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-rainforest').click()">Upload</button>
                            <input type="file" id="file-explore-rainforest" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('rainforest', this.files[0])">
                            <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-rainforest" onclick="deleteExploreSlot('rainforest')">Remove</button>
                        </div>
                    </div>

                    <div class="explore-slot-card" data-slot="waterfall">
                        <div class="explore-slot-header">
                            <strong>Explore &mdash; Waterfalls &amp; Swimming Holes</strong>
                            <span class="explore-slot-status" id="explore-status-waterfall"></span>
                        </div>
                        <div class="explore-slot-preview" id="explore-preview-waterfall"></div>
                        <div class="explore-slot-actions">
                            <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-waterfall').click()">Upload</button>
                            <input type="file" id="file-explore-waterfall" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('waterfall', this.files[0])">
                            <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-waterfall" onclick="deleteExploreSlot('waterfall')">Remove</button>
                        </div>
                    </div>

                    <div class="explore-slot-card" data-slot="tablelands">
                        <div class="explore-slot-header">
                            <strong>Explore &mdash; Atherton Tablelands</strong>
                            <span class="explore-slot-status" id="explore-status-tablelands"></span>
                        </div>
                        <div class="explore-slot-preview" id="explore-preview-tablelands"></div>
                        <div class="explore-slot-actions">
                            <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-tablelands').click()">Upload</button>
                            <input type="file" id="file-explore-tablelands" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('tablelands', this.files[0])">
                            <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-tablelands" onclick="deleteExploreSlot('tablelands')">Remove</button>
                        </div>
                    </div>

                    <div class="explore-slot-card" data-slot="beach">
                        <div class="explore-slot-header">
                            <strong>Explore &mdash; Beaches &amp; Islands</strong>
                            <span class="explore-slot-status" id="explore-status-beach"></span>
                        </div>
                        <div class="explore-slot-preview" id="explore-preview-beach"></div>
                        <div class="explore-slot-actions">
                            <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-beach').click()">Upload</button>
                            <input type="file" id="file-explore-beach" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('beach', this.files[0])">
                            <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-beach" onclick="deleteExploreSlot('beach')">Remove</button>
                        </div>
                    </div>

                    <div class="explore-slot-card" data-slot="cairns">
                        <div class="explore-slot-header">
                            <strong>Explore &mdash; Cairns City</strong>
                            <span class="explore-slot-status" id="explore-status-cairns"></span>
                        </div>
                        <div class="explore-slot-preview" id="explore-preview-cairns"></div>
                        <div class="explore-slot-actions">
                            <button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="document.getElementById('file-explore-cairns').click()">Upload</button>
                            <input type="file" id="file-explore-cairns" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm,video/quicktime" style="display:none" onchange="uploadExploreSlot('cairns', this.files[0])">
                            <button class="btn btn-danger" style="padding:0.35rem 0.85rem;font-size:0.78rem;display:none" id="explore-del-cairns" onclick="deleteExploreSlot('cairns')">Remove</button>
                        </div>
                    </div>

                </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS PANEL -->
        <div class="tab-panel" id="panel-settings">
            <div class="panel-desc">Manage payments, email notifications, and dashboard password.</div>

            <div class="card" style="max-width:650px;margin-bottom:1.5rem">
                <div class="card-title">Email Notifications</div>
                <p style="font-size:0.8rem;color:var(--color-stone);margin-bottom:1rem;line-height:1.5">
                    Receive an email when a new booking is submitted. Uses <a href="https://resend.com" target="_blank" style="color:var(--color-forest)">Resend</a> to send emails (free tier: 100 emails/day).
                </p>

                <div class="field">
                    <label style="display:flex;align-items:center;gap:0.5rem;text-transform:none;font-size:0.85rem;letter-spacing:0">
                        <input type="checkbox" id="notif-enabled" style="width:auto;margin:0;padding:0">
                        Enable email notifications
                    </label>
                </div>

                <div class="field">
                    <label>Notification email</label>
                    <input type="email" id="notif-email" placeholder="your@email.com">
                    <div class="hint">Where booking notifications will be sent</div>
                </div>

                <div class="field">
                    <label>Resend API key</label>
                    <input type="password" id="notif-api-key" placeholder="re_xxxxxxxxx...">
                    <div class="hint">Get your API key from <a href="https://resend.com/api-keys" target="_blank" style="color:var(--color-forest)">resend.com/api-keys</a></div>
                </div>

                <div class="field">
                    <label>From email (optional)</label>
                    <input type="text" id="notif-from-email" placeholder="bookings@yourdomain.com">
                    <div class="hint">Requires a verified domain in Resend. Leave blank to use Resend's default.</div>
                </div>

                <div class="save-bar" style="margin-top:1rem">
                    <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Notifications</button>
                    <button class="btn btn-secondary" onclick="sendTestEmail()" style="margin-left:0.5rem">Send Test Email</button>
                    <span class="save-msg" id="notif-msg"></span>
                </div>
            </div>

            <div class="card" style="max-width:650px;margin-bottom:1.5rem">
                <div class="card-title">Stripe Payments</div>
                <p style="font-size:0.8rem;color:var(--color-stone);margin-bottom:1rem;line-height:1.5">
                    Collect payments when guests book. Uses <a href="https://stripe.com" target="_blank" style="color:var(--color-forest)">Stripe</a> Checkout — guests are redirected to a secure Stripe-hosted payment page.
                </p>

                <div class="field">
                    <label style="display:flex;align-items:center;gap:0.5rem;text-transform:none;font-size:0.85rem;letter-spacing:0">
                        <input type="checkbox" id="stripe-enabled" style="width:auto;margin:0;padding:0">
                        Enable Stripe payments
                    </label>
                </div>

                <div class="field">
                    <label>Secret key</label>
                    <input type="password" id="stripe-secret-key" placeholder="sk_live_... or sk_test_...">
                    <div class="hint">Find this in your <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color:var(--color-forest)">Stripe Dashboard</a> &rarr; Developers &rarr; API keys</div>
                </div>

                <div class="field">
                    <label>Webhook signing secret</label>
                    <input type="password" id="stripe-webhook-secret" placeholder="whsec_...">
                    <div class="hint">
                        Create a webhook in Stripe pointing to:<br>
                        <code style="font-size:0.8rem;background:var(--color-cream);padding:3px 8px;border:1px solid var(--color-light-stone);word-break:break-all">https://ahana-ical-proxy.ahanahillside.workers.dev/stripe-webhook</code><br>
                        Listen for the <strong>checkout.session.completed</strong> event.
                    </div>
                </div>

                <div class="save-bar" style="margin-top:1rem">
                    <button class="btn btn-primary" onclick="saveStripeSettings()">Save Stripe Settings</button>
                    <span class="save-msg" id="stripe-msg"></span>
                </div>
            </div>

            <div class="card" style="max-width:650px">
                <div class="card-title">Change Password</div>
                <div class="field">
                    <label>New password</label>
                    <input type="password" id="new-password" placeholder="Min. 6 characters" minlength="6">
                </div>
                <div class="field">
                    <label>Confirm new password</label>
                    <input type="password" id="confirm-password" placeholder="Re-enter password">
                </div>
                <div class="save-bar" style="margin-top:1rem">
                    <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
                    <span class="save-msg" id="settings-msg"></span>
                </div>
            </div>
        </div>

    </div>
    </div><!-- /main-content -->
</div>

<script>
    const WORKER_URL = 'https://ahana-ical-proxy.ahanahillside.workers.dev';
    let authToken = sessionStorage.getItem('ahana-token') || '';
    let siteConfig = null;

    // --- Auth ---
    async function handleLogin(e) {
        e.preventDefault();
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');
        errorEl.classList.remove('show');

        try {
            const res = await fetch(WORKER_URL + '/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password }),
            });
            const data = await res.json();
            if (data.success) {
                authToken = data.token;
                sessionStorage.setItem('ahana-token', authToken);
                showDashboard();
            } else {
                errorEl.textContent = res.status === 429
                    ? 'Too many failed attempts. Try again in 15 minutes.'
                    : 'Invalid password';
                errorEl.classList.add('show');
            }
        } catch (err) {
            errorEl.textContent = 'Connection error. Is the worker deployed?';
            errorEl.classList.add('show');
        }
    }

    function handleLogout() {
        authToken = '';
        sessionStorage.removeItem('ahana-token');
        document.getElementById('dashboard').classList.remove('show');
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('login-password').value = '';
    }

    async function showDashboard() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').classList.add('show');
        loadConfig();
        loadMessages();
        loadBookings();
        loadImages();
        loadBlockedDates();
        loadNotificationSettings();
        loadStripeSettings();
        loadGalleryItems();
        loadHomepageBg();
        loadCampsiteBg();
        loadExploreSlots();
    }

    // --- Config ---
    async function loadConfig() {
        try {
            const res = await fetch(WORKER_URL + '/config');
            siteConfig = await res.json();
        } catch (err) {
            siteConfig = null;
            showMsg('pricing', 'Could not load config from worker', 'error');
            return;
        }
        populateFields();
        updateDashStats();
    }

    function populateFields() {
        if (!siteConfig) return;
        const c = siteConfig;

        // Pricing
        document.getElementById('p-samavas-base').value = c.samavas?.basePrice ?? 66;
        document.getElementById('p-samavas-extra').value = c.samavas?.extraGuestFee ?? 15;
        document.getElementById('p-samavas-max').value = c.samavas?.maxGuests ?? 20;
        document.getElementById('p-chhaya-base').value = c.chhaya?.basePrice ?? 60;
        document.getElementById('p-chhaya-extra').value = c.chhaya?.extraGuestFee ?? 10;
        document.getElementById('p-chhaya-max').value = c.chhaya?.maxGuests ?? 20;
        document.getElementById('p-mountain-view-base').value = c['mountain-view']?.basePrice ?? 0;
        document.getElementById('p-mountain-view-extra').value = c['mountain-view']?.extraGuestFee ?? 0;
        document.getElementById('p-mountain-view-max').value = c['mountain-view']?.maxGuests ?? 4;
        document.getElementById('p-garden-view-base').value = c['garden-view']?.basePrice ?? 0;
        document.getElementById('p-garden-view-extra').value = c['garden-view']?.extraGuestFee ?? 0;
        document.getElementById('p-garden-view-max').value = c['garden-view']?.maxGuests ?? 4;
        document.getElementById('p-suite-base').value = c['suite']?.basePrice ?? 0;
        document.getElementById('p-suite-extra').value = c['suite']?.extraGuestFee ?? 0;
        document.getElementById('p-suite-max').value = c['suite']?.maxGuests ?? 4;
        document.getElementById('p-currency').value = c.currency || 'AUD';

        // Rate policies
        document.getElementById('p-weekend-markup').value = c.weekendMarkup ?? 20;
        document.getElementById('p-holiday-markup').value = c.holidayMarkup ?? 25;
        document.getElementById('p-cancellation-days').value = c.cancellationDays ?? 14;
        document.getElementById('p-nonrefundable-discount').value = c.nonRefundableDiscount ?? 10;
        document.getElementById('p-ota-markup').value = c.otaMarkup ?? 15;

        // Non-refundable toggle
        var nrEnabled = c.nonRefundableEnabled !== false; // default on for backwards compat
        document.getElementById('p-nonrefundable-enabled').checked = nrEnabled;
        toggleNonRefundableFields();

        updateOtaComparison();
        updatePricingSelectorMeta();

        // Content — all sites
        ['samavas', 'chhaya', 'mountain-view', 'garden-view', 'suite'].forEach(function(site) {
            var key = site;
            var cfg = c[key] || {};
            document.getElementById('c-' + site + '-type').value = cfg.type || '';
            document.getElementById('c-' + site + '-desc').value = cfg.description || '';
            document.getElementById('c-' + site + '-size').value = cfg.size || '';
            document.getElementById('c-' + site + '-beds').value = cfg.beds || '';
            var smokingEl = document.getElementById('c-' + site + '-smoking');
            if (smokingEl) smokingEl.value = cfg.smoking || 'no';
            renderAmenities(site);
            renderAmenityCategories(site);
        });

        // Promo codes
        renderPromos();

        // Booking add-ons
        renderAddons();

        // Affiliate experiences
        renderExperiences();

        // Rules
        renderRules();

        // Policies
        document.getElementById('c-checkin-time').value = c.checkinTime || '3:00 PM';
        document.getElementById('c-checkout-time').value = c.checkoutTime || '10:00 AM';
        document.getElementById('c-terms').value = c.termsAndConditions || '';
    }

    function gatherConfig() {
        return {
            samavas: {
                name: 'SAMAVAS',
                type: document.getElementById('c-samavas-type').value,
                description: document.getElementById('c-samavas-desc').value,
                size: document.getElementById('c-samavas-size').value,
                beds: document.getElementById('c-samavas-beds').value,
                smoking: document.getElementById('c-samavas-smoking').value,
                amenities: (siteConfig.samavas && siteConfig.samavas.amenities) || [],
                amenityCategories: (siteConfig.samavas && siteConfig.samavas.amenityCategories) || [],
                basePrice: parseFloat(document.getElementById('p-samavas-base').value) || 0,
                extraGuestFee: parseFloat(document.getElementById('p-samavas-extra').value) || 0,
                maxGuests: parseInt(document.getElementById('p-samavas-max').value) || 20,
            },
            chhaya: {
                name: 'CHHAYA',
                type: document.getElementById('c-chhaya-type').value,
                description: document.getElementById('c-chhaya-desc').value,
                size: document.getElementById('c-chhaya-size').value,
                beds: document.getElementById('c-chhaya-beds').value,
                smoking: document.getElementById('c-chhaya-smoking').value,
                amenities: (siteConfig.chhaya && siteConfig.chhaya.amenities) || [],
                amenityCategories: (siteConfig.chhaya && siteConfig.chhaya.amenityCategories) || [],
                basePrice: parseFloat(document.getElementById('p-chhaya-base').value) || 0,
                extraGuestFee: parseFloat(document.getElementById('p-chhaya-extra').value) || 0,
                maxGuests: parseInt(document.getElementById('p-chhaya-max').value) || 20,
            },
            'mountain-view': {
                name: 'MOUNTAIN VIEW ROOM',
                type: document.getElementById('c-mountain-view-type').value,
                description: document.getElementById('c-mountain-view-desc').value,
                size: document.getElementById('c-mountain-view-size').value,
                beds: document.getElementById('c-mountain-view-beds').value,
                smoking: document.getElementById('c-mountain-view-smoking').value,
                amenities: (siteConfig['mountain-view'] && siteConfig['mountain-view'].amenities) || [],
                amenityCategories: (siteConfig['mountain-view'] && siteConfig['mountain-view'].amenityCategories) || [],
                basePrice: parseFloat(document.getElementById('p-mountain-view-base').value) || 0,
                extraGuestFee: parseFloat(document.getElementById('p-mountain-view-extra').value) || 0,
                maxGuests: parseInt(document.getElementById('p-mountain-view-max').value) || 4,
            },
            'garden-view': {
                name: 'GARDEN VIEW ROOM',
                type: document.getElementById('c-garden-view-type').value,
                description: document.getElementById('c-garden-view-desc').value,
                size: document.getElementById('c-garden-view-size').value,
                beds: document.getElementById('c-garden-view-beds').value,
                smoking: document.getElementById('c-garden-view-smoking').value,
                amenities: (siteConfig['garden-view'] && siteConfig['garden-view'].amenities) || [],
                amenityCategories: (siteConfig['garden-view'] && siteConfig['garden-view'].amenityCategories) || [],
                basePrice: parseFloat(document.getElementById('p-garden-view-base').value) || 0,
                extraGuestFee: parseFloat(document.getElementById('p-garden-view-extra').value) || 0,
                maxGuests: parseInt(document.getElementById('p-garden-view-max').value) || 4,
            },
            'suite': {
                name: 'SUITE WITH GARDEN VIEW',
                type: document.getElementById('c-suite-type').value,
                description: document.getElementById('c-suite-desc').value,
                size: document.getElementById('c-suite-size').value,
                beds: document.getElementById('c-suite-beds').value,
                smoking: document.getElementById('c-suite-smoking').value,
                amenities: (siteConfig['suite'] && siteConfig['suite'].amenities) || [],
                amenityCategories: (siteConfig['suite'] && siteConfig['suite'].amenityCategories) || [],
                basePrice: parseFloat(document.getElementById('p-suite-base').value) || 0,
                extraGuestFee: parseFloat(document.getElementById('p-suite-extra').value) || 0,
                maxGuests: parseInt(document.getElementById('p-suite-max').value) || 4,
            },
            currency: document.getElementById('p-currency').value,
            promoCodes: siteConfig.promoCodes || {},
            bookingAddons: siteConfig.bookingAddons || [],
            experiences: siteConfig.experiences || [],
            rules: siteConfig.rules || [],
            checkinTime: document.getElementById('c-checkin-time').value || '3:00 PM',
            checkoutTime: document.getElementById('c-checkout-time').value || '10:00 AM',
            termsAndConditions: document.getElementById('c-terms').value || '',
            weekendMarkup: parseInt(document.getElementById('p-weekend-markup').value) || 0,
            holidayMarkup: parseInt(document.getElementById('p-holiday-markup').value) || 0,
            cancellationDays: parseInt(document.getElementById('p-cancellation-days').value) || 14,
            nonRefundableDiscount: parseInt(document.getElementById('p-nonrefundable-discount').value) || 0,
            nonRefundableEnabled: document.getElementById('p-nonrefundable-enabled').checked,
            otaMarkup: parseInt(document.getElementById('p-ota-markup').value) || 0,
        };
    }

    function updateOtaComparison() {
        const c = siteConfig || {};
        const otaPct = parseInt(document.getElementById('p-ota-markup').value) || 15;
        const wkPct = parseInt(document.getElementById('p-weekend-markup').value) || 0;
        const rooms = [
            { key: 'mountain-view', name: 'Mountain View' },
            { key: 'garden-view', name: 'Garden View' },
            { key: 'suite', name: 'Suite' },
        ];
        const sym = 'AU$';
        let html = '<table style="width:100%;font-size:0.85rem;border-collapse:collapse">';
        html += '<tr style="border-bottom:1px solid #ddd"><th style="text-align:left;padding:0.3rem 0">Room</th><th style="text-align:right;padding:0.3rem 0.5rem">Direct</th><th style="text-align:right;padding:0.3rem 0.5rem">Weekend</th><th style="text-align:right;padding:0.3rem 0">OTA equiv.</th></tr>';
        rooms.forEach(function(r) {
            const base = parseFloat(document.getElementById('p-' + r.key + '-base').value) || 0;
            const wkRate = Math.round(base * (1 + wkPct / 100));
            const otaRate = Math.round(base * (1 + otaPct / 100));
            html += '<tr><td style="padding:0.25rem 0">' + r.name + '</td>';
            html += '<td style="text-align:right;padding:0.25rem 0.5rem">' + sym + base + '</td>';
            html += '<td style="text-align:right;padding:0.25rem 0.5rem">' + sym + wkRate + '</td>';
            html += '<td style="text-align:right;padding:0.25rem 0;color:var(--color-stone)">' + sym + otaRate + '</td></tr>';
        });
        html += '</table>';
        var el = document.getElementById('ota-comparison');
        if (el) el.innerHTML = html;
    }

    // Update OTA comparison on input change
    document.addEventListener('input', function(e) {
        if (e.target && (e.target.id === 'p-ota-markup' || e.target.id === 'p-weekend-markup'
            || e.target.id === 'p-mountain-view-base' || e.target.id === 'p-garden-view-base' || e.target.id === 'p-suite-base')) {
            updateOtaComparison();
        }
    });

    async function saveConfig(source) {
        siteConfig = gatherConfig();

        try {
            const res = await fetch(WORKER_URL + '/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify(siteConfig),
            });
            const data = await res.json();
            if (data.success) {
                showMsg(source, 'Saved successfully', 'success');
            } else if (data.error === 'Unauthorized') {
                showMsg(source, 'Session expired. Please log in again.', 'error');
            } else {
                showMsg(source, 'Error: ' + (data.error || 'Unknown'), 'error');
            }
        } catch (err) {
            showMsg(source, 'Connection error', 'error');
        }
    }

    async function changePassword() {
        const newPwd = document.getElementById('new-password').value;
        const confirmPwd = document.getElementById('confirm-password').value;

        if (newPwd.length < 6) {
            showMsg('settings', 'Password must be at least 6 characters', 'error');
            return;
        }
        if (newPwd !== confirmPwd) {
            showMsg('settings', 'Passwords do not match', 'error');
            return;
        }

        try {
            const res = await fetch(WORKER_URL + '/password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify({ newPassword: newPwd }),
            });
            const data = await res.json();
            if (data.success) {
                authToken = newPwd;
                sessionStorage.setItem('ahana-token', authToken);
                showMsg('settings', 'Password updated', 'success');
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } else {
                showMsg('settings', data.error || 'Failed to update', 'error');
            }
        } catch (err) {
            showMsg('settings', 'Connection error', 'error');
        }
    }

    // --- Stripe Settings ---
    async function loadStripeSettings() {
        try {
            const res = await fetch(WORKER_URL + '/stripe-settings', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            const s = data.settings || {};
            document.getElementById('stripe-enabled').checked = !!s.enabled;
            // Show masked keys as placeholders — never populate the actual value
            const skInput = document.getElementById('stripe-secret-key');
            const whInput = document.getElementById('stripe-webhook-secret');
            skInput.value = '';
            whInput.value = '';
            skInput.placeholder = s.maskedSecretKey || 'sk_live_... or sk_test_...';
            whInput.placeholder = s.maskedWebhookSecret || 'whsec_...';
            // Store whether keys exist so we can validate on save
            skInput.dataset.hasKey = s.hasSecretKey ? '1' : '';
            whInput.dataset.hasKey = s.hasWebhookSecret ? '1' : '';
        } catch (err) {}
    }

    async function saveStripeSettings() {
        const skInput = document.getElementById('stripe-secret-key');
        const whInput = document.getElementById('stripe-webhook-secret');
        const newSecretKey = skInput.value.trim();
        const newWebhookSecret = whInput.value.trim();
        const hasExistingKey = skInput.dataset.hasKey === '1';
        const enabled = document.getElementById('stripe-enabled').checked;

        if (enabled && !newSecretKey && !hasExistingKey) {
            showMsg('stripe', 'Please enter your Stripe secret key', 'error');
            return;
        }

        // Only send keys if user entered new ones
        const settings = { enabled };
        if (newSecretKey) settings.secretKey = newSecretKey;
        if (newWebhookSecret) settings.webhookSecret = newWebhookSecret;

        try {
            const res = await fetch(WORKER_URL + '/stripe-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify(settings),
            });
            const data = await res.json();
            if (data.success) {
                showMsg('stripe', 'Stripe settings saved', 'success');
                loadStripeSettings(); // Reload to show updated masked keys
            } else {
                showMsg('stripe', data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showMsg('stripe', 'Connection error', 'error');
        }
    }

    // --- Notification Settings ---
    async function loadNotificationSettings() {
        try {
            const res = await fetch(WORKER_URL + '/notification-settings', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            const s = data.settings || {};
            document.getElementById('notif-enabled').checked = !!s.enabled;
            document.getElementById('notif-email').value = s.email || '';
            document.getElementById('notif-from-email').value = s.fromEmail || '';
            // Show masked API key as placeholder — never populate the actual value
            const akInput = document.getElementById('notif-api-key');
            akInput.value = '';
            akInput.placeholder = s.maskedApiKey || 're_xxxxxxxxx...';
            akInput.dataset.hasKey = s.hasApiKey ? '1' : '';
        } catch (err) {}
    }

    async function saveNotificationSettings() {
        const akInput = document.getElementById('notif-api-key');
        const newApiKey = akInput.value.trim();
        const hasExistingKey = akInput.dataset.hasKey === '1';
        const enabled = document.getElementById('notif-enabled').checked;

        const settings = {
            enabled,
            email: document.getElementById('notif-email').value.trim(),
            fromEmail: document.getElementById('notif-from-email').value.trim(),
        };
        // Only send API key if user entered a new one
        if (newApiKey) settings.apiKey = newApiKey;

        if (settings.enabled && !settings.email) {
            showMsg('notif', 'Please enter a notification email address', 'error');
            return;
        }
        if (settings.enabled && !newApiKey && !hasExistingKey) {
            showMsg('notif', 'Please enter a Resend API key', 'error');
            return;
        }

        try {
            const res = await fetch(WORKER_URL + '/notification-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify(settings),
            });
            const data = await res.json();
            if (data.success) {
                showMsg('notif', 'Notification settings saved', 'success');
                loadNotificationSettings(); // Reload to show updated masked key
            } else {
                showMsg('notif', data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showMsg('notif', 'Connection error', 'error');
        }
    }

    async function sendTestEmail() {
        showMsg('notif', 'Sending test email...', 'success');
        try {
            const res = await fetch(WORKER_URL + '/test-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
            });
            const data = await res.json();
            if (data.success) {
                showMsg('notif', 'Test email sent! Check your inbox (and spam folder).', 'success');
            } else {
                showMsg('notif', 'Failed: ' + (data.detail || data.error), 'error');
            }
        } catch (err) {
            showMsg('notif', 'Connection error: ' + err.message, 'error');
        }
    }

    // --- Promo codes ---
    function renderPromos() {
        const container = document.getElementById('promo-list');
        const codes = siteConfig.promoCodes || {};
        const keys = Object.keys(codes);

        if (keys.length === 0) {
            container.innerHTML = '<div style="font-size:0.9rem;color:var(--color-stone);padding:0.5rem 0;">No promo codes yet.</div>';
            return;
        }

        container.innerHTML = keys.map(code => {
            const p = codes[code];
            const label = p.type === 'percent' ? p.value + '% off' : 'AU$' + p.value + ' off';
            return '<div class="list-item">'
                + '<div class="item-info"><span class="item-label">' + code + '</span> <span class="item-detail">' + label + '</span></div>'
                + '<button class="btn btn-danger" onclick="removePromo(\'' + code + '\')">Remove</button>'
                + '</div>';
        }).join('');
    }

    function addPromo() {
        const codeEl = document.getElementById('promo-code');
        const typeEl = document.getElementById('promo-type');
        const valueEl = document.getElementById('promo-value');

        const code = codeEl.value.trim().toUpperCase();
        const type = typeEl.value;
        const value = parseFloat(valueEl.value);

        if (!code || !value || value <= 0) return;

        if (!siteConfig.promoCodes) siteConfig.promoCodes = {};
        siteConfig.promoCodes[code] = { type, value };

        codeEl.value = '';
        valueEl.value = '';
        renderPromos();
    }

    function removePromo(code) {
        delete siteConfig.promoCodes[code];
        renderPromos();
    }

    // --- Booking Add-ons ---
    function renderAddons() {
        var container = document.getElementById('addons-admin-list');
        if (!container) return;
        var list = siteConfig.bookingAddons || [];
        if (list.length === 0) {
            container.innerHTML = '<div style="font-size:0.9rem;color:var(--color-stone);padding:0.5rem 0;">No add-ons yet.</div>';
            return;
        }
        container.innerHTML = list.map(function(a, i) {
            var sym = 'AU$';
            return '<div class="list-item" style="flex-wrap:wrap;gap:0.5rem">'
                + '<div class="item-info" style="flex:1;min-width:200px">'
                + '<strong>' + escapeHtml(a.name) + '</strong> — ' + sym + a.price
                + (a.description ? '<br><span style="font-size:0.8rem;color:var(--color-stone)">' + escapeHtml(a.description) + '</span>' : '')
                + '</div>'
                + '<div style="display:flex;gap:0.4rem;align-items:center">'
                + '<button class="btn btn-secondary" onclick="editAddon(' + i + ')" style="padding:0.3rem 0.6rem;font-size:0.8rem">Edit</button>'
                + '<label style="font-size:0.8rem;display:flex;align-items:center;gap:0.3rem;cursor:pointer"><input type="checkbox" onchange="toggleAddon(' + i + ')" ' + (a.enabled !== false ? 'checked' : '') + '> Enabled</label>'
                + '<button class="btn btn-danger" onclick="removeAddon(' + i + ')" style="padding:0.3rem 0.6rem">Remove</button>'
                + '</div></div>';
        }).join('');
    }

    function addAddon() {
        var name = document.getElementById('addon-new-name').value.trim();
        var price = parseFloat(document.getElementById('addon-new-price').value) || 0;
        var desc = document.getElementById('addon-new-desc').value.trim();
        if (!name) return;
        if (!siteConfig.bookingAddons) siteConfig.bookingAddons = [];
        var id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        // Ensure unique id
        var existing = siteConfig.bookingAddons.map(function(a) { return a.id; });
        var base = id;
        var n = 1;
        while (existing.indexOf(id) !== -1) { id = base + '-' + (++n); }
        siteConfig.bookingAddons.push({ id: id, name: name, price: price, description: desc, enabled: true });
        document.getElementById('addon-new-name').value = '';
        document.getElementById('addon-new-price').value = '';
        document.getElementById('addon-new-desc').value = '';
        renderAddons();
    }

    function removeAddon(index) {
        if (!siteConfig.bookingAddons) return;
        siteConfig.bookingAddons.splice(index, 1);
        renderAddons();
    }

    function toggleAddon(index) {
        if (!siteConfig.bookingAddons || !siteConfig.bookingAddons[index]) return;
        siteConfig.bookingAddons[index].enabled = !siteConfig.bookingAddons[index].enabled;
    }

    function editAddon(index) {
        var a = siteConfig.bookingAddons[index];
        if (!a) return;
        var newName = prompt('Add-on name:', a.name);
        if (newName === null) return;
        var newPrice = prompt('Price:', a.price);
        if (newPrice === null) return;
        var newDesc = prompt('Description:', a.description || '');
        if (newDesc === null) return;
        a.name = newName.trim() || a.name;
        a.price = parseFloat(newPrice) || 0;
        a.description = newDesc.trim();
        renderAddons();
    }

    // --- Affiliate Experiences ---
    function renderExperiences() {
        var container = document.getElementById('experiences-admin-list');
        if (!container) return;
        var list = siteConfig.experiences || [];
        if (list.length === 0) {
            container.innerHTML = '<div style="font-size:0.9rem;color:var(--color-stone);padding:0.5rem 0;">No experiences yet.</div>';
            return;
        }
        container.innerHTML = list.map(function(e, i) {
            var imgPreview = e.imageUrl ? '<img src="' + escapeHtml(e.imageUrl) + '" style="width:60px;height:40px;object-fit:cover;border-radius:3px;flex-shrink:0">' : '';
            return '<div class="list-item" style="flex-wrap:wrap;gap:0.5rem">'
                + '<div style="display:flex;align-items:center;gap:0.75rem;flex:1;min-width:200px">'
                + imgPreview
                + '<div class="item-info">'
                + '<strong>' + escapeHtml(e.name) + '</strong>'
                + (e.description ? '<br><span style="font-size:0.8rem;color:var(--color-stone)">' + escapeHtml(e.description) + '</span>' : '')
                + '</div></div>'
                + '<div style="display:flex;gap:0.4rem;align-items:center">'
                + '<button class="btn btn-secondary" onclick="editExperience(' + i + ')" style="padding:0.3rem 0.6rem;font-size:0.8rem">Edit</button>'
                + '<label style="font-size:0.8rem;display:flex;align-items:center;gap:0.3rem;cursor:pointer"><input type="checkbox" onchange="toggleExperience(' + i + ')" ' + (e.enabled !== false ? 'checked' : '') + '> Enabled</label>'
                + '<button class="btn btn-danger" onclick="removeExperience(' + i + ')" style="padding:0.3rem 0.6rem">Remove</button>'
                + '</div></div>';
        }).join('');
    }

    function addExperience() {
        var name = document.getElementById('exp-new-name').value.trim();
        var desc = document.getElementById('exp-new-desc').value.trim();
        var imageUrl = document.getElementById('exp-new-image').value.trim();
        var affiliateUrl = document.getElementById('exp-new-url').value.trim();
        if (!name || !affiliateUrl) { alert('Name and affiliate URL are required.'); return; }
        if (!siteConfig.experiences) siteConfig.experiences = [];
        var id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        var existing = siteConfig.experiences.map(function(e) { return e.id; });
        var base = id; var n = 1;
        while (existing.indexOf(id) !== -1) { id = base + '-' + (++n); }
        siteConfig.experiences.push({ id: id, name: name, description: desc, imageUrl: imageUrl, affiliateUrl: affiliateUrl, enabled: true });
        document.getElementById('exp-new-name').value = '';
        document.getElementById('exp-new-desc').value = '';
        document.getElementById('exp-new-image').value = '';
        document.getElementById('exp-new-url').value = '';
        renderExperiences();
    }

    function removeExperience(index) {
        if (!siteConfig.experiences) return;
        siteConfig.experiences.splice(index, 1);
        renderExperiences();
    }

    function toggleExperience(index) {
        if (!siteConfig.experiences || !siteConfig.experiences[index]) return;
        siteConfig.experiences[index].enabled = !siteConfig.experiences[index].enabled;
    }

    function editExperience(index) {
        var e = siteConfig.experiences[index];
        if (!e) return;
        var newName = prompt('Experience name:', e.name);
        if (newName === null) return;
        var newDesc = prompt('Short description:', e.description || '');
        if (newDesc === null) return;
        var newImage = prompt('Image URL:', e.imageUrl || '');
        if (newImage === null) return;
        var newUrl = prompt('Affiliate URL:', e.affiliateUrl || '');
        if (newUrl === null) return;
        e.name = newName.trim() || e.name;
        e.description = newDesc.trim();
        e.imageUrl = newImage.trim();
        e.affiliateUrl = newUrl.trim() || e.affiliateUrl;
        renderExperiences();
    }

    // --- Rules ---
    function renderRules() {
        const container = document.getElementById('rules-list');
        const rules = siteConfig.rules || [];

        if (rules.length === 0) {
            container.innerHTML = '<div style="font-size:0.9rem;color:var(--color-stone);padding:0.5rem 0;">No rules yet.</div>';
            return;
        }

        container.innerHTML = rules.map((rule, i) => {
            return '<div class="list-item">'
                + '<div class="item-info">' + rule + '</div>'
                + '<button class="btn btn-danger" onclick="removeRule(' + i + ')">Remove</button>'
                + '</div>';
        }).join('');
    }

    // --- Collapsible cards ---
    function toggleCard(el) {
        var body = el.nextElementSibling;
        if (!body) return;
        body.classList.toggle('collapsed');
        el.classList.toggle('collapsed');
    }

    // --- Amenities ---
    function renderAmenities(site) {
        const container = document.getElementById('amenities-' + site);
        if (!container) return;
        const key = site;
        const amenities = (siteConfig[key] && siteConfig[key].amenities) || [];
        container.innerHTML = amenities.map(function(a, i) {
            return '<span class="amenity-tag">' + escapeHtml(a) +
                '<button class="amenity-remove" onclick="removeAmenity(\'' + key + '\',' + i + ')" title="Remove">&times;</button></span>';
        }).join('');
    }

    function addAmenity(site) {
        const input = document.getElementById('amenity-input-' + site);
        const text = input.value.trim();
        if (!text) return;
        if (!siteConfig[site]) siteConfig[site] = {};
        if (!siteConfig[site].amenities) siteConfig[site].amenities = [];
        if (siteConfig[site].amenities.indexOf(text) === -1) {
            siteConfig[site].amenities.push(text);
        }
        input.value = '';
        renderAmenities(site);
    }

    function removeAmenity(site, index) {
        if (siteConfig[site] && siteConfig[site].amenities) {
            siteConfig[site].amenities.splice(index, 1);
            renderAmenities(site);
        }
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // --- Amenity Categories ---
    function renderAmenityCategories(site) {
        var container = document.getElementById('amenity-cats-' + site);
        if (!container) return;
        var cats = (siteConfig[site] && siteConfig[site].amenityCategories) || [];
        var html = '';
        cats.forEach(function(cat, ci) {
            html += '<div class="amenity-cat-block">';
            html += '<div class="amenity-cat-header">';
            html += '<input type="text" value="' + escapeHtml(cat.name) + '" onchange="updateCategoryName(\'' + site + '\',' + ci + ',this.value)" placeholder="Category name">';
            html += '<button class="amenity-cat-remove" onclick="removeAmenityCategory(\'' + site + '\',' + ci + ')" title="Remove category">&times;</button>';
            html += '</div>';
            html += '<div class="amenity-tags">';
            (cat.items || []).forEach(function(item, ii) {
                html += '<span class="amenity-tag">' + escapeHtml(item) +
                    '<button class="amenity-remove" onclick="removeCategoryItem(\'' + site + '\',' + ci + ',' + ii + ')" title="Remove">&times;</button></span>';
            });
            html += '</div>';
            html += '<div class="amenity-add" style="margin-top:0.35rem">';
            html += '<input type="text" id="cat-item-input-' + site + '-' + ci + '" placeholder="Add item..." onkeydown="if(event.key===\'Enter\'){addCategoryItem(\'' + site + '\',' + ci + ');event.preventDefault()}">';
            html += '<button class="btn btn-secondary btn-sm" onclick="addCategoryItem(\'' + site + '\',' + ci + ')">Add</button>';
            html += '</div>';
            html += '</div>';
        });
        container.innerHTML = html;
    }

    function addAmenityCategory(site) {
        if (!siteConfig[site]) siteConfig[site] = {};
        if (!siteConfig[site].amenityCategories) siteConfig[site].amenityCategories = [];
        siteConfig[site].amenityCategories.push({ name: '', items: [] });
        renderAmenityCategories(site);
        // Focus the new category name input
        var cats = siteConfig[site].amenityCategories;
        var input = document.getElementById('cat-item-input-' + site + '-' + (cats.length - 1));
        var nameInput = input ? input.closest('.amenity-cat-block').querySelector('.amenity-cat-header input') : null;
        if (nameInput) nameInput.focus();
    }

    function removeAmenityCategory(site, catIndex) {
        if (siteConfig[site] && siteConfig[site].amenityCategories) {
            siteConfig[site].amenityCategories.splice(catIndex, 1);
            renderAmenityCategories(site);
        }
    }

    function updateCategoryName(site, catIndex, name) {
        if (siteConfig[site] && siteConfig[site].amenityCategories && siteConfig[site].amenityCategories[catIndex]) {
            siteConfig[site].amenityCategories[catIndex].name = name;
        }
    }

    function addCategoryItem(site, catIndex) {
        var input = document.getElementById('cat-item-input-' + site + '-' + catIndex);
        if (!input) return;
        var text = input.value.trim();
        if (!text) return;
        if (siteConfig[site] && siteConfig[site].amenityCategories && siteConfig[site].amenityCategories[catIndex]) {
            var items = siteConfig[site].amenityCategories[catIndex].items;
            if (items.indexOf(text) === -1) {
                items.push(text);
            }
            input.value = '';
            renderAmenityCategories(site);
        }
    }

    function removeCategoryItem(site, catIndex, itemIndex) {
        if (siteConfig[site] && siteConfig[site].amenityCategories && siteConfig[site].amenityCategories[catIndex]) {
            siteConfig[site].amenityCategories[catIndex].items.splice(itemIndex, 1);
            renderAmenityCategories(site);
        }
    }

    function addRule() {
        const input = document.getElementById('rule-text');
        const text = input.value.trim();
        if (!text) return;

        if (!siteConfig.rules) siteConfig.rules = [];
        siteConfig.rules.push(text);
        input.value = '';
        renderRules();
    }

    function removeRule(index) {
        siteConfig.rules.splice(index, 1);
        renderRules();
    }

    // --- Messages ---
    let messages = [];

    async function loadMessages() {
        try {
            const res = await fetch(WORKER_URL + '/messages', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            messages = data.messages || [];
            renderMessages();
            updateBadge();
            updateDashStats();
        } catch (err) {
            document.getElementById('messages-list').innerHTML = '<div style="font-size:0.85rem;color:var(--color-error);padding:0.5rem 0;">Could not load messages.</div>';
        }
    }

    function renderMessages() {
        const container = document.getElementById('messages-list');

        if (messages.length === 0) {
            container.innerHTML = '<div style="font-size:0.9rem;color:var(--color-stone);padding:1rem 0;">No messages yet. Messages from the Contact Us page will appear here.</div>';
            return;
        }

        container.innerHTML = messages.map(m => {
            const date = new Date(m.date).toLocaleDateString('en-AU', {
                day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            return '<div class="message-card' + (m.read ? '' : ' unread') + '" data-id="' + m.id + '">'
                + '<div class="message-header">'
                + '<div><div class="message-from">' + escHtml(m.name) + '</div>'
                + '<div class="message-email">' + escHtml(m.email) + '</div></div>'
                + '<div class="message-date">' + date + '</div>'
                + '</div>'
                + (m.subject && m.subject !== 'No subject' ? '<div class="message-subject">' + escHtml(m.subject) + '</div>' : '')
                + '<div class="message-body">' + escHtml(m.message) + '</div>'
                + '<div class="message-actions">'
                + (m.read ? '' : '<button class="btn btn-secondary" onclick="markRead(\'' + m.id + '\')" style="padding:0.35rem 0.85rem;font-size:0.78rem">Mark read</button>')
                + '<a href="mailto:' + encodeURIComponent(m.email) + '?subject=Re: ' + encodeURIComponent(m.subject || 'Your message') + '" class="btn btn-secondary" style="padding:0.35rem 0.85rem;font-size:0.78rem;text-decoration:none">Reply</a>'
                + '<button class="btn btn-danger" onclick="deleteMessage(\'' + m.id + '\')">Delete</button>'
                + '</div>'
                + '</div>';
        }).join('');
    }

    function updateBadge() {
        const unread = messages.filter(m => !m.read).length;
        const badge = document.getElementById('msg-badge');
        if (unread > 0) {
            badge.textContent = unread;
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    }

    async function markRead(id) {
        try {
            await fetch(WORKER_URL + '/messages/read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id }),
            });
            const msg = messages.find(m => m.id === id);
            if (msg) msg.read = true;
            renderMessages();
            updateBadge();
        } catch (err) {}
    }

    async function deleteMessage(id) {
        if (!confirm('Delete this message?')) return;
        try {
            await fetch(WORKER_URL + '/messages/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id }),
            });
            messages = messages.filter(m => m.id !== id);
            renderMessages();
            updateBadge();
        } catch (err) {}
    }

    function escHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // --- Bookings ---
    let bookings = [];
    let bookingFilter = 'all';

    async function loadBookings() {
        try {
            const res = await fetch(WORKER_URL + '/bookings', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            bookings = data.bookings || [];
        } catch (err) {
            bookings = [];
        }
        renderBookings();
        updateBookingBadge();
        updateDashStats();
    }

    function filterBookings(filter) {
        bookingFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.filter-btn[data-filter="' + filter + '"]').classList.add('active');
        renderBookings();
    }

    function renderBookings() {
        const container = document.getElementById('bookings-list');
        const filtered = bookingFilter === 'all' ? bookings : bookings.filter(b => b.status === bookingFilter);

        // Update filter counts
        const counts = { all: bookings.length, pending: 0, confirmed: 0, cancelled: 0, completed: 0 };
        bookings.forEach(b => { if (counts[b.status] !== undefined) counts[b.status]++; });
        document.querySelectorAll('.filter-btn').forEach(btn => {
            const f = btn.dataset.filter;
            const countEl = btn.querySelector('.filter-count');
            if (countEl) countEl.textContent = counts[f] || 0;
            else if (counts[f] > 0) {
                const span = document.createElement('span');
                span.className = 'filter-count';
                span.textContent = counts[f];
                btn.appendChild(span);
            }
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div style="font-size:0.9rem;color:var(--color-stone);padding:1rem 0;">No ' + (bookingFilter === 'all' ? '' : bookingFilter + ' ') + 'bookings yet.</div>';
            return;
        }

        container.innerHTML = filtered.map(b => {
            const sym = { AUD: 'AU$', USD: 'US$', EUR: '€', GBP: '£' }[b.currency] || 'AU$';
            const submitted = b.date ? new Date(b.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

            let actions = '';
            if (b.status === 'pending') {
                actions += '<button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="updateBookingStatus(\'' + b.id + '\',\'confirmed\')">Confirm</button>';
                actions += '<button class="btn btn-danger" onclick="updateBookingStatus(\'' + b.id + '\',\'cancelled\')">Cancel</button>';
            } else if (b.status === 'confirmed') {
                actions += '<button class="btn btn-primary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="updateBookingStatus(\'' + b.id + '\',\'completed\')">Complete</button>';
                actions += '<button class="btn btn-danger" onclick="updateBookingStatus(\'' + b.id + '\',\'cancelled\')">Cancel</button>';
            } else if (b.status === 'cancelled' || b.status === 'completed') {
                actions += '<button class="btn btn-secondary" style="padding:0.35rem 0.85rem;font-size:0.78rem" onclick="updateBookingStatus(\'' + b.id + '\',\'pending\')">Reopen</button>';
            }
            actions += '<button class="btn btn-danger" onclick="deleteBooking(\'' + b.id + '\')">Delete</button>';

            let pricing = sym + (b.total || 0).toFixed(2) + ' total';
            if (b.promoCode) pricing += ' (promo: ' + escHtml(b.promoCode) + ')';
            var policyTag = b.cancellationPolicy === 'non-refundable' ? '<span style="display:inline-block;font-size:0.72rem;padding:0.15rem 0.5rem;background:#fef3e2;color:#c06a10;border-radius:3px;margin-left:0.4rem;font-weight:500">Non-refundable</span>' : '';

            return '<div class="booking-card status-' + b.status + '">'
                + '<div class="booking-top">'
                + '<div><span class="booking-site">' + escHtml(b.siteName || b.site) + '</span></div>'
                + '<span class="booking-status st-' + b.status + '">' + b.status + '</span>'
                + '</div>'
                + '<div class="booking-details">'
                + '<div><div class="booking-detail-label">Guest</div><div class="booking-detail-value">' + escHtml(b.name) + '</div></div>'
                + '<div><div class="booking-detail-label">Guests</div><div class="booking-detail-value">' + b.guests + '</div></div>'
                + '<div><div class="booking-detail-label">Email</div><div class="booking-detail-value"><a href="mailto:' + encodeURIComponent(b.email) + '">' + escHtml(b.email) + '</a></div></div>'
                + '<div><div class="booking-detail-label">Phone</div><div class="booking-detail-value"><a href="tel:' + encodeURIComponent(b.phone || '') + '">' + escHtml(b.phone || 'N/A') + '</a></div></div>'
                + '<div><div class="booking-detail-label">Check-in</div><div class="booking-detail-value">' + escHtml(b.checkin) + '</div></div>'
                + '<div><div class="booking-detail-label">Check-out</div><div class="booking-detail-value">' + escHtml(b.checkout) + '</div></div>'
                + '<div><div class="booking-detail-label">Nights</div><div class="booking-detail-value">' + b.nights + '</div></div>'
                + '<div><div class="booking-detail-label">Total</div><div class="booking-detail-value"><strong>' + pricing + '</strong>' + policyTag + '</div></div>'
                + '</div>'
                + (b.paidAt ? '<div style="font-size:0.78rem;color:#2e6e2e;margin-top:0.3rem;font-weight:500">Paid via Stripe — ' + new Date(b.paidAt).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) + '</div>' : '')
                + '<div class="booking-date-submitted">Submitted ' + submitted + '</div>'
                + '<div class="booking-actions">'
                + '<a href="mailto:' + encodeURIComponent(b.email) + '?subject=Re: Booking at Ahana Hillside — ' + encodeURIComponent(b.siteName || '') + '" class="btn btn-secondary" style="padding:0.35rem 0.85rem;font-size:0.78rem;text-decoration:none">Email Guest</a>'
                + actions
                + '</div>'
                + '</div>';
        }).join('');
    }

    function updateBookingBadge() {
        const pending = bookings.filter(b => b.status === 'pending').length;
        const badge = document.getElementById('booking-badge');
        if (pending > 0) {
            badge.textContent = pending;
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    }

    async function updateBookingStatus(id, status) {
        try {
            await fetch(WORKER_URL + '/bookings/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id, status }),
            });
            const booking = bookings.find(b => b.id === id);
            if (booking) booking.status = status;
            renderBookings();
            updateBookingBadge();
            // Refresh availability calendars since booking status affects blocked dates
            loadBlockedDates();
        } catch (err) {}
    }

    async function deleteBooking(id) {
        if (!confirm('Delete this booking permanently?')) return;
        try {
            await fetch(WORKER_URL + '/bookings/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id }),
            });
            bookings = bookings.filter(b => b.id !== id);
            renderBookings();
            updateBookingBadge();
        } catch (err) {}
    }

    // --- Availability / Blocked Dates ---
    function makeCalState() {
        return { year: new Date().getFullYear(), month: new Date().getMonth(), blocked: new Set(), booked: new Set(), selected: new Set(), lastClicked: null };
    }
    const calState = {
        samavas: makeCalState(),
        chhaya:  makeCalState(),
        'mountain-view': makeCalState(),
        'garden-view':   makeCalState(),
        'suite':         makeCalState(),
    };
    // Track drag-selection state
    let dragState = { active: false, site: null, startDate: null };

    async function loadBlockedDates() {
        // Load confirmed bookings to show booked dates
        let allBookings = [];
        try {
            const bRes = await fetch(WORKER_URL + '/bookings', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const bData = await bRes.json();
            allBookings = (bData.bookings || []).filter(b => b.status === 'confirmed' || b.status === 'completed');
        } catch (e) {}

        for (const site of ['samavas', 'chhaya', 'mountain-view', 'garden-view', 'suite']) {
            // Load manually blocked dates
            try {
                const res = await fetch(WORKER_URL + '/blocked-dates/' + site);
                const data = await res.json();
                calState[site].blocked = new Set(data.blockedDates || []);
            } catch (err) {
                calState[site].blocked = new Set();
            }

            // Compute booked dates from confirmed bookings
            const bookedSet = new Set();
            allBookings.filter(b => b.site === site).forEach(b => {
                const start = new Date(b.checkin);
                const end = new Date(b.checkout);
                const cur = new Date(start);
                while (cur < end) {
                    bookedSet.add(cur.toISOString().split('T')[0]);
                    cur.setDate(cur.getDate() + 1);
                }
            });
            calState[site].booked = bookedSet;

            renderCalendar(site);
        }
    }

    function renderCalendar(site) {
        const state = calState[site];
        const year = state.year;
        const month = state.month;
        const grid = document.getElementById('cal-grid-' + site);
        const label = document.getElementById('cal-label-' + site);

        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        label.textContent = monthNames[month] + ' ' + year;

        const today = new Date();
        const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

        const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        let html = '';
        // Day headers
        ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
            html += '<div class="cal-header-cell">' + d + '</div>';
        });

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="cal-cell empty"></div>';
        }

        // Day cells
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
            const isPast = dateStr < todayStr;
            const isBlocked = state.blocked.has(dateStr);
            const isBooked = state.booked && state.booked.has(dateStr);
            const isToday = dateStr === todayStr;
            const isSelected = state.selected.has(dateStr);

            let cls = 'cal-cell';
            if (isPast) cls += ' past';
            if (isBooked && !isBlocked) cls += ' booked';
            else if (isBlocked) cls += ' blocked';
            if (isToday) cls += ' today';
            if (isSelected) cls += ' selected';

            // Past and booked dates cannot be interacted with
            let handlers = '';
            if (!isPast && !isBooked) {
                handlers = ' onmousedown="calMouseDown(event,\'' + site + '\',\'' + dateStr + '\')"'
                    + ' onmouseenter="calMouseEnter(event,\'' + site + '\',\'' + dateStr + '\')"';
            }

            const title = isBooked ? 'Booked by guest' : isBlocked ? 'Manually blocked' : '';
            html += '<div class="' + cls + '"' + handlers + ' data-date="' + dateStr + '" title="' + title + '">' + d + '</div>';
        }

        grid.innerHTML = html;

        // Occupancy summary
        var occEl = document.getElementById('cal-occ-' + site);
        if (occEl) {
            var bookedCount = 0, blockedCount = 0;
            for (var d = 1; d <= daysInMonth; d++) {
                var ds = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                if (state.booked && state.booked.has(ds)) bookedCount++;
                else if (state.blocked.has(ds)) blockedCount++;
            }
            var availCount = daysInMonth - bookedCount - blockedCount;
            occEl.innerHTML = '<strong>' + bookedCount + '</strong> booked &middot; <strong>' + blockedCount + '</strong> blocked &middot; <strong>' + availCount + '</strong> available <span style="color:#bbb">/ ' + daysInMonth + ' nights</span>';
        }

        // Update selection toolbar
        updateSelToolbar(site);
    }

    // --- Multi-date selection helpers ---

    function getDatesInRange(dateA, dateB) {
        const dates = [];
        const start = dateA < dateB ? dateA : dateB;
        const end = dateA < dateB ? dateB : dateA;
        const cur = new Date(start + 'T00:00:00');
        const endD = new Date(end + 'T00:00:00');
        while (cur <= endD) {
            dates.push(cur.getFullYear() + '-' + String(cur.getMonth() + 1).padStart(2, '0') + '-' + String(cur.getDate()).padStart(2, '0'));
            cur.setDate(cur.getDate() + 1);
        }
        return dates;
    }

    function isSelectableDate(site, dateStr) {
        const state = calState[site];
        const today = new Date();
        const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        if (dateStr < todayStr) return false;
        if (state.booked && state.booked.has(dateStr)) return false;
        return true;
    }

    function updateSelToolbar(site) {
        const state = calState[site];
        const toolbar = document.getElementById('cal-sel-' + site);
        const countEl = document.getElementById('cal-sel-count-' + site);
        if (!toolbar) return;
        const count = state.selected.size;
        if (count > 0) {
            toolbar.classList.add('visible');
            countEl.textContent = count + ' date' + (count === 1 ? '' : 's') + ' selected';
        } else {
            toolbar.classList.remove('visible');
        }
    }

    function calMouseDown(e, site, dateStr) {
        e.preventDefault();
        const state = calState[site];

        if (e.shiftKey && state.lastClicked) {
            // Shift+click: select range from last clicked to this date
            const range = getDatesInRange(state.lastClicked, dateStr);
            range.forEach(function(d) {
                if (isSelectableDate(site, d)) state.selected.add(d);
            });
        } else if (e.ctrlKey || e.metaKey) {
            // Ctrl/Cmd+click: toggle individual date in selection
            if (state.selected.has(dateStr)) {
                state.selected.delete(dateStr);
            } else {
                state.selected.add(dateStr);
            }
        } else {
            // Plain click: start drag selection
            dragState = { active: true, site: site, startDate: dateStr, lastHovered: dateStr };
            // If date is already the only selected date, deselect it (toggle behavior)
            if (state.selected.size === 1 && state.selected.has(dateStr)) {
                state.selected.clear();
            } else {
                state.selected.clear();
                state.selected.add(dateStr);
            }
        }

        state.lastClicked = dateStr;
        renderCalendar(site);
    }

    function calMouseEnter(e, site, dateStr) {
        if (!dragState.active || dragState.site !== site) return;
        if (dateStr === dragState.lastHovered) return;
        dragState.lastHovered = dateStr;

        const state = calState[site];
        // Recompute selection as range from start to current hover
        state.selected.clear();
        const range = getDatesInRange(dragState.startDate, dateStr);
        range.forEach(function(d) {
            if (isSelectableDate(site, d)) state.selected.add(d);
        });
        renderCalendar(site);
    }

    // Global mouseup to end drag selection
    document.addEventListener('mouseup', function() {
        if (dragState.active) {
            dragState.active = false;
        }
    });

    // Prevent text selection while dragging on calendar grids
    document.addEventListener('selectstart', function(e) {
        if (dragState.active) e.preventDefault();
    });

    // --- Bulk actions ---

    function bulkBlock(site) {
        const state = calState[site];
        state.selected.forEach(function(dateStr) {
            state.blocked.add(dateStr);
        });
        state.selected.clear();
        renderCalendar(site);
    }

    function bulkOpen(site) {
        const state = calState[site];
        state.selected.forEach(function(dateStr) {
            state.blocked.delete(dateStr);
        });
        state.selected.clear();
        renderCalendar(site);
    }

    function clearSelection(site) {
        calState[site].selected.clear();
        renderCalendar(site);
    }

    // Legacy single-click toggle (kept for backward compat but no longer wired to calendar)
    function toggleDate(site, dateStr) {
        const state = calState[site];
        if (state.blocked.has(dateStr)) {
            state.blocked.delete(dateStr);
        } else {
            state.blocked.add(dateStr);
        }
        renderCalendar(site);
    }

    function calNav(site, dir) {
        const state = calState[site];
        state.month += dir;
        if (state.month > 11) { state.month = 0; state.year++; }
        if (state.month < 0) { state.month = 11; state.year--; }
        state.selected.clear();
        renderCalendar(site);
    }

    function calToday(site) {
        const now = new Date();
        calState[site].year = now.getFullYear();
        calState[site].month = now.getMonth();
        calState[site].selected.clear();
        renderCalendar(site);
    }

    async function saveBlockedDates(site) {
        const dates = [...calState[site].blocked].sort();
        calState[site].selected.clear();
        try {
            const res = await fetch(WORKER_URL + '/blocked-dates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ site, dates }),
            });
            const data = await res.json();
            if (data.success) {
                showMsg('avail-' + site, 'Saved — ' + data.count + ' dates blocked', 'success');
            } else {
                showMsg('avail-' + site, data.error || 'Save failed', 'error');
            }
        } catch (err) {
            showMsg('avail-' + site, 'Connection error', 'error');
        }
        renderCalendar(site);
    }

    // --- Images ---
    let siteImages = { samavas: [], chhaya: [], 'mountain-view': [], 'garden-view': [], 'suite': [] };

    async function loadImages() {
        for (const site of ['samavas', 'chhaya', 'mountain-view', 'garden-view', 'suite']) {
            try {
                const res = await fetch(WORKER_URL + '/images/list/' + site);
                const data = await res.json();
                siteImages[site] = data.images || [];
            } catch (err) {
                siteImages[site] = [];
            }
            renderImages(site);
        }
        updateSiteSelectorMeta();
    }

    function renderImages(site) {
        const container = document.getElementById('images-' + site);
        const images = siteImages[site];

        if (images.length === 0) {
            container.innerHTML = '<div class="img-empty">No images or videos uploaded yet.</div>';
            return;
        }

        container.innerHTML = images.map((img, i) => {
            const mediaUrl = WORKER_URL + '/images/' + site + '/' + img.id;
            const isVideo = img.mediaType === 'video' || (img.contentType && img.contentType.startsWith('video/'));
            let preview;
            if (isVideo) {
                preview = '<video src="' + mediaUrl + '" muted style="width:100%;height:100%;object-fit:cover"></video>'
                    + '<span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5rem;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,0.5)">&#9654;</span>';
            } else {
                preview = '<img src="' + mediaUrl + '" alt="' + escHtml(img.name || '') + '" loading="lazy">';
            }
            return '<div class="img-thumb">'
                + preview
                + '<span class="img-order">' + (i + 1) + '</span>'
                + '<div class="img-actions">'
                + (i > 0 ? '<button class="img-action-btn move-btn" onclick="moveImage(\'' + site + '\',' + i + ',-1)" title="Move left">&larr;</button>' : '')
                + (i < images.length - 1 ? '<button class="img-action-btn move-btn" onclick="moveImage(\'' + site + '\',' + i + ',1)" title="Move right">&rarr;</button>' : '')
                + '<button class="img-action-btn delete-btn" onclick="deleteImage(\'' + site + '\',\'' + img.id + '\')" title="Delete">DEL</button>'
                + '</div>'
                + '</div>';
        }).join('');
    }

    // --- Image compression ---
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                let w = img.width, h = img.height;
                if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                const canvas = document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
            img.src = URL.createObjectURL(file);
        });
    }

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function handleFileSelect(site, files) {
        if (!files || files.length === 0) return;
        const progressEl = document.getElementById('progress-' + site);
        const total = files.length;
        let uploaded = 0;

        for (const file of files) {
            const isVideo = file.type.startsWith('video/');
            let uploadFile = file;
            let uploadName = file.name;
            let uploadType = file.type;
            let mediaType = isVideo ? 'video' : 'image';

            if (!isVideo) {
                // Auto-compress images
                progressEl.textContent = 'Compressing ' + (uploaded + 1) + ' of ' + total + '...';
                try {
                    const compressed = await compressImage(file, 1920, 0.82);
                    if (compressed && compressed.size < file.size) {
                        progressEl.textContent = 'Compressed: ' + formatSize(file.size) + ' → ' + formatSize(compressed.size) + '. Uploading...';
                        uploadFile = new File([compressed], file.name.replace(/\.\w+$/, '.jpg'), { type: 'image/jpeg' });
                        uploadType = 'image/jpeg';
                    } else {
                        progressEl.textContent = 'Uploading ' + (uploaded + 1) + ' of ' + total + '...';
                    }
                } catch (e) {
                    progressEl.textContent = 'Uploading ' + (uploaded + 1) + ' of ' + total + '...';
                }
            } else {
                progressEl.textContent = 'Uploading video ' + (uploaded + 1) + ' of ' + total + '...';
            }

            const formData = new FormData();
            formData.append('site', site);
            formData.append('file', uploadFile);

            try {
                const res = await fetch(WORKER_URL + '/images/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                    body: formData,
                });
                const data = await res.json();
                if (data.success) {
                    siteImages[site].push({
                        id: data.id,
                        name: uploadName,
                        contentType: uploadType,
                        size: uploadFile.size,
                        mediaType,
                    });
                    uploaded++;
                } else {
                    progressEl.textContent = 'Error: ' + (data.error || 'Upload failed');
                    break;
                }
            } catch (err) {
                progressEl.textContent = 'Upload failed — connection error';
                break;
            }
        }

        if (uploaded === total) {
            progressEl.textContent = uploaded + ' file(s) uploaded successfully';
            setTimeout(() => { progressEl.textContent = ''; }, 3000);
        }

        renderImages(site);
        updateSiteSelectorMeta();
        document.getElementById('file-' + site).value = '';
    }

    async function deleteImage(site, id) {
        if (!confirm('Delete this image?')) return;
        try {
            await fetch(WORKER_URL + '/images/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ site, id }),
            });
            siteImages[site] = siteImages[site].filter(img => img.id !== id);
            renderImages(site);
            updateSiteSelectorMeta();
        } catch (err) {}
    }

    async function moveImage(site, index, direction) {
        const images = siteImages[site];
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= images.length) return;

        // Swap
        [images[index], images[newIndex]] = [images[newIndex], images[index]];
        renderImages(site);

        // Save new order to server
        const order = images.map(img => img.id);
        try {
            await fetch(WORKER_URL + '/images/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ site, order }),
            });
        } catch (err) {}
    }

    // Drag & drop support
    // --- Gallery ---
    let galleryItems = [];

    async function loadGalleryItems() {
        try {
            const res = await fetch(WORKER_URL + '/gallery/list');
            const data = await res.json();
            galleryItems = data.items || [];
        } catch (err) {
            galleryItems = [];
        }
        renderGallery();
    }

    function renderGallery() {
        const container = document.getElementById('gallery-grid');
        const countEl = document.getElementById('gallery-count');
        countEl.textContent = '(' + galleryItems.length + '/50)';

        if (galleryItems.length === 0) {
            container.innerHTML = '<div class="img-empty">No gallery items yet. Upload images or videos above.</div>';
            return;
        }

        container.innerHTML = galleryItems.map((item, i) => {
            const url = WORKER_URL + '/gallery/' + item.id;
            const isVideo = item.mediaType === 'video';
            const thumb = isVideo
                ? '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#222;color:#fff;font-size:1.5rem">&#9654;<br><span style="font-size:0.55rem;display:block;margin-top:0.25rem;color:#ccc">' + escHtml(item.name || 'video') + '</span></div>'
                : '<img src="' + url + '" alt="' + escHtml(item.name || '') + '" loading="lazy">';
            return '<div class="img-thumb">'
                + thumb
                + '<span class="img-order">' + (i + 1) + (isVideo ? ' vid' : '') + '</span>'
                + '<div class="img-actions">'
                + (i > 0 ? '<button class="img-action-btn move-btn" onclick="moveGalleryItem(' + i + ',-1)" title="Move left">&larr;</button>' : '')
                + (i < galleryItems.length - 1 ? '<button class="img-action-btn move-btn" onclick="moveGalleryItem(' + i + ',1)" title="Move right">&rarr;</button>' : '')
                + '<button class="img-action-btn delete-btn" onclick="deleteGalleryItem(\'' + item.id + '\')" title="Delete">DEL</button>'
                + '</div>'
                + '</div>';
        }).join('');
    }

    async function handleGalleryUpload(files) {
        if (!files || files.length === 0) return;
        const progressEl = document.getElementById('progress-gallery');
        const total = files.length;
        let uploaded = 0;

        for (const file of files) {
            progressEl.textContent = 'Uploading ' + (uploaded + 1) + ' of ' + total + '... (' + file.name + ')';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(WORKER_URL + '/gallery/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                    body: formData,
                });
                const data = await res.json();
                if (data.success) {
                    galleryItems.push({
                        id: data.id,
                        name: file.name,
                        contentType: file.type,
                        mediaType: data.mediaType,
                        size: file.size,
                    });
                    uploaded++;
                } else {
                    progressEl.textContent = 'Error: ' + (data.error || 'Upload failed');
                    break;
                }
            } catch (err) {
                progressEl.textContent = 'Upload failed — connection error';
                break;
            }
        }

        if (uploaded === total) {
            progressEl.textContent = uploaded + ' file(s) uploaded successfully';
            setTimeout(() => { progressEl.textContent = ''; }, 3000);
        }

        renderGallery();
        document.getElementById('file-gallery').value = '';
    }

    async function deleteGalleryItem(id) {
        if (!confirm('Delete this gallery item?')) return;
        try {
            await fetch(WORKER_URL + '/gallery/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id }),
            });
            galleryItems = galleryItems.filter(item => item.id !== id);
            renderGallery();
        } catch (err) {}
    }

    async function moveGalleryItem(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= galleryItems.length) return;
        [galleryItems[index], galleryItems[newIndex]] = [galleryItems[newIndex], galleryItems[index]];
        renderGallery();
        const order = galleryItems.map(item => item.id);
        try {
            await fetch(WORKER_URL + '/gallery/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ order }),
            });
        } catch (err) {}
    }

    // Gallery drag & drop
    (function() {
        const zone = document.getElementById('upload-zone-gallery');
        if (!zone) return;
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => { zone.classList.remove('dragover'); });
        zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('dragover'); handleGalleryUpload(e.dataTransfer.files); });
    })();

    // --- Homepage Background ---
    async function loadHomepageBg() {
        const preview = document.getElementById('homepage-bg-preview');
        try {
            const res = await fetch(WORKER_URL + '/homepage-bg/info');
            const data = await res.json();
            if (data.exists) {
                const url = WORKER_URL + '/homepage-bg?t=' + Date.now();
                if (data.mediaType === 'video') {
                    preview.innerHTML = '<video src="' + url + '" style="width:100%;max-height:200px;object-fit:cover;border:1px solid var(--color-light-stone)" autoplay muted loop></video>'
                        + '<div style="margin-top:0.5rem;display:flex;align-items:center;justify-content:space-between">'
                        + '<span style="font-size:0.82rem;color:var(--color-stone)">Current: video background</span>'
                        + '<button class="btn btn-danger" onclick="deleteHomepageBg()" style="padding:0.35rem 0.85rem;font-size:0.78rem">Remove</button>'
                        + '</div>';
                } else {
                    preview.innerHTML = '<img src="' + url + '" style="width:100%;max-height:200px;object-fit:cover;border:1px solid var(--color-light-stone)">'
                        + '<div style="margin-top:0.5rem;display:flex;align-items:center;justify-content:space-between">'
                        + '<span style="font-size:0.82rem;color:var(--color-stone)">Current: image background</span>'
                        + '<button class="btn btn-danger" onclick="deleteHomepageBg()" style="padding:0.35rem 0.85rem;font-size:0.78rem">Remove</button>'
                        + '</div>';
                }
            } else {
                preview.innerHTML = '<div style="font-size:0.8rem;color:var(--color-stone);padding:0.5rem 0">Using default background (images/homepage/hero.jpg)</div>';
            }
        } catch (err) {
            preview.innerHTML = '<div style="font-size:0.8rem;color:var(--color-stone)">Could not load preview</div>';
        }
    }

    async function uploadHomepageBg(file) {
        if (!file) return;
        const progressEl = document.getElementById('progress-homebg');
        progressEl.textContent = 'Uploading ' + file.name + '...';

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch(WORKER_URL + '/homepage-bg/upload', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken },
                body: formData,
            });
            const data = await res.json();
            if (data.success) {
                progressEl.textContent = 'Background updated!';
                setTimeout(() => { progressEl.textContent = ''; }, 3000);
                loadHomepageBg();
            } else {
                progressEl.textContent = 'Error: ' + (data.error || 'Upload failed');
            }
        } catch (err) {
            progressEl.textContent = 'Upload failed — connection error';
        }
        document.getElementById('file-homebg').value = '';
    }

    async function deleteHomepageBg() {
        if (!confirm('Remove custom background? The homepage will revert to the default image.')) return;
        try {
            await fetch(WORKER_URL + '/homepage-bg/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: '{}',
            });
            loadHomepageBg();
        } catch (err) {}
    }

    // Homepage bg drag & drop
    (function() {
        const zone = document.getElementById('upload-zone-homebg');
        if (!zone) return;
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => { zone.classList.remove('dragover'); });
        zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('dragover'); uploadHomepageBg(e.dataTransfer.files[0]); });
    })();

    // --- Camping Experience Background ---
    async function loadCampsiteBg() {
        const preview = document.getElementById('campsite-bg-preview');
        try {
            const res = await fetch(WORKER_URL + '/campsite-bg/info');
            const data = await res.json();
            if (data.exists) {
                const url = WORKER_URL + '/campsite-bg?t=' + Date.now();
                if (data.mediaType === 'video') {
                    preview.innerHTML = '<video src="' + url + '" style="width:100%;max-height:200px;object-fit:cover;border:1px solid var(--color-light-stone)" autoplay muted loop></video>'
                        + '<div style="margin-top:0.5rem;display:flex;align-items:center;justify-content:space-between">'
                        + '<span style="font-size:0.82rem;color:var(--color-stone)">Current: video background</span>'
                        + '<button class="btn btn-danger" onclick="deleteCampsiteBg()" style="padding:0.35rem 0.85rem;font-size:0.78rem">Remove</button>'
                        + '</div>';
                } else {
                    preview.innerHTML = '<img src="' + url + '" style="width:100%;max-height:200px;object-fit:cover;border:1px solid var(--color-light-stone)">'
                        + '<div style="margin-top:0.5rem;display:flex;align-items:center;justify-content:space-between">'
                        + '<span style="font-size:0.82rem;color:var(--color-stone)">Current: image background</span>'
                        + '<button class="btn btn-danger" onclick="deleteCampsiteBg()" style="padding:0.35rem 0.85rem;font-size:0.78rem">Remove</button>'
                        + '</div>';
                }
            } else {
                preview.innerHTML = '<div style="font-size:0.8rem;color:var(--color-stone);padding:0.5rem 0">Using default SVG illustration</div>';
            }
        } catch (err) {
            preview.innerHTML = '<div style="font-size:0.8rem;color:var(--color-stone)">Could not load preview</div>';
        }
    }

    async function uploadCampsiteBg(file) {
        if (!file) return;
        const progressEl = document.getElementById('progress-campsitebg');

        const isVideo = file.type.startsWith('video/');
        let uploadFile = file;
        if (!isVideo) {
            progressEl.textContent = 'Compressing...';
            try {
                const compressed = await compressImage(file, 1920, 0.82);
                if (compressed && compressed.size < file.size) {
                    progressEl.textContent = 'Compressed: ' + formatSize(file.size) + ' → ' + formatSize(compressed.size) + '. Uploading...';
                    uploadFile = new File([compressed], file.name.replace(/\.\w+$/, '.jpg'), { type: 'image/jpeg' });
                } else {
                    progressEl.textContent = 'Uploading...';
                }
            } catch (e) {
                progressEl.textContent = 'Uploading...';
            }
        } else {
            progressEl.textContent = 'Uploading video...';
        }

        const formData = new FormData();
        formData.append('file', uploadFile);

        try {
            const res = await fetch(WORKER_URL + '/campsite-bg/upload', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken },
                body: formData,
            });
            const data = await res.json();
            if (data.success) {
                progressEl.textContent = 'Background updated!';
                setTimeout(() => { progressEl.textContent = ''; }, 3000);
                loadCampsiteBg();
            } else {
                progressEl.textContent = 'Error: ' + (data.error || 'Upload failed');
            }
        } catch (err) {
            progressEl.textContent = 'Upload failed — connection error';
        }
        document.getElementById('file-campsitebg').value = '';
    }

    async function deleteCampsiteBg() {
        if (!confirm('Remove custom background? The section will revert to the default SVG illustration.')) return;
        try {
            await fetch(WORKER_URL + '/campsite-bg/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: '{}',
            });
            loadCampsiteBg();
        } catch (err) {}
    }

    // Campsite bg drag & drop
    (function() {
        const zone = document.getElementById('upload-zone-campsitebg');
        if (!zone) return;
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => { zone.classList.remove('dragover'); });
        zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('dragover'); uploadCampsiteBg(e.dataTransfer.files[0]); });
    })();

    // --- Explore Section Images ---
    let exploreSlots = {};

    function toggleExploreSection() {
        var body = document.getElementById('explore-section-body');
        var icon = document.getElementById('explore-collapse-icon');
        if (body.style.maxHeight === '0px' || body.style.maxHeight === '0') {
            body.style.maxHeight = body.scrollHeight + 200 + 'px';
            body.style.opacity = '1';
            icon.style.transform = 'rotate(0deg)';
        } else {
            body.style.maxHeight = '0';
            body.style.opacity = '0';
            icon.style.transform = 'rotate(180deg)';
        }
    }

    async function loadExploreSlots() {
        try {
            const res = await fetch(WORKER_URL + '/explore/list');
            const data = await res.json();
            exploreSlots = data.slots || {};
        } catch (e) {
            exploreSlots = {};
        }
        renderExploreSlots();
    }

    function renderExploreSlots() {
        const slotNames = ['neighbourhood', 'reef', 'rainforest', 'waterfall', 'tablelands', 'beach', 'cairns', 'kitchen'];
        slotNames.forEach(slot => {
            const preview = document.getElementById('explore-preview-' + slot);
            const status = document.getElementById('explore-status-' + slot);
            const delBtn = document.getElementById('explore-del-' + slot);
            if (!preview) return;

            const meta = exploreSlots[slot];
            if (meta) {
                const url = WORKER_URL + '/explore/' + slot + '?t=' + Date.now();
                if (meta.mediaType === 'video') {
                    preview.innerHTML = '<video src="' + url + '" style="max-height:120px;max-width:100%;border:1px solid var(--color-light-stone)" muted playsinline></video>';
                } else {
                    preview.innerHTML = '<img src="' + url + '" alt="' + slot + '">';
                }
                status.textContent = meta.name ? '(' + meta.name + ')' : '(uploaded)';
                delBtn.style.display = '';
            } else {
                preview.innerHTML = '<span style="font-size:0.82rem;color:var(--color-stone)">Using default image</span>';
                status.textContent = '';
                delBtn.style.display = 'none';
            }
        });
    }

    async function uploadExploreSlot(slot, file) {
        if (!file) return;
        const status = document.getElementById('explore-status-' + slot);
        status.textContent = 'Uploading...';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('slot', slot);

        try {
            const res = await fetch(WORKER_URL + '/explore/upload', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken },
                body: formData,
            });
            const data = await res.json();
            if (data.success) {
                exploreSlots[slot] = { mediaType: data.mediaType, name: file.name, size: file.size, uploadedAt: new Date().toISOString() };
                renderExploreSlots();
            } else {
                status.textContent = 'Error: ' + (data.error || 'Upload failed');
            }
        } catch (err) {
            status.textContent = 'Upload failed';
        }
        const fileInput = document.getElementById('file-explore-' + slot);
        if (fileInput) fileInput.value = '';
    }

    async function deleteExploreSlot(slot) {
        if (!confirm('Remove this image? The page will fall back to the default.')) return;
        try {
            await fetch(WORKER_URL + '/explore/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ slot }),
            });
            delete exploreSlots[slot];
            renderExploreSlots();
        } catch (err) {}
    }

    ['samavas', 'chhaya', 'mountain-view', 'garden-view', 'suite'].forEach(site => {
        const zone = document.getElementById('upload-zone-' + site);
        if (!zone) return;

        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });
        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');
            handleFileSelect(site, e.dataTransfer.files);
        });
    });

    // --- UI helpers ---
    function showMsg(tab, text, type) {
        const el = document.getElementById(tab + '-msg');
        if (!el) return;
        el.textContent = text;
        el.className = 'save-msg show ' + type;
        setTimeout(() => el.classList.remove('show'), 3000);
    }

    // --- Tab titles for header ---
    var tabTitles = {
        dashboard: 'Dashboard',
        messages: 'Messages',
        bookings: 'Bookings',
        campsites: 'Campsites & Rooms',
        viator: 'Viator',
        gallery: 'Gallery',
        settings: 'Settings'
    };

    // --- Sidebar navigation ---
    function switchTab(tab) {
        // Update nav items
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        var activeBtn = document.querySelector('.nav-item[data-tab="' + tab + '"]');
        if (activeBtn) activeBtn.classList.add('active');

        // Update header title
        document.getElementById('main-header-title').textContent = tabTitles[tab] || tab;

        // Show/hide panels
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        var panel = document.getElementById('panel-' + tab);
        if (panel) panel.classList.add('active');

        // Show/hide sub-tabs for campsites
        var subTabs = document.getElementById('campsites-sub-tabs');
        if (tab === 'campsites') {
            subTabs.classList.add('show');
        } else {
            subTabs.classList.remove('show');
        }

        // Update dashboard stats when returning to dashboard
        if (tab === 'dashboard') updateDashStats();

        // Close mobile sidebar
        closeSidebar();
    }

    // --- Sidebar mobile toggle ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebar-overlay').classList.toggle('show');
        document.getElementById('sidebar-toggle').classList.toggle('open');
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').classList.remove('show');
        document.getElementById('sidebar-toggle').classList.remove('open');
    }

    // --- Dashboard stats ---
    function updateDashStats() {
        // Unread messages
        var unread = (typeof messages !== 'undefined' && messages) ? messages.filter(function(m) { return !m.read; }).length : 0;
        document.getElementById('stat-messages').textContent = unread;

        // Pending bookings
        var pending = (typeof bookings !== 'undefined' && bookings) ? bookings.filter(function(b) { return b.status === 'pending'; }).length : 0;
        document.getElementById('stat-bookings').textContent = pending;

        // Active sites
        var siteCount = 0;
        if (siteConfig) {
            var cats = ['campsites', 'rooms'];
            cats.forEach(function(cat) {
                if (siteConfig[cat]) {
                    siteConfig[cat].forEach(function(s) { if (s.enabled !== false) siteCount++; });
                }
            });
        }
        document.getElementById('stat-sites').textContent = siteCount;

        // Recent bookings (last 5)
        var el = document.getElementById('dash-recent-bookings');
        if (typeof bookings !== 'undefined' && bookings && bookings.length > 0) {
            var recent = bookings.slice(0, 5);
            el.innerHTML = recent.map(function(b) {
                var statusClass = 'st-' + (b.status || 'pending');
                return '<div style="display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0.85rem;background:#fff;border:1px solid var(--color-light-stone);margin-bottom:0.4rem;font-size:0.85rem">' +
                    '<div><strong style="color:var(--color-forest)">' + escapeHtml(b.siteName || b.site || '—') + '</strong> &middot; ' + escapeHtml(b.guestName || b.name || '—') + '</div>' +
                    '<div style="display:flex;align-items:center;gap:0.75rem">' +
                        '<span style="font-size:0.78rem;color:var(--color-stone)">' + escapeHtml(b.checkIn || '') + '</span>' +
                        '<span class="booking-status ' + statusClass + '" style="font-size:0.68rem;padding:0.2rem 0.5rem">' + (b.status || 'pending') + '</span>' +
                    '</div></div>';
            }).join('');
        } else {
            el.innerHTML = '<div style="font-size:0.85rem;color:var(--color-stone)">No bookings yet.</div>';
        }
    }

    // --- Sub-tab switching (within Campsites) ---
    document.querySelectorAll('.sub-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('subpanel-' + btn.dataset.subtab).classList.add('active');
        });
    });

    // --- Content & Media site selector ---
    function selectContentSite(site) {
        // Update selector buttons
        document.querySelectorAll('.site-sel-btn').forEach(function(b) { b.classList.remove('active'); });
        var activeBtn = document.querySelector('.site-sel-btn[data-site="' + site + '"]');
        if (activeBtn) activeBtn.classList.add('active');

        // Show/hide site forms
        document.querySelectorAll('.site-form').forEach(function(f) { f.classList.remove('active'); });
        var form = document.getElementById('site-form-' + site);
        if (form) form.classList.add('active');
    }

    // --- Pricing site selector ---
    function selectPricingSite(site) {
        document.querySelectorAll('#pricing-site-selector .site-sel-btn').forEach(function(b) { b.classList.remove('active'); });
        var btn = document.querySelector('.site-sel-btn[data-psite="' + site + '"]');
        if (btn) btn.classList.add('active');

        document.querySelectorAll('#subpanel-pricing .site-form').forEach(function(f) { f.classList.remove('active'); });
        var form = document.getElementById('price-form-' + site);
        if (form) form.classList.add('active');
    }

    function toggleNonRefundableFields() {
        var enabled = document.getElementById('p-nonrefundable-enabled').checked;
        document.getElementById('nonrefundable-fields').style.display = enabled ? '' : 'none';
    }

    function updatePricingSelectorMeta() {
        var sites = ['garden-view', 'mountain-view', 'suite', 'samavas', 'chhaya'];
        var sym = 'AU$';
        if (siteConfig) {
            var c = siteConfig.currency || 'AUD';
            sym = c === 'USD' ? 'US$' : c === 'EUR' ? '\u20AC' : c === 'GBP' ? '\u00A3' : 'AU$';
        }
        sites.forEach(function(site) {
            var el = document.getElementById('psel-meta-' + site);
            if (!el) return;
            var baseEl = document.getElementById('p-' + site + '-base');
            var price = baseEl ? baseEl.value : '0';
            el.textContent = 'from ' + sym + price + ' / night';
        });
    }

    // Update photo counts in site selector buttons
    function updateSiteSelectorMeta() {
        var sites = ['garden-view', 'mountain-view', 'suite', 'samavas', 'chhaya'];
        sites.forEach(function(site) {
            var el = document.getElementById('sel-meta-' + site);
            if (!el) return;
            var count = (siteImages[site] || []).length;
            el.textContent = count + ' photo' + (count !== 1 ? 's' : '');
        });
    }

    // --- Init: auto-login if token exists ---
    if (authToken) {
        showDashboard();
    }
</script>
</body>
</html>
