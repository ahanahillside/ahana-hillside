<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Ahana Hillside</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-stone: #A69583;
            --color-forest: #2C3E2D;
            --color-cream: #F5F2EE;
            --color-charcoal: #3D3D3D;
            --color-light-stone: #e8e0d8;
            --color-success: #5a9a5a;
            --color-error: #b44;

            --font-serif: 'Cormorant Garamond', Georgia, serif;
            --font-sans: 'DM Sans', -apple-system, sans-serif;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-cream);
            color: var(--color-charcoal);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Login screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 3rem 2.5rem;
            max-width: 380px;
            width: 100%;
            text-align: center;
        }

        .login-card h1 {
            font-family: var(--font-serif);
            font-size: 1.6rem;
            font-weight: 500;
            color: var(--color-forest);
            margin-bottom: 0.25rem;
        }

        .login-card .subtitle {
            font-size: 0.8rem;
            color: var(--color-stone);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 2rem;
        }

        .login-card input {
            width: 100%;
            padding: 0.7rem 0.85rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            color: var(--color-charcoal);
            outline: none;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .login-card input:focus { border-color: var(--color-forest); }

        .login-error {
            display: none;
            font-size: 0.8rem;
            color: var(--color-error);
            margin-bottom: 1rem;
        }

        .login-error.show { display: block; }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.show { display: block; }

        .dash-header {
            background: var(--color-forest);
            color: var(--color-cream);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dash-header h1 {
            font-family: var(--font-serif);
            font-size: 1.3rem;
            font-weight: 500;
        }

        .dash-header .logout-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--color-cream);
            padding: 0.4rem 1rem;
            font-family: var(--font-sans);
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dash-header .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Main tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--color-light-stone);
            padding: 0 2rem;
            background: #fff;
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.85rem 1.5rem;
            font-family: var(--font-sans);
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--color-stone);
            cursor: pointer;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-btn:hover { color: var(--color-charcoal); }
        .tab-btn.active {
            color: var(--color-forest);
            border-bottom-color: var(--color-forest);
        }

        /* Sub-tabs (inside Campsites) */
        .sub-tabs {
            display: none;
            padding: 0 2rem;
            background: #fff;
            border-bottom: 1px solid var(--color-light-stone);
            overflow-x: auto;
        }

        .sub-tabs.show { display: flex; }

        .sub-tab-btn {
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.65rem 1.25rem;
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            color: var(--color-stone);
            cursor: pointer;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
        }

        .sub-tab-btn:hover { color: var(--color-charcoal); }
        .sub-tab-btn.active {
            color: var(--color-forest);
            border-bottom-color: var(--color-forest);
        }

        /* Tab content */
        .tab-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .sub-panel { display: none; }
        .sub-panel.active { display: block; }

        .panel-title {
            font-family: var(--font-serif);
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--color-forest);
            margin-bottom: 0.25rem;
        }

        .panel-desc {
            font-size: 0.85rem;
            color: var(--color-stone);
            margin-bottom: 1.5rem;
        }

        /* Cards */
        .section-divider {
            border: none;
            border-top: 1px solid var(--color-light-stone);
            margin: 2rem 0 1.5rem;
        }

        .section-heading {
            font-family: var(--font-serif);
            font-size: 1.15rem;
            font-weight: 500;
            color: var(--color-forest);
            margin-bottom: 0.25rem;
        }

        .section-desc {
            font-size: 0.8rem;
            color: var(--color-stone);
            margin-bottom: 1rem;
        }

        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 1.5rem;
        }

        .card-title {
            font-family: var(--font-serif);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-forest);
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-light-stone);
        }

        .field {
            margin-bottom: 1rem;
        }

        .field:last-child { margin-bottom: 0; }

        .field label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-stone);
            margin-bottom: 0.3rem;
        }

        .field input,
        .field select,
        .field textarea {
            width: 100%;
            padding: 0.55rem 0.65rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 0.85rem;
            color: var(--color-charcoal);
            outline: none;
            transition: border-color 0.2s;
        }

        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            border-color: var(--color-forest);
        }

        .field textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        .field .hint {
            font-size: 0.7rem;
            color: var(--color-stone);
            margin-top: 0.2rem;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.65rem 1.75rem;
            font-family: var(--font-sans);
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid var(--color-forest);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .btn-primary {
            background: var(--color-forest);
            color: var(--color-cream);
        }

        .btn-primary:hover {
            background: transparent;
            color: var(--color-forest);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-forest);
        }

        .btn-secondary:hover {
            background: var(--color-forest);
            color: var(--color-cream);
        }

        .btn-danger {
            border-color: var(--color-error);
            background: transparent;
            color: var(--color-error);
            padding: 0.3rem 0.75rem;
            font-size: 0.7rem;
        }

        .btn-danger:hover {
            background: var(--color-error);
            color: #fff;
        }

        .save-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .save-msg {
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-msg.show { opacity: 1; }
        .save-msg.success { color: var(--color-success); }
        .save-msg.error { color: var(--color-error); }

        /* Promo / Rules list */
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.75rem;
            background: #fff;
            border: 1px solid var(--color-light-stone);
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .list-item .item-info {
            flex: 1;
        }

        .list-item .item-label {
            font-weight: 500;
            color: var(--color-forest);
        }

        .list-item .item-detail {
            font-size: 0.75rem;
            color: var(--color-stone);
        }

        .add-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .add-row input, .add-row select {
            padding: 0.5rem 0.6rem;
            border: 1px solid var(--color-light-stone);
            background: #fff;
            font-family: var(--font-sans);
            font-size: 0.8rem;
            color: var(--color-charcoal);
            outline: none;
        }

        .add-row input:focus, .add-row select:focus {
            border-color: var(--color-forest);
        }

        /* Message badge */
        .msg-badge {
            display: none;
            font-size: 0.6rem;
            background: var(--color-error);
            color: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            vertical-align: middle;
            margin-left: 0.3rem;
        }

        .msg-badge.show { display: inline-block; }

        /* Booking cards */
        .booking-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: none;
            border: 1px solid var(--color-light-stone);
            padding: 0.4rem 0.85rem;
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            color: var(--color-stone);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover { border-color: var(--color-forest); color: var(--color-charcoal); }
        .filter-btn.active { background: var(--color-forest); color: #fff; border-color: var(--color-forest); }

        .filter-btn .filter-count {
            display: inline-block;
            font-size: 0.6rem;
            background: rgba(0,0,0,0.15);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            margin-left: 0.3rem;
            vertical-align: middle;
        }

        .filter-btn.active .filter-count {
            background: rgba(255,255,255,0.25);
        }

        .booking-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .booking-card.status-pending { border-left: 3px solid #e67e22; }
        .booking-card.status-confirmed { border-left: 3px solid var(--color-success); }
        .booking-card.status-cancelled { border-left: 3px solid var(--color-error); }
        .booking-card.status-completed { border-left: 3px solid var(--color-stone); }

        .booking-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .booking-site {
            font-family: var(--font-serif);
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-forest);
        }

        .booking-status {
            font-size: 0.65rem;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.2rem 0.6rem;
            border-radius: 2px;
        }

        .booking-status.st-pending { background: #fef3e2; color: #e67e22; }
        .booking-status.st-confirmed { background: #e8f5e9; color: #4a8c4a; }
        .booking-status.st-cancelled { background: #fde8e8; color: #b44; }
        .booking-status.st-completed { background: #f0ece8; color: var(--color-stone); }

        .booking-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem 1.5rem;
            margin-bottom: 0.75rem;
        }

        .booking-detail-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-stone);
        }

        .booking-detail-value {
            font-size: 0.85rem;
            color: var(--color-charcoal);
        }

        .booking-detail-value a {
            color: var(--color-forest);
            text-decoration: none;
            border-bottom: 1px solid var(--color-light-stone);
        }

        .booking-detail-value a:hover { border-color: var(--color-forest); }

        .booking-pricing {
            font-size: 0.8rem;
            color: var(--color-charcoal);
            padding: 0.5rem 0.75rem;
            background: #fff;
            margin-bottom: 0.75rem;
        }

        .booking-pricing strong {
            color: var(--color-forest);
        }

        .booking-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-light-stone);
            flex-wrap: wrap;
        }

        .booking-date-submitted {
            font-size: 0.7rem;
            color: var(--color-stone);
            margin-top: 0.3rem;
        }

        /* Message cards */
        .message-card {
            background: #fff;
            border: 1px solid var(--color-light-stone);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .message-card.unread {
            border-left: 3px solid var(--color-forest);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .message-from {
            font-weight: 500;
            color: var(--color-forest);
            font-size: 0.9rem;
        }

        .message-email {
            font-size: 0.75rem;
            color: var(--color-stone);
        }

        .message-date {
            font-size: 0.7rem;
            color: var(--color-stone);
            white-space: nowrap;
        }

        .message-subject {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--color-charcoal);
            margin-bottom: 0.4rem;
        }

        .message-body {
            font-size: 0.85rem;
            color: var(--color-charcoal);
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-light-stone);
        }

        /* Calendar */
        .cal-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .cal-nav-btn {
            background: none;
            border: 1px solid var(--color-light-stone);
            padding: 0.3rem 0.75rem;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--color-charcoal);
            transition: border-color 0.2s;
        }

        .cal-nav-btn:hover { border-color: var(--color-forest); }

        .cal-month-label {
            font-family: var(--font-serif);
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-forest);
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .cal-header-cell {
            text-align: center;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-stone);
            padding: 0.3rem 0;
        }

        .cal-cell {
            text-align: center;
            padding: 0.4rem 0;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background 0.15s, color 0.15s;
            user-select: none;
        }

        .cal-cell:hover { background: var(--color-light-stone); }

        .cal-cell.empty {
            cursor: default;
        }

        .cal-cell.empty:hover { background: none; }

        .cal-cell.past {
            color: #ccc;
            cursor: default;
        }

        .cal-cell.past:hover { background: none; }

        .cal-cell.blocked {
            background: #c0392b;
            color: #fff;
            border-radius: 2px;
        }

        .cal-cell.blocked:hover {
            background: #a93226;
        }

        .cal-cell.today {
            border: 1px solid var(--color-forest);
            font-weight: 600;
        }

        .cal-legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1.5rem;
            font-size: 0.75rem;
            color: var(--color-stone);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .legend-swatch {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 1px solid var(--color-light-stone);
        }

        .legend-available { background: #fff; }
        .legend-blocked { background: #c0392b; border-color: #c0392b; }
        .legend-past { background: #f0f0f0; }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--color-light-stone);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-bottom: 0.75rem;
            color: var(--color-stone);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--color-forest);
            background: rgba(44, 62, 45, 0.03);
        }

        .upload-zone svg {
            display: block;
            margin: 0 auto 0.5rem;
            color: var(--color-stone);
        }

        .upload-zone span {
            font-size: 0.8rem;
        }

        .upload-progress {
            font-size: 0.75rem;
            color: var(--color-stone);
            margin-bottom: 0.5rem;
            min-height: 1em;
        }

        /* Image grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .img-thumb {
            position: relative;
            aspect-ratio: 4/3;
            border: 1px solid var(--color-light-stone);
            overflow: hidden;
            background: #eee;
        }

        .img-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .img-thumb .img-order {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 2px;
        }

        .img-thumb .img-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 1px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .img-thumb:hover .img-actions {
            opacity: 1;
        }

        .img-action-btn {
            flex: 1;
            padding: 4px 0;
            border: none;
            font-size: 0.6rem;
            font-family: var(--font-sans);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .img-action-btn.move-btn {
            background: rgba(44, 62, 45, 0.85);
            color: #fff;
        }

        .img-action-btn.delete-btn {
            background: rgba(187, 68, 68, 0.85);
            color: #fff;
        }

        .img-empty {
            font-size: 0.8rem;
            color: var(--color-stone);
            padding: 0.5rem 0;
            grid-column: 1 / -1;
        }

        /* Responsive */
        @media (max-width: 700px) {
            .card-grid { grid-template-columns: 1fr; }
            .tabs { padding: 0 1rem; }
            .sub-tabs { padding: 0 1rem; }
            .tab-content { padding: 1.5rem 1rem; }
            .tab-btn { padding: 0.75rem 1rem; font-size: 0.75rem; }
            .sub-tab-btn { padding: 0.55rem 0.85rem; font-size: 0.7rem; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="login-screen">
    <div class="login-card">
        <h1>Ahana Hillside</h1>
        <div class="subtitle">Admin Dashboard</div>
        <form onsubmit="handleLogin(event)">
            <input type="password" id="login-password" placeholder="Enter admin password" autocomplete="current-password" required>
            <div class="login-error" id="login-error">Invalid password. Please try again.</div>
            <button type="submit" class="btn btn-primary" style="width:100%">Sign In</button>
        </form>
    </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
    <div class="dash-header">
        <h1>Ahana Hillside — Admin</h1>
        <button class="logout-btn" onclick="handleLogout()">Log out</button>
    </div>

    <!-- Main tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="messages">Messages <span class="msg-badge" id="msg-badge"></span></button>
        <button class="tab-btn" data-tab="bookings">Bookings <span class="msg-badge" id="booking-badge"></span></button>
        <button class="tab-btn" data-tab="campsites">Campsites</button>
        <button class="tab-btn" data-tab="settings">Settings</button>
    </div>

    <!-- Sub-tabs for Campsites -->
    <div class="sub-tabs" id="campsites-sub-tabs">
        <button class="sub-tab-btn active" data-subtab="availability">Availability</button>
        <button class="sub-tab-btn" data-subtab="content">Content &amp; Media</button>
        <button class="sub-tab-btn" data-subtab="pricing">Pricing &amp; Promos</button>
    </div>

    <div class="tab-content">

        <!-- MESSAGES PANEL -->
        <div class="tab-panel active" id="panel-messages">
            <div class="panel-title">Messages</div>
            <div class="panel-desc">Messages from visitors via the Contact Us page.</div>
            <div id="messages-list"><div style="font-size:0.85rem;color:var(--color-stone);padding:1rem 0;">Loading messages...</div></div>
        </div>

        <!-- BOOKINGS PANEL -->
        <div class="tab-panel" id="panel-bookings">
            <div class="panel-title">Bookings</div>
            <div class="panel-desc">View and manage guest bookings. Update status to keep track of confirmed, cancelled and completed stays.</div>

            <div class="booking-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterBookings('all')">All</button>
                <button class="filter-btn" data-filter="pending" onclick="filterBookings('pending')">Pending</button>
                <button class="filter-btn" data-filter="confirmed" onclick="filterBookings('confirmed')">Confirmed</button>
                <button class="filter-btn" data-filter="cancelled" onclick="filterBookings('cancelled')">Cancelled</button>
                <button class="filter-btn" data-filter="completed" onclick="filterBookings('completed')">Completed</button>
            </div>

            <div id="bookings-list"><div style="font-size:0.85rem;color:var(--color-stone);padding:1rem 0;">Loading bookings...</div></div>
        </div>

        <!-- CAMPSITES PANEL (contains sub-panels) -->
        <div class="tab-panel" id="panel-campsites">

            <!-- Availability sub-panel -->
            <div class="sub-panel active" id="subpanel-availability">
                <div class="panel-title">Availability</div>
                <div class="panel-desc">Click dates to block or unblock them. Blocked dates cannot be booked by guests. Red = blocked.</div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">SAMAVAS</div>
                        <div class="cal-nav">
                            <button class="cal-nav-btn" onclick="calNav('samavas', -1)">&larr;</button>
                            <span class="cal-month-label" id="cal-label-samavas"></span>
                            <button class="cal-nav-btn" onclick="calNav('samavas', 1)">&rarr;</button>
                        </div>
                        <div class="cal-grid" id="cal-grid-samavas"></div>
                        <div class="save-bar" style="margin-top:1rem">
                            <button class="btn btn-primary" onclick="saveBlockedDates('samavas')">Save</button>
                            <span class="save-msg" id="avail-samavas-msg"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">CHHAYA</div>
                        <div class="cal-nav">
                            <button class="cal-nav-btn" onclick="calNav('chhaya', -1)">&larr;</button>
                            <span class="cal-month-label" id="cal-label-chhaya"></span>
                            <button class="cal-nav-btn" onclick="calNav('chhaya', 1)">&rarr;</button>
                        </div>
                        <div class="cal-grid" id="cal-grid-chhaya"></div>
                        <div class="save-bar" style="margin-top:1rem">
                            <button class="btn btn-primary" onclick="saveBlockedDates('chhaya')">Save</button>
                            <span class="save-msg" id="avail-chhaya-msg"></span>
                        </div>
                    </div>
                </div>

                <div class="cal-legend">
                    <span class="legend-item"><span class="legend-swatch legend-available"></span> Available</span>
                    <span class="legend-item"><span class="legend-swatch legend-blocked"></span> Blocked</span>
                    <span class="legend-item"><span class="legend-swatch legend-past"></span> Past</span>
                </div>
            </div>

            <!-- Content & Media sub-panel (Images + Content + Rules) -->
            <div class="sub-panel" id="subpanel-content">
                <div class="panel-title">Content &amp; Media</div>
                <div class="panel-desc">Manage campsite photos, descriptions, and campground rules.</div>

                <!-- Images section -->
                <div class="section-heading">Images</div>
                <div class="section-desc">Upload, reorder, and manage photos. First image is the cover photo. Max 15 per site, 5MB each (JPEG, PNG, WebP).</div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">SAMAVAS</div>
                        <div class="upload-zone" id="upload-zone-samavas" onclick="document.getElementById('file-samavas').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Click to upload or drag & drop</span>
                            <input type="file" id="file-samavas" accept="image/jpeg,image/png,image/webp" multiple style="display:none" onchange="handleFileSelect('samavas', this.files)">
                        </div>
                        <div class="upload-progress" id="progress-samavas"></div>
                        <div class="image-grid" id="images-samavas"></div>
                    </div>

                    <div class="card">
                        <div class="card-title">CHHAYA</div>
                        <div class="upload-zone" id="upload-zone-chhaya" onclick="document.getElementById('file-chhaya').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Click to upload or drag & drop</span>
                            <input type="file" id="file-chhaya" accept="image/jpeg,image/png,image/webp" multiple style="display:none" onchange="handleFileSelect('chhaya', this.files)">
                        </div>
                        <div class="upload-progress" id="progress-chhaya"></div>
                        <div class="image-grid" id="images-chhaya"></div>
                    </div>
                </div>

                <!-- Site descriptions section -->
                <hr class="section-divider">
                <div class="section-heading">Descriptions</div>
                <div class="section-desc">Edit the description and details shown on each campsite card.</div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">SAMAVAS</div>
                        <div class="field">
                            <label>Site type line</label>
                            <input type="text" id="c-samavas-type">
                            <div class="hint">e.g. "RV / Tent Site &middot; Sleeps 15 &middot; Vehicles under 30 m"</div>
                        </div>
                        <div class="field">
                            <label>Description</label>
                            <textarea id="c-samavas-desc" rows="4"></textarea>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">CHHAYA</div>
                        <div class="field">
                            <label>Site type line</label>
                            <input type="text" id="c-chhaya-type">
                            <div class="hint">e.g. "RV / Tent Site &middot; Sleeps 6 &middot; Vehicles under 24 m"</div>
                        </div>
                        <div class="field">
                            <label>Description</label>
                            <textarea id="c-chhaya-desc" rows="4"></textarea>
                        </div>
                    </div>
                </div>

                <div class="save-bar">
                    <button class="btn btn-primary" onclick="saveConfig('content')">Save Content</button>
                    <span class="save-msg" id="content-msg"></span>
                </div>

                <!-- Rules section -->
                <hr class="section-divider">
                <div class="section-heading">Campground Rules</div>
                <div class="section-desc">Edit the rules shown at the bottom of the campsites page.</div>

                <div id="rules-list"></div>

                <div class="add-row">
                    <input type="text" id="rule-text" placeholder="New rule..." style="flex:1">
                    <button class="btn btn-secondary" onclick="addRule()" style="padding:0.5rem 1rem">Add</button>
                </div>

                <div class="save-bar">
                    <button class="btn btn-primary" onclick="saveConfig('rules')">Save Rules</button>
                    <span class="save-msg" id="rules-msg"></span>
                </div>
            </div>

            <!-- Pricing & Promos sub-panel -->
            <div class="sub-panel" id="subpanel-pricing">
                <div class="panel-title">Pricing &amp; Promos</div>
                <div class="panel-desc">Set base prices, extra guest fees, and manage discount codes.</div>

                <!-- Pricing section -->
                <div class="section-heading">Pricing</div>
                <div class="section-desc">Prices are per night. Base price covers 1-2 guests.</div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">SAMAVAS</div>
                        <div class="field">
                            <label>Base price per night (1-2 guests)</label>
                            <input type="number" id="p-samavas-base" min="0" step="1">
                            <div class="hint">Shown as "from AU$XX / night" on the site</div>
                        </div>
                        <div class="field">
                            <label>Extra guest fee (per person per night)</label>
                            <input type="number" id="p-samavas-extra" min="0" step="1">
                            <div class="hint">Charged for each guest above 2</div>
                        </div>
                        <div class="field">
                            <label>Maximum guests</label>
                            <input type="number" id="p-samavas-max" min="1" max="50" step="1">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">CHHAYA</div>
                        <div class="field">
                            <label>Base price per night (1-2 guests)</label>
                            <input type="number" id="p-chhaya-base" min="0" step="1">
                            <div class="hint">Shown as "from AU$XX / night" on the site</div>
                        </div>
                        <div class="field">
                            <label>Extra guest fee (per person per night)</label>
                            <input type="number" id="p-chhaya-extra" min="0" step="1">
                            <div class="hint">Charged for each guest above 2</div>
                        </div>
                        <div class="field">
                            <label>Maximum guests</label>
                            <input type="number" id="p-chhaya-max" min="1" max="50" step="1">
                        </div>
                    </div>
                </div>

                <div class="field" style="max-width:200px">
                    <label>Currency</label>
                    <select id="p-currency">
                        <option value="AUD">AUD (AU$)</option>
                        <option value="USD">USD (US$)</option>
                        <option value="EUR">EUR (&euro;)</option>
                        <option value="GBP">GBP (&pound;)</option>
                    </select>
                </div>

                <div class="save-bar">
                    <button class="btn btn-primary" onclick="saveConfig('pricing')">Save Pricing</button>
                    <span class="save-msg" id="pricing-msg"></span>
                </div>

                <!-- Promo Codes section -->
                <hr class="section-divider">
                <div class="section-heading">Promo Codes</div>
                <div class="section-desc">Discount codes that guests can use when booking. These are independent of Hipcamp.</div>

                <div id="promo-list"></div>

                <div class="add-row">
                    <input type="text" id="promo-code" placeholder="Code (e.g. WELCOME10)" style="flex:1;min-width:140px;text-transform:uppercase">
                    <select id="promo-type" style="width:120px">
                        <option value="percent">Percentage %</option>
                        <option value="fixed">Fixed amount $</option>
                    </select>
                    <input type="number" id="promo-value" placeholder="Value" min="0" step="1" style="width:80px">
                    <button class="btn btn-secondary" onclick="addPromo()" style="padding:0.5rem 1rem">Add</button>
                </div>

                <div class="save-bar">
                    <button class="btn btn-primary" onclick="saveConfig('promos')">Save Promo Codes</button>
                    <span class="save-msg" id="promos-msg"></span>
                </div>
            </div>

        </div>

        <!-- SETTINGS PANEL -->
        <div class="tab-panel" id="panel-settings">
            <div class="panel-title">Settings</div>
            <div class="panel-desc">Manage payments, email notifications, and dashboard password.</div>

            <div class="card" style="max-width:500px;margin-bottom:1.5rem">
                <div class="card-title">Email Notifications</div>
                <p style="font-size:0.8rem;color:var(--color-stone);margin-bottom:1rem;line-height:1.5">
                    Receive an email when a new booking is submitted. Uses <a href="https://resend.com" target="_blank" style="color:var(--color-forest)">Resend</a> to send emails (free tier: 100 emails/day).
                </p>

                <div class="field">
                    <label style="display:flex;align-items:center;gap:0.5rem;text-transform:none;font-size:0.85rem;letter-spacing:0">
                        <input type="checkbox" id="notif-enabled" style="width:auto;margin:0;padding:0">
                        Enable email notifications
                    </label>
                </div>

                <div class="field">
                    <label>Notification email</label>
                    <input type="email" id="notif-email" placeholder="your@email.com">
                    <div class="hint">Where booking notifications will be sent</div>
                </div>

                <div class="field">
                    <label>Resend API key</label>
                    <input type="password" id="notif-api-key" placeholder="re_xxxxxxxxx...">
                    <div class="hint">Get your API key from <a href="https://resend.com/api-keys" target="_blank" style="color:var(--color-forest)">resend.com/api-keys</a></div>
                </div>

                <div class="field">
                    <label>From email (optional)</label>
                    <input type="text" id="notif-from-email" placeholder="bookings@yourdomain.com">
                    <div class="hint">Requires a verified domain in Resend. Leave blank to use Resend's default.</div>
                </div>

                <div class="save-bar" style="margin-top:1rem">
                    <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Notifications</button>
                    <span class="save-msg" id="notif-msg"></span>
                </div>
            </div>

            <div class="card" style="max-width:500px;margin-bottom:1.5rem">
                <div class="card-title">Stripe Payments</div>
                <p style="font-size:0.8rem;color:var(--color-stone);margin-bottom:1rem;line-height:1.5">
                    Collect payments when guests book. Uses <a href="https://stripe.com" target="_blank" style="color:var(--color-forest)">Stripe</a> Checkout — guests are redirected to a secure Stripe-hosted payment page.
                </p>

                <div class="field">
                    <label style="display:flex;align-items:center;gap:0.5rem;text-transform:none;font-size:0.85rem;letter-spacing:0">
                        <input type="checkbox" id="stripe-enabled" style="width:auto;margin:0;padding:0">
                        Enable Stripe payments
                    </label>
                </div>

                <div class="field">
                    <label>Secret key</label>
                    <input type="password" id="stripe-secret-key" placeholder="sk_live_... or sk_test_...">
                    <div class="hint">Find this in your <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color:var(--color-forest)">Stripe Dashboard</a> &rarr; Developers &rarr; API keys</div>
                </div>

                <div class="field">
                    <label>Webhook signing secret</label>
                    <input type="password" id="stripe-webhook-secret" placeholder="whsec_...">
                    <div class="hint">
                        Create a webhook in Stripe pointing to:<br>
                        <code style="font-size:0.7rem;background:var(--color-cream);padding:2px 6px;border:1px solid var(--color-light-stone);word-break:break-all">https://ahana-ical-proxy.ahanahillside.workers.dev/stripe-webhook</code><br>
                        Listen for the <strong>checkout.session.completed</strong> event.
                    </div>
                </div>

                <div class="save-bar" style="margin-top:1rem">
                    <button class="btn btn-primary" onclick="saveStripeSettings()">Save Stripe Settings</button>
                    <span class="save-msg" id="stripe-msg"></span>
                </div>
            </div>

            <div class="card" style="max-width:500px">
                <div class="card-title">Change Password</div>
                <div class="field">
                    <label>New password</label>
                    <input type="password" id="new-password" placeholder="Min. 6 characters" minlength="6">
                </div>
                <div class="field">
                    <label>Confirm new password</label>
                    <input type="password" id="confirm-password" placeholder="Re-enter password">
                </div>
                <div class="save-bar" style="margin-top:1rem">
                    <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
                    <span class="save-msg" id="settings-msg"></span>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const WORKER_URL = 'https://ahana-ical-proxy.ahanahillside.workers.dev';
    let authToken = sessionStorage.getItem('ahana-token') || '';
    let siteConfig = null;

    // --- Auth ---
    async function handleLogin(e) {
        e.preventDefault();
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');
        errorEl.classList.remove('show');

        try {
            const res = await fetch(WORKER_URL + '/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password }),
            });
            const data = await res.json();
            if (data.success) {
                authToken = data.token;
                sessionStorage.setItem('ahana-token', authToken);
                showDashboard();
            } else {
                errorEl.textContent = res.status === 429
                    ? 'Too many failed attempts. Try again in 15 minutes.'
                    : 'Invalid password';
                errorEl.classList.add('show');
            }
        } catch (err) {
            errorEl.textContent = 'Connection error. Is the worker deployed?';
            errorEl.classList.add('show');
        }
    }

    function handleLogout() {
        authToken = '';
        sessionStorage.removeItem('ahana-token');
        document.getElementById('dashboard').classList.remove('show');
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('login-password').value = '';
    }

    async function showDashboard() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').classList.add('show');
        loadConfig();
        loadMessages();
        loadBookings();
        loadImages();
        loadBlockedDates();
        loadNotificationSettings();
        loadStripeSettings();
    }

    // --- Config ---
    async function loadConfig() {
        try {
            const res = await fetch(WORKER_URL + '/config');
            siteConfig = await res.json();
        } catch (err) {
            siteConfig = null;
            showMsg('pricing', 'Could not load config from worker', 'error');
            return;
        }
        populateFields();
    }

    function populateFields() {
        if (!siteConfig) return;
        const c = siteConfig;

        // Pricing
        document.getElementById('p-samavas-base').value = c.samavas?.basePrice ?? 66;
        document.getElementById('p-samavas-extra').value = c.samavas?.extraGuestFee ?? 15;
        document.getElementById('p-samavas-max').value = c.samavas?.maxGuests ?? 20;
        document.getElementById('p-chhaya-base').value = c.chhaya?.basePrice ?? 60;
        document.getElementById('p-chhaya-extra').value = c.chhaya?.extraGuestFee ?? 10;
        document.getElementById('p-chhaya-max').value = c.chhaya?.maxGuests ?? 20;
        document.getElementById('p-currency').value = c.currency || 'AUD';

        // Content
        document.getElementById('c-samavas-type').value = c.samavas?.type || '';
        document.getElementById('c-samavas-desc').value = c.samavas?.description || '';
        document.getElementById('c-chhaya-type').value = c.chhaya?.type || '';
        document.getElementById('c-chhaya-desc').value = c.chhaya?.description || '';

        // Promo codes
        renderPromos();

        // Rules
        renderRules();
    }

    function gatherConfig() {
        return {
            samavas: {
                name: 'SAMAVAS',
                type: document.getElementById('c-samavas-type').value,
                description: document.getElementById('c-samavas-desc').value,
                basePrice: parseFloat(document.getElementById('p-samavas-base').value) || 0,
                extraGuestFee: parseFloat(document.getElementById('p-samavas-extra').value) || 0,
                maxGuests: parseInt(document.getElementById('p-samavas-max').value) || 20,
            },
            chhaya: {
                name: 'CHHAYA',
                type: document.getElementById('c-chhaya-type').value,
                description: document.getElementById('c-chhaya-desc').value,
                basePrice: parseFloat(document.getElementById('p-chhaya-base').value) || 0,
                extraGuestFee: parseFloat(document.getElementById('p-chhaya-extra').value) || 0,
                maxGuests: parseInt(document.getElementById('p-chhaya-max').value) || 20,
            },
            currency: document.getElementById('p-currency').value,
            promoCodes: siteConfig.promoCodes || {},
            rules: siteConfig.rules || [],
        };
    }

    async function saveConfig(source) {
        siteConfig = gatherConfig();

        try {
            const res = await fetch(WORKER_URL + '/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify(siteConfig),
            });
            const data = await res.json();
            if (data.success) {
                showMsg(source, 'Saved successfully', 'success');
            } else if (data.error === 'Unauthorized') {
                showMsg(source, 'Session expired. Please log in again.', 'error');
            } else {
                showMsg(source, 'Error: ' + (data.error || 'Unknown'), 'error');
            }
        } catch (err) {
            showMsg(source, 'Connection error', 'error');
        }
    }

    async function changePassword() {
        const newPwd = document.getElementById('new-password').value;
        const confirmPwd = document.getElementById('confirm-password').value;

        if (newPwd.length < 6) {
            showMsg('settings', 'Password must be at least 6 characters', 'error');
            return;
        }
        if (newPwd !== confirmPwd) {
            showMsg('settings', 'Passwords do not match', 'error');
            return;
        }

        try {
            const res = await fetch(WORKER_URL + '/password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify({ newPassword: newPwd }),
            });
            const data = await res.json();
            if (data.success) {
                authToken = newPwd;
                sessionStorage.setItem('ahana-token', authToken);
                showMsg('settings', 'Password updated', 'success');
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } else {
                showMsg('settings', data.error || 'Failed to update', 'error');
            }
        } catch (err) {
            showMsg('settings', 'Connection error', 'error');
        }
    }

    // --- Stripe Settings ---
    async function loadStripeSettings() {
        try {
            const res = await fetch(WORKER_URL + '/stripe-settings', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            const s = data.settings || {};
            document.getElementById('stripe-enabled').checked = !!s.enabled;
            // Show masked keys as placeholders — never populate the actual value
            const skInput = document.getElementById('stripe-secret-key');
            const whInput = document.getElementById('stripe-webhook-secret');
            skInput.value = '';
            whInput.value = '';
            skInput.placeholder = s.maskedSecretKey || 'sk_live_... or sk_test_...';
            whInput.placeholder = s.maskedWebhookSecret || 'whsec_...';
            // Store whether keys exist so we can validate on save
            skInput.dataset.hasKey = s.hasSecretKey ? '1' : '';
            whInput.dataset.hasKey = s.hasWebhookSecret ? '1' : '';
        } catch (err) {}
    }

    async function saveStripeSettings() {
        const skInput = document.getElementById('stripe-secret-key');
        const whInput = document.getElementById('stripe-webhook-secret');
        const newSecretKey = skInput.value.trim();
        const newWebhookSecret = whInput.value.trim();
        const hasExistingKey = skInput.dataset.hasKey === '1';
        const enabled = document.getElementById('stripe-enabled').checked;

        if (enabled && !newSecretKey && !hasExistingKey) {
            showMsg('stripe', 'Please enter your Stripe secret key', 'error');
            return;
        }

        // Only send keys if user entered new ones
        const settings = { enabled };
        if (newSecretKey) settings.secretKey = newSecretKey;
        if (newWebhookSecret) settings.webhookSecret = newWebhookSecret;

        try {
            const res = await fetch(WORKER_URL + '/stripe-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify(settings),
            });
            const data = await res.json();
            if (data.success) {
                showMsg('stripe', 'Stripe settings saved', 'success');
                loadStripeSettings(); // Reload to show updated masked keys
            } else {
                showMsg('stripe', data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showMsg('stripe', 'Connection error', 'error');
        }
    }

    // --- Notification Settings ---
    async function loadNotificationSettings() {
        try {
            const res = await fetch(WORKER_URL + '/notification-settings', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            const s = data.settings || {};
            document.getElementById('notif-enabled').checked = !!s.enabled;
            document.getElementById('notif-email').value = s.email || '';
            document.getElementById('notif-from-email').value = s.fromEmail || '';
            // Show masked API key as placeholder — never populate the actual value
            const akInput = document.getElementById('notif-api-key');
            akInput.value = '';
            akInput.placeholder = s.maskedApiKey || 're_xxxxxxxxx...';
            akInput.dataset.hasKey = s.hasApiKey ? '1' : '';
        } catch (err) {}
    }

    async function saveNotificationSettings() {
        const akInput = document.getElementById('notif-api-key');
        const newApiKey = akInput.value.trim();
        const hasExistingKey = akInput.dataset.hasKey === '1';
        const enabled = document.getElementById('notif-enabled').checked;

        const settings = {
            enabled,
            email: document.getElementById('notif-email').value.trim(),
            fromEmail: document.getElementById('notif-from-email').value.trim(),
        };
        // Only send API key if user entered a new one
        if (newApiKey) settings.apiKey = newApiKey;

        if (settings.enabled && !settings.email) {
            showMsg('notif', 'Please enter a notification email address', 'error');
            return;
        }
        if (settings.enabled && !newApiKey && !hasExistingKey) {
            showMsg('notif', 'Please enter a Resend API key', 'error');
            return;
        }

        try {
            const res = await fetch(WORKER_URL + '/notification-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                },
                body: JSON.stringify(settings),
            });
            const data = await res.json();
            if (data.success) {
                showMsg('notif', 'Notification settings saved', 'success');
                loadNotificationSettings(); // Reload to show updated masked key
            } else {
                showMsg('notif', data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showMsg('notif', 'Connection error', 'error');
        }
    }

    // --- Promo codes ---
    function renderPromos() {
        const container = document.getElementById('promo-list');
        const codes = siteConfig.promoCodes || {};
        const keys = Object.keys(codes);

        if (keys.length === 0) {
            container.innerHTML = '<div style="font-size:0.85rem;color:var(--color-stone);padding:0.5rem 0;">No promo codes yet.</div>';
            return;
        }

        container.innerHTML = keys.map(code => {
            const p = codes[code];
            const label = p.type === 'percent' ? p.value + '% off' : 'AU$' + p.value + ' off';
            return '<div class="list-item">'
                + '<div class="item-info"><span class="item-label">' + code + '</span> <span class="item-detail">' + label + '</span></div>'
                + '<button class="btn btn-danger" onclick="removePromo(\'' + code + '\')">Remove</button>'
                + '</div>';
        }).join('');
    }

    function addPromo() {
        const codeEl = document.getElementById('promo-code');
        const typeEl = document.getElementById('promo-type');
        const valueEl = document.getElementById('promo-value');

        const code = codeEl.value.trim().toUpperCase();
        const type = typeEl.value;
        const value = parseFloat(valueEl.value);

        if (!code || !value || value <= 0) return;

        if (!siteConfig.promoCodes) siteConfig.promoCodes = {};
        siteConfig.promoCodes[code] = { type, value };

        codeEl.value = '';
        valueEl.value = '';
        renderPromos();
    }

    function removePromo(code) {
        delete siteConfig.promoCodes[code];
        renderPromos();
    }

    // --- Rules ---
    function renderRules() {
        const container = document.getElementById('rules-list');
        const rules = siteConfig.rules || [];

        if (rules.length === 0) {
            container.innerHTML = '<div style="font-size:0.85rem;color:var(--color-stone);padding:0.5rem 0;">No rules yet.</div>';
            return;
        }

        container.innerHTML = rules.map((rule, i) => {
            return '<div class="list-item">'
                + '<div class="item-info">' + rule + '</div>'
                + '<button class="btn btn-danger" onclick="removeRule(' + i + ')">Remove</button>'
                + '</div>';
        }).join('');
    }

    function addRule() {
        const input = document.getElementById('rule-text');
        const text = input.value.trim();
        if (!text) return;

        if (!siteConfig.rules) siteConfig.rules = [];
        siteConfig.rules.push(text);
        input.value = '';
        renderRules();
    }

    function removeRule(index) {
        siteConfig.rules.splice(index, 1);
        renderRules();
    }

    // --- Messages ---
    let messages = [];

    async function loadMessages() {
        try {
            const res = await fetch(WORKER_URL + '/messages', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            messages = data.messages || [];
            renderMessages();
            updateBadge();
        } catch (err) {
            document.getElementById('messages-list').innerHTML = '<div style="font-size:0.85rem;color:var(--color-error);padding:0.5rem 0;">Could not load messages.</div>';
        }
    }

    function renderMessages() {
        const container = document.getElementById('messages-list');

        if (messages.length === 0) {
            container.innerHTML = '<div style="font-size:0.85rem;color:var(--color-stone);padding:1rem 0;">No messages yet. Messages from the Contact Us page will appear here.</div>';
            return;
        }

        container.innerHTML = messages.map(m => {
            const date = new Date(m.date).toLocaleDateString('en-AU', {
                day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            return '<div class="message-card' + (m.read ? '' : ' unread') + '" data-id="' + m.id + '">'
                + '<div class="message-header">'
                + '<div><div class="message-from">' + escHtml(m.name) + '</div>'
                + '<div class="message-email">' + escHtml(m.email) + '</div></div>'
                + '<div class="message-date">' + date + '</div>'
                + '</div>'
                + (m.subject && m.subject !== 'No subject' ? '<div class="message-subject">' + escHtml(m.subject) + '</div>' : '')
                + '<div class="message-body">' + escHtml(m.message) + '</div>'
                + '<div class="message-actions">'
                + (m.read ? '' : '<button class="btn btn-secondary" onclick="markRead(\'' + m.id + '\')" style="padding:0.3rem 0.75rem;font-size:0.7rem">Mark read</button>')
                + '<a href="mailto:' + encodeURIComponent(m.email) + '?subject=Re: ' + encodeURIComponent(m.subject || 'Your message') + '" class="btn btn-secondary" style="padding:0.3rem 0.75rem;font-size:0.7rem;text-decoration:none">Reply</a>'
                + '<button class="btn btn-danger" onclick="deleteMessage(\'' + m.id + '\')">Delete</button>'
                + '</div>'
                + '</div>';
        }).join('');
    }

    function updateBadge() {
        const unread = messages.filter(m => !m.read).length;
        const badge = document.getElementById('msg-badge');
        if (unread > 0) {
            badge.textContent = unread;
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    }

    async function markRead(id) {
        try {
            await fetch(WORKER_URL + '/messages/read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id }),
            });
            const msg = messages.find(m => m.id === id);
            if (msg) msg.read = true;
            renderMessages();
            updateBadge();
        } catch (err) {}
    }

    async function deleteMessage(id) {
        if (!confirm('Delete this message?')) return;
        try {
            await fetch(WORKER_URL + '/messages/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id }),
            });
            messages = messages.filter(m => m.id !== id);
            renderMessages();
            updateBadge();
        } catch (err) {}
    }

    function escHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // --- Bookings ---
    let bookings = [];
    let bookingFilter = 'all';

    async function loadBookings() {
        try {
            const res = await fetch(WORKER_URL + '/bookings', {
                headers: { 'Authorization': 'Bearer ' + authToken },
            });
            const data = await res.json();
            bookings = data.bookings || [];
        } catch (err) {
            bookings = [];
        }
        renderBookings();
        updateBookingBadge();
    }

    function filterBookings(filter) {
        bookingFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.filter-btn[data-filter="' + filter + '"]').classList.add('active');
        renderBookings();
    }

    function renderBookings() {
        const container = document.getElementById('bookings-list');
        const filtered = bookingFilter === 'all' ? bookings : bookings.filter(b => b.status === bookingFilter);

        // Update filter counts
        const counts = { all: bookings.length, pending: 0, confirmed: 0, cancelled: 0, completed: 0 };
        bookings.forEach(b => { if (counts[b.status] !== undefined) counts[b.status]++; });
        document.querySelectorAll('.filter-btn').forEach(btn => {
            const f = btn.dataset.filter;
            const countEl = btn.querySelector('.filter-count');
            if (countEl) countEl.textContent = counts[f] || 0;
            else if (counts[f] > 0) {
                const span = document.createElement('span');
                span.className = 'filter-count';
                span.textContent = counts[f];
                btn.appendChild(span);
            }
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div style="font-size:0.85rem;color:var(--color-stone);padding:1rem 0;">No ' + (bookingFilter === 'all' ? '' : bookingFilter + ' ') + 'bookings yet.</div>';
            return;
        }

        container.innerHTML = filtered.map(b => {
            const sym = { AUD: 'AU$', USD: 'US$', EUR: '€', GBP: '£' }[b.currency] || 'AU$';
            const submitted = b.date ? new Date(b.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

            let actions = '';
            if (b.status === 'pending') {
                actions += '<button class="btn btn-primary" style="padding:0.3rem 0.75rem;font-size:0.7rem" onclick="updateBookingStatus(\'' + b.id + '\',\'confirmed\')">Confirm</button>';
                actions += '<button class="btn btn-danger" onclick="updateBookingStatus(\'' + b.id + '\',\'cancelled\')">Cancel</button>';
            } else if (b.status === 'confirmed') {
                actions += '<button class="btn btn-primary" style="padding:0.3rem 0.75rem;font-size:0.7rem" onclick="updateBookingStatus(\'' + b.id + '\',\'completed\')">Complete</button>';
                actions += '<button class="btn btn-danger" onclick="updateBookingStatus(\'' + b.id + '\',\'cancelled\')">Cancel</button>';
            } else if (b.status === 'cancelled' || b.status === 'completed') {
                actions += '<button class="btn btn-secondary" style="padding:0.3rem 0.75rem;font-size:0.7rem" onclick="updateBookingStatus(\'' + b.id + '\',\'pending\')">Reopen</button>';
            }
            actions += '<button class="btn btn-danger" onclick="deleteBooking(\'' + b.id + '\')">Delete</button>';

            let pricing = sym + (b.total || 0).toFixed(2) + ' total';
            if (b.promoCode) pricing += ' (promo: ' + escHtml(b.promoCode) + ')';

            return '<div class="booking-card status-' + b.status + '">'
                + '<div class="booking-top">'
                + '<div><span class="booking-site">' + escHtml(b.siteName || b.site) + '</span></div>'
                + '<span class="booking-status st-' + b.status + '">' + b.status + '</span>'
                + '</div>'
                + '<div class="booking-details">'
                + '<div><div class="booking-detail-label">Guest</div><div class="booking-detail-value">' + escHtml(b.name) + '</div></div>'
                + '<div><div class="booking-detail-label">Guests</div><div class="booking-detail-value">' + b.guests + '</div></div>'
                + '<div><div class="booking-detail-label">Email</div><div class="booking-detail-value"><a href="mailto:' + encodeURIComponent(b.email) + '">' + escHtml(b.email) + '</a></div></div>'
                + '<div><div class="booking-detail-label">Phone</div><div class="booking-detail-value"><a href="tel:' + encodeURIComponent(b.phone || '') + '">' + escHtml(b.phone || 'N/A') + '</a></div></div>'
                + '<div><div class="booking-detail-label">Check-in</div><div class="booking-detail-value">' + escHtml(b.checkin) + '</div></div>'
                + '<div><div class="booking-detail-label">Check-out</div><div class="booking-detail-value">' + escHtml(b.checkout) + '</div></div>'
                + '<div><div class="booking-detail-label">Nights</div><div class="booking-detail-value">' + b.nights + '</div></div>'
                + '<div><div class="booking-detail-label">Total</div><div class="booking-detail-value"><strong>' + pricing + '</strong></div></div>'
                + '</div>'
                + (b.paidAt ? '<div style="font-size:0.7rem;color:#4a8c4a;margin-top:0.3rem;font-weight:500">Paid via Stripe — ' + new Date(b.paidAt).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) + '</div>' : '')
                + '<div class="booking-date-submitted">Submitted ' + submitted + '</div>'
                + '<div class="booking-actions">'
                + '<a href="mailto:' + encodeURIComponent(b.email) + '?subject=Re: Booking at Ahana Hillside — ' + encodeURIComponent(b.siteName || '') + '" class="btn btn-secondary" style="padding:0.3rem 0.75rem;font-size:0.7rem;text-decoration:none">Email Guest</a>'
                + actions
                + '</div>'
                + '</div>';
        }).join('');
    }

    function updateBookingBadge() {
        const pending = bookings.filter(b => b.status === 'pending').length;
        const badge = document.getElementById('booking-badge');
        if (pending > 0) {
            badge.textContent = pending;
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    }

    async function updateBookingStatus(id, status) {
        try {
            await fetch(WORKER_URL + '/bookings/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id, status }),
            });
            const booking = bookings.find(b => b.id === id);
            if (booking) booking.status = status;
            renderBookings();
            updateBookingBadge();
        } catch (err) {}
    }

    async function deleteBooking(id) {
        if (!confirm('Delete this booking permanently?')) return;
        try {
            await fetch(WORKER_URL + '/bookings/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ id }),
            });
            bookings = bookings.filter(b => b.id !== id);
            renderBookings();
            updateBookingBadge();
        } catch (err) {}
    }

    // --- Availability / Blocked Dates ---
    const calState = {
        samavas: { year: new Date().getFullYear(), month: new Date().getMonth(), blocked: new Set() },
        chhaya:  { year: new Date().getFullYear(), month: new Date().getMonth(), blocked: new Set() },
    };

    async function loadBlockedDates() {
        for (const site of ['samavas', 'chhaya']) {
            try {
                const res = await fetch(WORKER_URL + '/blocked-dates/' + site);
                const data = await res.json();
                calState[site].blocked = new Set(data.blockedDates || []);
            } catch (err) {
                calState[site].blocked = new Set();
            }
            renderCalendar(site);
        }
    }

    function renderCalendar(site) {
        const state = calState[site];
        const year = state.year;
        const month = state.month;
        const grid = document.getElementById('cal-grid-' + site);
        const label = document.getElementById('cal-label-' + site);

        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        label.textContent = monthNames[month] + ' ' + year;

        const today = new Date();
        const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

        const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        let html = '';
        // Day headers
        ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
            html += '<div class="cal-header-cell">' + d + '</div>';
        });

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="cal-cell empty"></div>';
        }

        // Day cells
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
            const isPast = dateStr < todayStr;
            const isBlocked = state.blocked.has(dateStr);
            const isToday = dateStr === todayStr;

            let cls = 'cal-cell';
            if (isPast) cls += ' past';
            if (isBlocked) cls += ' blocked';
            if (isToday) cls += ' today';

            const clickHandler = isPast ? '' : ' onclick="toggleDate(\'' + site + '\',\'' + dateStr + '\')"';
            html += '<div class="' + cls + '"' + clickHandler + '>' + d + '</div>';
        }

        grid.innerHTML = html;
    }

    function toggleDate(site, dateStr) {
        const state = calState[site];
        if (state.blocked.has(dateStr)) {
            state.blocked.delete(dateStr);
        } else {
            state.blocked.add(dateStr);
        }
        renderCalendar(site);
    }

    function calNav(site, dir) {
        const state = calState[site];
        state.month += dir;
        if (state.month > 11) { state.month = 0; state.year++; }
        if (state.month < 0) { state.month = 11; state.year--; }
        renderCalendar(site);
    }

    async function saveBlockedDates(site) {
        const dates = [...calState[site].blocked].sort();
        try {
            const res = await fetch(WORKER_URL + '/blocked-dates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ site, dates }),
            });
            const data = await res.json();
            if (data.success) {
                showMsg('avail-' + site, 'Saved — ' + data.count + ' dates blocked', 'success');
            } else {
                showMsg('avail-' + site, data.error || 'Save failed', 'error');
            }
        } catch (err) {
            showMsg('avail-' + site, 'Connection error', 'error');
        }
    }

    // --- Images ---
    let siteImages = { samavas: [], chhaya: [] };

    async function loadImages() {
        for (const site of ['samavas', 'chhaya']) {
            try {
                const res = await fetch(WORKER_URL + '/images/list/' + site);
                const data = await res.json();
                siteImages[site] = data.images || [];
            } catch (err) {
                siteImages[site] = [];
            }
            renderImages(site);
        }
    }

    function renderImages(site) {
        const container = document.getElementById('images-' + site);
        const images = siteImages[site];

        if (images.length === 0) {
            container.innerHTML = '<div class="img-empty">No images uploaded yet.</div>';
            return;
        }

        container.innerHTML = images.map((img, i) => {
            const imgUrl = WORKER_URL + '/images/' + site + '/' + img.id;
            return '<div class="img-thumb">'
                + '<img src="' + imgUrl + '" alt="' + escHtml(img.name || '') + '" loading="lazy">'
                + '<span class="img-order">' + (i + 1) + '</span>'
                + '<div class="img-actions">'
                + (i > 0 ? '<button class="img-action-btn move-btn" onclick="moveImage(\'' + site + '\',' + i + ',-1)" title="Move left">&larr;</button>' : '')
                + (i < images.length - 1 ? '<button class="img-action-btn move-btn" onclick="moveImage(\'' + site + '\',' + i + ',1)" title="Move right">&rarr;</button>' : '')
                + '<button class="img-action-btn delete-btn" onclick="deleteImage(\'' + site + '\',\'' + img.id + '\')" title="Delete">DEL</button>'
                + '</div>'
                + '</div>';
        }).join('');
    }

    async function handleFileSelect(site, files) {
        if (!files || files.length === 0) return;
        const progressEl = document.getElementById('progress-' + site);
        const total = files.length;
        let uploaded = 0;

        for (const file of files) {
            progressEl.textContent = 'Uploading ' + (uploaded + 1) + ' of ' + total + '...';

            const formData = new FormData();
            formData.append('site', site);
            formData.append('file', file);

            try {
                const res = await fetch(WORKER_URL + '/images/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                    body: formData,
                });
                const data = await res.json();
                if (data.success) {
                    siteImages[site].push({
                        id: data.id,
                        name: file.name,
                        contentType: file.type,
                        size: file.size,
                    });
                    uploaded++;
                } else {
                    progressEl.textContent = 'Error: ' + (data.error || 'Upload failed');
                    break;
                }
            } catch (err) {
                progressEl.textContent = 'Upload failed — connection error';
                break;
            }
        }

        if (uploaded === total) {
            progressEl.textContent = uploaded + ' image(s) uploaded successfully';
            setTimeout(() => { progressEl.textContent = ''; }, 3000);
        }

        renderImages(site);
        // Reset file input
        document.getElementById('file-' + site).value = '';
    }

    async function deleteImage(site, id) {
        if (!confirm('Delete this image?')) return;
        try {
            await fetch(WORKER_URL + '/images/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ site, id }),
            });
            siteImages[site] = siteImages[site].filter(img => img.id !== id);
            renderImages(site);
        } catch (err) {}
    }

    async function moveImage(site, index, direction) {
        const images = siteImages[site];
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= images.length) return;

        // Swap
        [images[index], images[newIndex]] = [images[newIndex], images[index]];
        renderImages(site);

        // Save new order to server
        const order = images.map(img => img.id);
        try {
            await fetch(WORKER_URL + '/images/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ site, order }),
            });
        } catch (err) {}
    }

    // Drag & drop support
    ['samavas', 'chhaya'].forEach(site => {
        const zone = document.getElementById('upload-zone-' + site);
        if (!zone) return;

        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });
        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');
            handleFileSelect(site, e.dataTransfer.files);
        });
    });

    // --- UI helpers ---
    function showMsg(tab, text, type) {
        const el = document.getElementById(tab + '-msg');
        if (!el) return;
        el.textContent = text;
        el.className = 'save-msg show ' + type;
        setTimeout(() => el.classList.remove('show'), 3000);
    }

    // --- Main tab switching ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Update main tab buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Show/hide main panels
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-' + btn.dataset.tab).classList.add('active');

            // Show/hide sub-tabs bar for campsites
            const subTabs = document.getElementById('campsites-sub-tabs');
            if (btn.dataset.tab === 'campsites') {
                subTabs.classList.add('show');
            } else {
                subTabs.classList.remove('show');
            }
        });
    });

    // --- Sub-tab switching (within Campsites) ---
    document.querySelectorAll('.sub-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Show/hide sub-panels
            document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('subpanel-' + btn.dataset.subtab).classList.add('active');
        });
    });

    // --- Init: auto-login if token exists ---
    if (authToken) {
        showDashboard();
    }
</script>
</body>
</html>
